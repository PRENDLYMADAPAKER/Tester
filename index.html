<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
  <style>
    body { font-family: 'Inter', sans-serif; margin:0; padding:0; background:#f9fafb; }
    header { background:#1e3a8a; color:white; padding:15px 20px; font-size:18px; font-weight:600; }
    main { padding:20px; }
    h2 { margin:0 0 10px 0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border:1px solid #ddd; padding:8px; font-size:14px; }
    th { background:#f3f4f6; }
    tr:nth-child(even){background:#fafafa;}
    button { padding:6px 12px; margin:2px; font-size:14px; cursor:pointer; border:1px solid #ccc; background:white; border-radius:4px; }
    button:hover { background:#f3f4f6; }
    .muted { color:#6b7280; font-size:13px; }
    .success { color:green; }
    .error { color:red; }
    .row { display:flex; gap:6px; flex-wrap:wrap; }
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.5); justify-content:center; align-items:center; }
    .modal-content { background:white; padding:20px; border-radius:8px; width:90%; max-width:900px; max-height:90%; overflow:auto; position:relative; }
    .closeBtn { position:absolute; right:10px; top:10px; cursor:pointer; background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; }
    .wheel-container { text-align:center; margin-top:10px; }
    canvas { border:1px solid #ccc; border-radius:50%; }
  </style>
</head>
<body>
<header>Admin Panel</header>
<main>
  <!-- Attendance Scanner -->
  <h2>Attendance Scanner</h2>
  <div class="row">
    <button onclick="startScanner()">Start Scanner</button>
    <button onclick="stopScanner()">Stop Scanner</button>
  </div>
  <video id="preview" width="300" height="200" style="margin-top:10px; border:1px solid #ccc;"></video>
  <p id="scanStatus" class="muted">Scanner idle.</p>
  <div id="scanResult" style="display:none; margin-top:10px; border:1px solid #ccc; padding:10px;">
    <h3>Scan Result</h3>
    <p><b>Name:</b> <span id="resName"></span></p>
    <p><b>Clinical Level:</b> <span id="resLevel"></span></p>
    <p><b>Email:</b> <span id="resEmail"></span></p>
    <p><b>Time In:</b> <span id="resTime"></span></p>
  </div>

  <!-- Attendance Logs -->
  <hr>
  <h2>Attendance Logs (Today)</h2>
  <div class="row">
    <button onclick="exportLogs()">Export CSV</button>
    <button onclick="printLogs()">Print</button>
    <button onclick="resetLogs()">Archive & Clear</button>
    <button onclick="deleteToday()">Delete Today</button>
  </div>
  <table>
    <thead><tr><th>User</th><th>Date</th><th>Time In</th></tr></thead>
    <tbody id="logsBody"><tr><td colspan="3" class="muted">No logs yet</td></tr></tbody>
  </table>

  <!-- Requests -->
  <hr>
  <h2>Requests</h2>
  <button id="openRequests">View Requests</button>
  <button id="openBasket">View Basket</button>

  <!-- Case Management -->
  <hr>
  <h2>Case Management</h2>
  <button id="openCases">Open Cases</button>
  </main>
  <!-- Requests Modal -->
<div id="requestsModal" class="modal">
  <div class="modal-content">
    <button class="closeBtn" id="closeRequests">✖</button>
    <h2>Requests</h2>
    <select id="filterSelect">
      <option value="all">All</option>
      <option value="pending">Pending</option>
      <option value="approved">Approved</option>
      <option value="rejected">Rejected</option>
    </select>
    <table>
      <thead><tr><th>User</th><th>Field</th><th>New Value</th><th>Current Value</th><th>Status</th><th>Action</th></tr></thead>
      <tbody id="requestsBody"><tr><td colspan="6" class="muted">No requests</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Basket Modal -->
<div id="basketModal" class="modal">
  <div class="modal-content">
    <button class="closeBtn" id="closeBasket">✖</button>
    <h2>Basket</h2>
    <div class="row">
      <button onclick="showBasket('approved')">Approved</button>
      <button onclick="showBasket('rejected')">Rejected</button>
    </div>
    <table>
      <thead><tr><th>User</th><th>Field</th><th>New Value</th><th>Old Value</th><th>Status</th><th>Date</th></tr></thead>
      <tbody id="basketBody"><tr><td colspan="6" class="muted">Empty</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Case Management Modal -->
<div id="casesModal" class="modal">
  <div class="modal-content">
    <button class="closeBtn" id="closeCases">✖</button>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Case Management</h2>
      <div class="row">
        <button onclick="exportCases()">Export CSV</button>
        <button onclick="printCases()">Print</button>
        <button onclick="openArchivedCases()">View History</button>
        <button onclick="resetCases()" style="background:#ef4444;color:white;">Reset Cases</button>
      </div>
    </div>
    <table>
      <thead><tr><th>User</th><th>Case Type</th><th>Details</th><th>Date</th><th>Instructor</th><th>Action</th></tr></thead>
      <tbody id="casesBody"><tr><td colspan="6" class="muted">No cases submitted yet</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Archived Cases Modal -->
<div id="archivedCasesModal" class="modal">
  <div class="modal-content">
    <button class="closeBtn" id="closeArchivedCases">✖</button>
    <h2>Archived Cases</h2>
    <div id="archivedCasesList"><p class="muted">Loading archived cases...</p></div>
  </div>
</div>

<!-- Wheel Modal -->
<div id="wheelModal" class="modal">
  <div class="modal-content">
    <button class="closeBtn" id="closeWheel">✖</button>
    <h2>Assign Instructor (Spin Wheel)</h2>
    <input type="text" id="instructorInput" placeholder="Enter instructor names, comma separated" style="width:100%;margin-bottom:10px;">
    <button onclick="spinWheel()">Spin</button>
    <div class="wheel-container">
      <canvas id="wheelCanvas" width="300" height="300"></canvas>
      <p id="wheelResult" style="font-weight:bold;margin-top:10px;"></p>
    </div>
  </div>
</div>
<!-- Libraries -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<script>
/* ===============================
   Firebase Init
   =============================== */
const firebaseConfig = {
  apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
  authDomain: "dtr-project-66048.firebaseapp.com",
  databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dtr-project-66048",
  storageBucket: "dtr-project-66048.appspot.com",
  messagingSenderId: "271445506225",
  appId: "1:271445506225:web:fcb04d0454e1302de14a90",
  measurementId: "G-R22CLKSPCP"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Helpers */
function $(id){ return document.getElementById(id); }
function playSound(){ try { $("success-sound").play().catch(()=>{});} catch(e){} }
function formatDate(ts){ return new Date(ts).toLocaleString(); }

/* ===============================
   QR Scanner
   =============================== */
let codeReader, selectedDeviceId;

async function startScanner(){
  if(codeReader) stopScanner();
  codeReader = new ZXing.BrowserMultiFormatReader();
  const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
  selectedDeviceId = devices[0].deviceId;
  codeReader.decodeFromVideoDevice(selectedDeviceId, "preview", (result,err)=>{
    if(result){
      $("scanStatus").textContent = "Scanned: " + result.text;
      handleScan(result.text);
    }
  });
}

function stopScanner(){
  if(codeReader){
    codeReader.reset();
    codeReader = null;
    $("scanStatus").textContent = "Scanner stopped.";
  }
}

function handleScan(uid){
  db.ref("users/"+uid).once("value").then(snap=>{
    if(!snap.exists()){ alert("Unknown UID: "+uid); return; }
    const user = snap.val();
    const now = Date.now();
    const date = new Date().toISOString().split("T")[0];
    const logRef = db.ref("attendance/"+date+"/"+uid).push();
    logRef.set({ name:user.name,email:user.email,level:user.level,timestamp:now });
    $("scanResult").style.display="block";
    $("resName").textContent=user.name;
    $("resEmail").textContent=user.email;
    $("resLevel").textContent=user.level;
    $("resTime").textContent=formatDate(now);
    playSound();
    loadLogs();
  });
}

/* ===============================
   Attendance Logs
   =============================== */
function loadLogs(){
  const today = new Date().toISOString().split("T")[0];
  db.ref("attendance/"+today).once("value").then(snap=>{
    let html="";
    if(!snap.exists()){ html="<tr><td colspan=3 class=muted>No logs</td></tr>"; }
    else{
      snap.forEach(u=>{
        u.forEach(l=>{
          const v=l.val();
          html+=`<tr><td>${v.name}</td><td>${today}</td><td>${formatDate(v.timestamp)}</td></tr>`;
        });
      });
    }
    $("logsBody").innerHTML=html;
  });
}
loadLogs();

function exportLogs(){
  const rows=[["User","Date","Time In"]];
  const today=new Date().toISOString().split("T")[0];
  db.ref("attendance/"+today).once("value").then(snap=>{
    if(snap.exists()){
      snap.forEach(u=>{
        u.forEach(l=>{
          const v=l.val();
          rows.push([v.name,today,formatDate(v.timestamp)]);
        });
      });
      let csv=rows.map(r=>r.join(",")).join("\n");
      let blob=new Blob([csv],{type:"text/csv"});
      let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="logs.csv"; a.click();
    }
  });
}

function printLogs(){
  let win=window.open("","Print","width=800,height=600");
  win.document.write("<h3>Attendance Logs</h3>"+$("logsBody").parentNode.outerHTML);
  win.print(); win.close();
}

function resetLogs(){
  const today=new Date().toISOString().split("T")[0];
  db.ref("attendance/"+today).once("value").then(snap=>{
    if(!snap.exists()){alert("No logs");return;}
    const updates={};
    snap.forEach(u=>{
      u.forEach(l=>{
        updates[`archive/attendance/${today}/${u.key}/${l.key}`]=l.val();
      });
    });
    db.ref().update(updates).then(()=>{
      db.ref("attendance/"+today).remove().then(()=>loadLogs());
    });
  });
}
function deleteToday(){
  const today=new Date().toISOString().split("T")[0];
  db.ref("attendance/"+today).remove().then(()=>loadLogs());
}

/* ===============================
   Requests & Basket
   =============================== */
const requestsModal=$("requestsModal"), closeRequests=$("closeRequests");
$("openRequests").onclick=()=>{requestsModal.style.display="flex";loadRequests();}
closeRequests.onclick=()=>requestsModal.style.display="none";

function loadRequests(){
  db.ref("requests").once("value").then(snap=>{
    let html="";
    if(!snap.exists()){ html="<tr><td colspan=6 class=muted>No requests</td></tr>"; }
    else{
      snap.forEach(u=>{
        u.forEach(r=>{
          const v=r.val();
          html+=`<tr>
            <td>${v.name||u.key}</td>
            <td>${v.field}</td>
            <td>${v.newValue}</td>
            <td>${v.oldValue||""}</td>
            <td>${v.status||"pending"}</td>
            <td>
              <button onclick="approveReq('${u.key}','${r.key}')">Approve</button>
              <button onclick="rejectReq('${u.key}','${r.key}')">Reject</button>
            </td>
          </tr>`;
        });
      });
    }
    $("requestsBody").innerHTML=html;
  });
}
function approveReq(uid,rid){
  db.ref("requests/"+uid+"/"+rid).once("value").then(snap=>{
    if(!snap.exists())return;const v=snap.val();
    db.ref("users/"+uid+"/"+v.field).set(v.newValue);
    db.ref("basket/"+uid+"/"+rid).set({...v,status:"approved",date:Date.now()});
    snap.ref.remove();loadRequests();
  });
}
function rejectReq(uid,rid){
  db.ref("requests/"+uid+"/"+rid).once("value").then(snap=>{
    if(!snap.exists())return;const v=snap.val();
    db.ref("basket/"+uid+"/"+rid).set({...v,status:"rejected",date:Date.now()});
    snap.ref.remove();loadRequests();
  });
}

const basketModal=$("basketModal"), closeBasket=$("closeBasket");
$("openBasket").onclick=()=>{basketModal.style.display="flex";showBasket("approved");}
closeBasket.onclick=()=>basketModal.style.display="none";

function showBasket(type){
  db.ref("basket").once("value").then(snap=>{
    let html="";
    if(!snap.exists()){html="<tr><td colspan=6 class=muted>Empty</td></tr>";}
    else{
      snap.forEach(u=>{
        u.forEach(r=>{
          const v=r.val();
          if(v.status===type){
            html+=`<tr>
              <td>${v.name||u.key}</td>
              <td>${v.field}</td>
              <td>${v.newValue}</td>
              <td>${v.oldValue||""}</td>
              <td>${v.status}</td>
              <td>${formatDate(v.date)}</td>
            </tr>`;
          }
        });
      });
    }
    $("basketBody").innerHTML=html;
  });
}

/* ===============================
   Case Management
   =============================== */
const casesModal=$("casesModal"), closeCases=$("closeCases");
$("openCases").onclick=()=>{casesModal.style.display="flex";loadCases();}
closeCases.onclick=()=>casesModal.style.display="none";

function loadCases(){
  db.ref("cases").once("value").then(snap=>{
    let html="";
    if(!snap.exists()){html="<tr><td colspan=6 class=muted>No cases</td></tr>";}
    else{
      snap.forEach(u=>{
        u.forEach(c=>{
          const v=c.val();
          html+=`<tr>
            <td>${v.realName||v.uid||u.key}</td>
            <td>${v.type||""}</td>
            <td>${(v.details||"").replace(/\n/g," ")}</td>
            <td>${formatDate(v.timestamp)}</td>
            <td>${v.instructor||"—"}</td>
            <td><button onclick="openWheel('${u.key}','${c.key}')">Assign</button></td>
          </tr>`;
        });
      });
    }
    $("casesBody").innerHTML=html;
  });
}

function exportCases(){
  const rows=[["User","Case Type","Details","Date","Instructor"]];
  db.ref("cases").once("value").then(snap=>{
    if(snap.exists()){
      snap.forEach(u=>{
        u.forEach(c=>{
          const v=c.val();
          rows.push([v.realName||v.uid||u.key,v.type,(v.details||"").replace(/\n/g," "),formatDate(v.timestamp),v.instructor||""]);
        });
      });
      let csv=rows.map(r=>r.join(",")).join("\n");
      let blob=new Blob([csv],{type:"text/csv"});
      let a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="cases.csv";a.click();
    }
  });
}

function printCases(){
  const rows=document.querySelectorAll("#casesBody tr");
  let table="<table border=1><tr><th>User</th><th>Case Type</th><th>Details</th><th>Date</th><th>Instructor</th></tr>";
  rows.forEach(r=>{
    const cols=r.querySelectorAll("td"); if(cols.length>=5){
      table+=`<tr><td>${cols[0].innerText}</td><td>${cols[1].innerText}</td><td>${cols[2].innerText}</td><td>${cols[3].innerText}</td><td>${cols[4].innerText}</td></tr>`;
    }
  });
  table+="</table>";
  let w=window.open("","Print","width=800,height=600"); w.document.write("<h3>Cases</h3>"+table); w.print(); w.close();
}

function resetCases(){
  if(!confirm("Archive & clear all cases?"))return;
  const today=new Date().toISOString().split("T")[0];
  db.ref("cases").once("value").then(snap=>{
    if(!snap.exists()){alert("No cases");return;}
    const updates={};
    snap.forEach(u=>{
      u.forEach(c=>{
        const v=c.val();
        updates[`archive/cases/${today}/${u.key}/${c.key}`]={...v,archivedAt:Date.now()};
      });
    });
    db.ref().update(updates).then(()=>{
      db.ref("cases").remove().then(()=>loadCases());
    });
  });
}

/* Archived Cases */
const archivedCasesModal=$("archivedCasesModal"), closeArchivedCases=$("closeArchivedCases");
closeArchivedCases.onclick=()=>archivedCasesModal.style.display="none";
function openArchivedCases(){ archivedCasesModal.style.display="flex"; loadArchivedCases(); }
function loadArchivedCases(){
  $("archivedCasesList").innerHTML="<p class=muted>Loading...</p>";
  db.ref("archive/cases").once("value").then(snap=>{
    if(!snap.exists()){ $("archivedCasesList").innerHTML="<p class=muted>No archived cases</p>"; return; }
    let html="";
    snap.forEach(dateSnap=>{
      const date=dateSnap.key;
      html+=`<h3>${date}</h3><table border=1><tr><th>User</th><th>Case Type</th><th>Details</th><th>Date</th><th>Instructor</th><th>Status</th></tr>`;
      dateSnap.forEach(u=>{
        u.forEach(c=>{
          const v=c.val();
          html+=`<tr><td>${v.realName||v.uid||u.key}</td><td>${v.type||""}</td><td>${(v.details||"").replace(/\n/g," ")}</td><td>${formatDate(v.timestamp)}</td><td>${v.instructor||""}</td><td>archived</td></tr>`;
        });
      });
      html+="</table>";
    });
    $("archivedCasesList").innerHTML=html;
  });
}

/* ===============================
   Spin Wheel
   =============================== */
let currentCase={};
const wheelModal=$("wheelModal"), closeWheel=$("closeWheel");
closeWheel.onclick=()=>wheelModal.style.display="none";

function openWheel(uid,cid){ currentCase={uid,cid}; wheelModal.style.display="flex"; drawWheel([]); $("wheelResult").textContent=""; $("instructorInput").value=""; }

function drawWheel(names,highlight){
  const canvas=$("wheelCanvas"),ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);
  if(!names.length){ctx.fillStyle="#ddd";ctx.beginPath();ctx.arc(w/2,h/2,w/2,0,2*Math.PI);ctx.fill();ctx.fillStyle="#000";ctx.fillText("No names",w/2-30,h/2);return;}
  const angle=2*Math.PI/names.length;
  names.forEach((n,i)=>{
    ctx.beginPath();
    ctx.moveTo(w/2,h/2);
    ctx.fillStyle=i===highlight?"#f87171":`hsl(${i*360/names.length},70%,60%)`;
    ctx.arc(w/2,h/2,w/2,i*angle,(i+1)*angle);
    ctx.fill();
    ctx.save();ctx.translate(w/2,h/2);ctx.rotate(i*angle+angle/2);
    ctx.fillStyle="#000";ctx.textAlign="right";ctx.font="14px sans-serif";ctx.fillText(n,w/2-10,5);
    ctx.restore();
  });
}

function spinWheel(){
  const names=$("instructorInput").value.split(",").map(s=>s.trim()).filter(s=>s);
  if(!names.length){alert("Enter names");return;}
  let index=Math.floor(Math.random()*names.length);
  drawWheel(names,index);
  const picked=names[index]; $("wheelResult").textContent="Chosen: "+picked;
  if(currentCase.uid&&currentCase.cid){
    db.ref("cases/"+currentCase.uid+"/"+currentCase.cid+"/instructor").set(picked).then(()=>loadCases());
  }
}
</script>

<audio id="success-sound" src="Thank you.mp3" preload="auto"></audio>
</body>
</html>
