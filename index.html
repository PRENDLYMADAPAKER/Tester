<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel - Clinician DTR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
  body {
    font-family: Inter, system-ui, Arial, sans-serif;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    display: flex;
    justify-content: center;
    padding: 20px;
    min-height: 100vh;
  }

  .card {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 20px;
    border-radius: 16px;
    width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    margin-bottom: 20px;
  }

  h1, h2 { margin-top: 0; color: #2c0a34; }

  button {
    padding: 6px 12px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s ease;
  }
  button:hover { opacity: 0.9; transform: scale(1.03); }

  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  th, td { padding: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.3); font-size: 14px; text-align: center; }

  .row { display: flex; gap: 8px; }
  .muted { font-size: 13px; opacity: 0.8; }
  .error { color: #b91c1c; }
  .success { color: #166534; }

  #dashboard { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 1300px; }
  .dashboard-left { flex: 0 0 400px; }
  .dashboard-right { flex: 1; }
  #preview { width: 100%; max-width: 380px; border-radius: 8px; background: #000; }

  @media (min-width: 1024px) {
    #dashboard { flex-direction: row; align-items: flex-start; }
  }
  @media (max-width: 768px) {
    .row { flex-direction: column; }
    table { display: block; overflow-x: auto; white-space: nowrap; }
    button { width: 100%; }
  }

  /* Modal */
  .modal {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }
  .modal .modal-content {
    background: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 12px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow: auto;
  }
  .modal .closeBtn {
    float: right;
    background: #ef4444;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
  }

  /* Spin Wheel */
  #wheelCanvas { width: 300px; height: 300px; border-radius: 50%; border: 4px solid #333; }
  #wheelResult { font-weight: bold; margin-top: 10px; }
  .tabs { margin: 10px 0; display:flex; gap:10px; }
  </style>
</head>
<body>
  <div id="dashboard">
    <!-- Left side: Scanner -->
    <div class="dashboard-left">
      <div class="card">
        <h2>QR Scanner</h2>
        <div class="row" style="margin-bottom:10px">
          <button onclick="startScanner()">Start Scanner</button>
          <button onclick="stopScanner()" style="background:#ef4444;color:white;">Stop Scanner</button>
        </div>
        <video id="preview"></video>
        <p id="scanStatus" class="muted"></p>
      </div>
    </div>

    <!-- Right side -->
    <div class="dashboard-right">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h1>Admin Panel - Clinician DTR</h1>
          <div class="row">
            <button id="openRequests">‚öôÔ∏è Update Requests</button>
            <button id="openBasket">üóÇ Basket</button>
            <button id="openCases">üìã Case Management</button>
          </div>
        </div>
  </div>
  <!-- Last Scan Result -->
      <div class="card" id="scanResult" style="display:none;">
        <h3>Last Scan Result</h3>
        <p><strong>Name:</strong> <span id="resName">-</span></p>
        <p><strong>Clinical Level:</strong> <span id="resLevel">-</span></p>
        <p><strong>Email:</strong> <span id="resEmail">-</span></p>
        <p><strong>Time In:</strong> <span id="resTime">-</span></p>
      </div>

      <!-- Attendance Logs -->
      <div class="card" id="logsSection">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Attendance Logs (Today)</h2>
          <div class="row">
            <button onclick="exportLogs()">Export</button>
            <button onclick="printLogs()">Print</button>
            <button onclick="resetLogs()">Clear Logs View</button>
            <button onclick="deleteToday()" style="background:#ef4444;color:white;">Delete Today‚Äôs Records</button>
          </div>
        </div>
        <table>
          <thead><tr><th>User</th><th>Date</th><th>Time In</th></tr></thead>
          <tbody id="logsBody"><tr><td colspan="3" class="muted">No logs today</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Requests Modal -->
  <div id="requestsModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" id="closeRequests">‚úñ</button>
      <h2>Update Requests</h2>
      <label class="muted">Filter: 
        <select id="filterSelect">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </label>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Requested Value</th><th>Current Value</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="requestsBody"><tr><td colspan="6" class="muted">No requests yet</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Basket Modal -->
  <div id="basketModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" id="closeBasket">‚úñ</button>
      <h2>Basket (Archived Requests)</h2>
      <div class="tabs">
        <button onclick="showBasket('approved')">‚úÖ Approved</button>
        <button onclick="showBasket('rejected')">‚ùå Rejected</button>
      </div>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Requested</th><th>Current</th><th>Status</th><th>Date</th></tr></thead>
        <tbody id="basketBody"><tr><td colspan="6" class="muted">Select Approved or Rejected</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Case Management Modal -->
  <div id="casesModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" id="closeCases">‚úñ</button>
      <h2>Case Management</h2>
      <table>
        <thead><tr><th>User</th><th>Case Type</th><th>Details</th><th>Date</th><th>Instructor</th><th>Action</th></tr></thead>
        <tbody id="casesBody"><tr><td colspan="6" class="muted">No cases submitted yet</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Spin Wheel Modal -->
  <div id="wheelModal" class="modal">
    <div class="modal-content" style="text-align:center;">
      <button class="closeBtn" id="closeWheel">‚úñ</button>
      <h2>Spin Wheel - Assign Instructor</h2>
      <p class="muted">Type instructors separated by commas:</p>
      <input type="text" id="instructorInput" placeholder="Dr. Cruz, Dr. Santos, Dr. Lopez" style="width:100%;padding:8px;margin-bottom:10px;"/>
      <canvas id="wheelCanvas" width="300" height="300"></canvas>
      <br>
      <button onclick="spinWheel()">üé° Spin</button>
      <p id="wheelResult"></p>
    </div>
  </div>
  <!-- libs -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
    // ---------- Firebase config (same as before) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
      authDomain: "dtr-project-66048.firebaseapp.com",
      databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dtr-project-66048",
      storageBucket: "dtr-project-66048.appspot.com",
      messagingSenderId: "271445506225",
      appId: "1:271445506225:web:fcb04d0454e1302de14a90",
      measurementId: "G-R22CLKSPCP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- Success Sound helper ----------
    function playSound(id) {
      try { const a = document.getElementById(id); if (a) a.play().catch(()=>{}); } catch(e){ console.warn('sound error', e); }
    }

    // ========== QR Scanner (ZXing) ==========
    const codeReader = new ZXing.BrowserQRCodeReader();
    const preview = document.getElementById('preview');
    const scanStatus = document.getElementById('scanStatus');

    async function startScanner() {
      try {
        const devices = await codeReader.listVideoInputDevices();
        if (devices.length > 0) {
          const back = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
          codeReader.decodeFromVideoDevice(back.deviceId, preview, (result, err) => {
            if (result && result.getText) handleScan(result.getText());
          });
          scanStatus.textContent = "Scanner started. Point camera at QR code.";
          scanStatus.className = "muted";
        } else {
          scanStatus.textContent = "No camera devices found.";
          scanStatus.className = "error";
        }
      } catch (err) {
        scanStatus.textContent = "Camera error: " + err.message;
        scanStatus.className = "error";
      }
    }

    function stopScanner() {
      try { codeReader.reset(); } catch(e){}
      preview.srcObject = null;
      scanStatus.textContent = "Scanner stopped.";
      scanStatus.className = "muted";
    }

    async function handleScan(uid) {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const timeStr = now.toTimeString().split(' ')[0];
      const dtrRef = db.ref('users/' + uid + '/dtr/' + dateStr);
      const snapshot = await dtrRef.once('value');

      if (snapshot.exists() && snapshot.val().timeIn) {
        const existingTime = snapshot.val().timeIn;
        const profileSnap = await db.ref('users/' + uid + '/profile').once('value');
        const profile = profileSnap.val() || {};
        document.getElementById('resName').textContent = profile.name || uid;
        document.getElementById('resLevel').textContent = profile.clinicalLevel || '-';
        document.getElementById('resEmail').textContent = profile.email || '-';
        document.getElementById('resTime').textContent = existingTime;
        document.getElementById('scanResult').style.display = 'block';
        scanStatus.textContent = (profile.name || uid) + " already Time-In today at " + existingTime;
        scanStatus.className = "error";
        return;
      }

      await dtrRef.set({ timeIn: timeStr });
      const profileSnap = await db.ref('users/' + uid + '/profile').once('value');
      const profile = profileSnap.val() || {};
      document.getElementById('resName').textContent = profile.name || uid;
      document.getElementById('resLevel').textContent = profile.clinicalLevel || '-';
      document.getElementById('resEmail').textContent = profile.email || '-';
      document.getElementById('resTime').textContent = timeStr;
      document.getElementById('scanResult').style.display = 'block';
      scanStatus.textContent = "Recorded for " + (profile.name || uid) + " at " + timeStr;
      scanStatus.className = "success";
      playSound('success-sound'); // only QR scans play sound
      // refresh today's logs view
      loadTodayLogs();
    }

    // ========== Attendance Logs (Today) ==========
    const logsBody = document.getElementById('logsBody');
    let todayLogs = [];

    function loadTodayLogs() {
      logsBody.innerHTML = '';
      todayLogs = [];
      const today = new Date().toISOString().split('T')[0];

      db.ref('adminClearedLogs/'+today).once('value').then(flagSnap => {
        if (flagSnap.exists()) {
          logsBody.innerHTML = '<tr><td colspan="3" class="muted">No logs today</td></tr>';
          return;
        }

        db.ref('users').once('value').then(snap => {
          let hasLogs = false;
          snap.forEach(userSnap => {
            const profile = userSnap.child('profile').val();
            const name = profile?.name || userSnap.key;
            const dtr = userSnap.child('dtr').val() || {};
            if (dtr[today]) {
              hasLogs = true;
              const timeIn = dtr[today].timeIn;
              todayLogs.push({ name, date: today, timeIn });
              logsBody.innerHTML += `<tr><td>${name}</td><td>${today}</td><td>${timeIn}</td></tr>`;
            }
          });
          if (!hasLogs) logsBody.innerHTML = '<tr><td colspan="3" class="muted">No logs today</td></tr>';
        });
      });
    }
    // initial load
    loadTodayLogs();

    function exportLogs() {
      if (todayLogs.length === 0) return alert("No logs to export.");
      let csv = "Name,Date,Time In\n";
      todayLogs.forEach(l => { csv += `${l.name},${l.date},${l.timeIn}\n`; });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "attendance_logs_today.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    function printLogs() {
      if (todayLogs.length === 0) {
        alert("No logs to print.");
        return;
      }

      let rowsPerPage = 40;
      let pages = [];

      for (let i = 0; i < todayLogs.length; i += rowsPerPage) {
        let chunk = todayLogs.slice(i, i + rowsPerPage);
        pages.push(`
          <table>
            <thead>
              <tr><th>User</th><th>Date</th><th>Time In</th></tr>
            </thead>
            <tbody>
              ${chunk.map(l => `
                <tr>
                  <td>${l.name}</td>
                  <td>${l.date}</td>
                  <td>${l.timeIn}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        `);
      }

      let html = `
        <html>
        <head>
          <title>Attendance Logs (Today)</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h2 { text-align: center; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
            th, td { border: 1px solid #333; padding: 8px 12px; text-align: center; font-size: 14px; }
            th { background: #f3f3f3; }
            tr:nth-child(even) { background: #fafafa; }
            .page-break { page-break-after: always; }
          </style>
        </head>
        <body>
          <h2>Attendance Logs (Today)</h2>
          ${pages.map((p, i) => `<div class="page-break">${p}</div>`).join('')}
        </body>
        </html>
      `;

      let win = window.open("", "_blank");
      win.document.write(html);
      win.document.close();
      win.print();
    }

    function resetLogs() {
      if (!confirm("Archive today‚Äôs logs and clear them from admin view? (Users will still see their Time In)")) return;
      const today = new Date().toISOString().split('T')[0];

      db.ref('users').once('value').then(snap => {
        snap.forEach(userSnap => {
          const uid = userSnap.key;
          const profile = userSnap.child('profile').val() || {};
          const dtr = userSnap.child('dtr/'+today).val();
          if (dtr && dtr.timeIn) {
            db.ref('archive/'+today+'/'+uid).set({
              name: profile.name || uid,
              email: profile.email || '',
              timeIn: dtr.timeIn,
              ts: Date.now()
            });
          }
        });
        db.ref('adminClearedLogs/'+today).set(true);
        alert("‚úÖ Today‚Äôs logs archived and cleared from admin view. User panel not affected.");
        loadTodayLogs();
      });
    }

    function deleteToday() {
      if (!confirm("‚ö†Ô∏è WARNING: This will permanently delete today‚Äôs Time In records for ALL users (Admin + User). Continue?")) return;
      const today = new Date().toISOString().split('T')[0];
      db.ref('users').once('value').then(snap => {
        snap.forEach(userSnap => {
          db.ref(`users/${userSnap.key}/dtr/${today}`).remove();
        });
        db.ref('adminClearedLogs/'+today).remove();
        alert("‚úÖ Today‚Äôs records have been deleted.");
        loadTodayLogs();
      });
    }

    // ========== Requests Modal (approve/reject) ==========
    const requestsModal=document.getElementById('requestsModal');
    document.getElementById('openRequests').onclick=()=>{requestsModal.style.display='flex';};
    document.getElementById('closeRequests').onclick=()=>{requestsModal.style.display='none';};
    window.onclick=e=>{
      if(e.target===requestsModal) requestsModal.style.display='none';
      if(e.target===document.getElementById('basketModal')) document.getElementById('basketModal').style.display='none';
      if(e.target===document.getElementById('casesModal')) document.getElementById('casesModal').style.display='none';
      if(e.target===document.getElementById('wheelModal')) document.getElementById('wheelModal').style.display='none';
    };

    const requestsBody=document.getElementById('requestsBody');
    const filterSelect=document.getElementById('filterSelect');

    function renderRequests(snap,filter){
      requestsBody.innerHTML='';
      if(!snap.exists()){ requestsBody.innerHTML='<tr><td colspan="6" class="muted">No requests yet</td></tr>'; return;}
      let has=false;
      snap.forEach(userSnap=>{
        const uid=userSnap.key;
        userSnap.forEach(reqSnap=>{
          const req=reqSnap.val(), reqId=reqSnap.key;
          if(filter!=="all" && req.status!==filter) return;
          has=true;
          db.ref('users/'+uid+'/profile').once('value').then(profileSnap=>{
            const profile=profileSnap.val()||{};
            const currentVal=req.field==="password"?"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢":(profile[req.field]||"");
            const row=document.createElement('tr');
            row.innerHTML=`
              <td>${profile.name||uid}<br><span class="muted">${profile.email||''}</span></td>
              <td>${req.field}</td>
              <td>${req.value}</td>
              <td>${currentVal}</td>
              <td>${req.status}</td>
              <td>
                <button onclick="approveReq('${uid}','${reqId}','${req.field}','${req.value}')">Approve</button>
                <button onclick="rejectReq('${uid}','${reqId}')">Reject</button>
              </td>`;
            requestsBody.appendChild(row);
          });
        });
      });
      if(!has) requestsBody.innerHTML='<tr><td colspan="6" class="muted">No matching requests</td></tr>';
    }

    db.ref('updateRequests').on('value',snap=>renderRequests(snap,filterSelect.value));
    filterSelect.onchange=()=>db.ref('updateRequests').once('value').then(snap=>renderRequests(snap,filterSelect.value));

    async function approveReq(uid,reqId,field,value){
      const allowed = ["name","email","clinicalLevel"]; // only safe fields
      if(allowed.includes(field)){
        await db.ref('users/'+uid+'/profile/'+field).set(value);
      }
      const [reqSnap, profileSnap] = await Promise.all([
        db.ref('updateRequests/'+uid+'/'+reqId).once('value'),
        db.ref('users/'+uid+'/profile').once('value')
      ]);
      const reqData=reqSnap.val()||{};
      const profile=profileSnap.val()||{};
      await db.ref('basket/approved/'+reqId).set({
        ...reqData,
        uid,
        name: profile.name || uid,
        email: profile.email || '',
        status:'approved',
        ts:Date.now()
      });
      await db.ref('updateRequests/'+uid+'/'+reqId).remove();
      // silent on approve; UI will update via listeners
    }

    async function rejectReq(uid,reqId){
      const [reqSnap, profileSnap] = await Promise.all([
        db.ref('updateRequests/'+uid+'/'+reqId).once('value'),
        db.ref('users/'+uid+'/profile').once('value')
      ]);
      const reqData=reqSnap.val()||{};
      const profile=profileSnap.val()||{};
      await db.ref('basket/rejected/'+reqId).set({
        ...reqData,
        uid,
        name: profile.name || uid,
        email: profile.email || '',
        status:'rejected',
        ts:Date.now()
      });
      await db.ref('updateRequests/'+uid+'/'+reqId).remove();
    }

    // ========== Basket Modal ==========
    const basketModal=document.getElementById('basketModal');
    const openBasket=document.getElementById('openBasket');
    const closeBasket=document.getElementById('closeBasket');
    const basketBody=document.getElementById('basketBody');
    let basketData={approved:{},rejected:{}};

    openBasket.onclick=()=>{basketModal.style.display='flex';};
    closeBasket.onclick=()=>{basketModal.style.display='none';};

    function renderBasket(type){
      const data=basketData[type]||{};
      if(!Object.keys(data).length){ 
        basketBody.innerHTML=`<tr><td colspan="6" class="muted">No ${type} requests</td></tr>`; 
        return; 
      }
      basketBody.innerHTML=Object.entries(data).map(([id,r])=>`
        <tr>
          <td>${r.name||'-'}<br><span class="muted">${r.email||''}</span></td>
          <td>${r.field||''}</td>
          <td>${r.value||''}</td>
          <td>${r.currentValue||''}</td>
          <td>${r.status||''}</td>
          <td>${new Date(r.ts).toLocaleString()}</td>
        </tr>`).join('');
    }
    function showBasket(type){ renderBasket(type); }
    db.ref('basket/approved').on('value',snap=>{basketData.approved=snap.exists()?snap.val():{};});
    db.ref('basket/rejected').on('value',snap=>{basketData.rejected=snap.exists()?snap.val():{};});

    // ========== Case Management ==========
    const casesModal = document.getElementById('casesModal');
    const casesBody = document.getElementById('casesBody');
    const openCasesBtn = document.getElementById('openCases');
    const closeCasesBtn = document.getElementById('closeCases');

    openCasesBtn.onclick = () => { casesModal.style.display = 'flex'; loadCases(); };
    closeCasesBtn.onclick = () => { casesModal.style.display = 'none'; };

    // selectedCase used by wheel assigner
    let selectedCase = null;

    // render cases from db.ref('cases')
    async function loadCases() {
      casesBody.innerHTML = '<tr><td colspan="6" class="muted">Loading...</td></tr>';
      const snap = await db.ref('cases').once('value');
      if (!snap.exists()) {
        casesBody.innerHTML = '<tr><td colspan="6" class="muted">No cases submitted yet</td></tr>';
        return;
      }
      let rows = '';
      snap.forEach(userSnap => {
        const uid = userSnap.key;
        userSnap.forEach(caseSnap => {
          const cId = caseSnap.key;
          const c = caseSnap.val();
          const date = c.timestamp ? new Date(c.timestamp).toLocaleString() : '‚Äî';
          const instructor = c.instructor || 'Pending';
          const userText = c.patientName ? `${c.patientName}` : (c.details ? c.details.split(',')[0] : uid);
          // build details string (safely)
          const details = (c.details || '').replace(/\n/g,' ');
          rows += `<tr>
            <td>${userText}<br><span class="muted">${uid}</span></td>
            <td>${c.type||'‚Äî'}</td>
            <td style="text-align:left">${details}</td>
            <td>${date}</td>
            <td id="instr-${uid.replaceAll('.','_')}-${cId}">${instructor}</td>
            <td>
              <button onclick="openWheelAssign('${uid}','${cId}')">Assign Instructor</button>
              <button onclick="markCaseComplete('${uid}','${cId}')">Mark Complete</button>
            </td>
          </tr>`;
        });
      });
      casesBody.innerHTML = rows || '<tr><td colspan="6" class="muted">No cases submitted yet</td></tr>';
    }

    function markCaseComplete(uid, cId) {
      if (!confirm("Mark this case as completed?")) return;
      db.ref(`cases/${uid}/${cId}/status`).set('completed').then(()=> loadCases());
    }

    // ---------- Spin Wheel modal wiring ----------
    const wheelModal = document.getElementById('wheelModal');
    const closeWheel = document.getElementById('closeWheel');
    const instructorInput = document.getElementById('instructorInput');
    const wheelResult = document.getElementById('wheelResult');
    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');

    closeWheel.onclick = () => { wheelModal.style.display = 'none'; stopSpinAnimation(); };

    // called when admin clicks Assign Instructor
    function openWheelAssign(uid, caseId) {
      selectedCase = { uid, caseId };
      instructorInput.value = ''; // admin types the names manually
      wheelResult.textContent = '';
      wheelModal.style.display = 'flex';
      // draw empty wheel placeholder
      drawWheel([]);
    }

    // ---------- Wheel drawing + spin logic ----------
    let wheel = { names: [], colors: [], angle: 0, spinning: false, spinAnimId: null, angularVelocity: 0 };
    function drawWheel(names) {
      // prepare colors
      const n = names.length || 1;
      const cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx,cy) - 4;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if (names.length === 0) {
        // placeholder circle
        ctx.beginPath();
        ctx.arc(cx,cy,r,0,Math.PI*2);
        ctx.fillStyle = "#f3f3f3";
        ctx.fill();
        ctx.fillStyle = "#333";
        ctx.textAlign = "center";
        ctx.font = "16px Arial";
        ctx.fillText("Enter names above", cx, cy);
        return;
      }

      const seg = 2*Math.PI / n;
      wheel.colors = [];
      for (let i=0;i<n;i++){
        const hue = Math.round((i/n)*360);
        wheel.colors.push(`hsl(${hue} 70% 65%)`);
      }

      for (let i=0;i<n;i++){
        const start = i*seg + wheel.angle;
        const end = start + seg;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,start,end);
        ctx.closePath();
        ctx.fillStyle = wheel.colors[i];
        ctx.fill();
        // text
        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(start + seg/2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#111";
        ctx.font = "14px Arial";
        ctx.fillText(names[i], r - 10, 6);
        ctx.restore();
      }

      // center circle
      ctx.beginPath();
      ctx.arc(cx,cy,40,0,Math.PI*2);
      ctx.fillStyle = "#fff";
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "#ddd";
      ctx.stroke();

      // pointer
      ctx.beginPath();
      ctx.moveTo(canvas.width - 10, cy - 12);
      ctx.lineTo(canvas.width - 2, cy);
      ctx.lineTo(canvas.width - 10, cy + 12);
      ctx.closePath();
      ctx.fillStyle = "#222";
      ctx.fill();
    }

    function spinWheel() {
      if (wheel.spinning) return;
      const raw = instructorInput.value.trim();
      if (!raw) { alert("Type instructor names separated by commas."); return; }
      const names = raw.split(',').map(s => s.trim()).filter(s => s);
      if (names.length === 0) return alert("Please enter at least one name.");

      // init wheel
      wheel.names = names;
      wheel.angle = Math.random() * Math.PI*2; // random start
      drawWheel(wheel.names);

       // choose random end angle based on random index
      const n = names.length;
      // choose a random winning index
      const winningIndex = Math.floor(Math.random() * n);
      // compute angle of that segment center
      const seg = 2*Math.PI / n;
      // target angle = such that pointer (right-most) lands at the segment center
      // pointerAngle = 0 (right direction), so wheel.angle + target = center of chosen segment + k*2pi
      // we want to spin multiple turns too
      const targetCenter = (winningIndex * seg) + (seg / 2);
      const current = wheel.angle % (2*Math.PI);
      const fullSpins = 3 + Math.floor(Math.random()*3); // 3-5 full turns for drama
      // compute final angle so that (wheel.angle + delta) % 2pi == ( (2pi) - targetCenter ) 
      // because pointer is fixed at 0 (right) and wheel rotates clockwise visually by increasing angle.
      // To simplify: we'll animate angle to reach final = fullSpins*2pi + (2pi - targetCenter)
      const final = fullSpins * 2*Math.PI + (2*Math.PI - targetCenter);
      const start = wheel.angle;
      const delta = final - (start % (2*Math.PI));
      const duration = 4200 + Math.random()*1800; // ms

      const startTime = performance.now();
      wheel.spinning = true;
      wheel.angularVelocity = delta / duration;

      function animate(now){
        const t = Math.min(1, (now - startTime) / duration);
        // ease out cubic
        const ease = 1 - Math.pow(1 - t, 3);
        wheel.angle = start + delta * ease;
        drawWheel(wheel.names);

        if (t < 1) {
          wheel.spinAnimId = requestAnimationFrame(animate);
        } else {
          wheel.spinning = false;
          // determine winner index by mapping wheel.angle to segment
          const normalized = (wheel.angle % (2*Math.PI) + 2*Math.PI) % (2*Math.PI);
          // segment index whose center is closest to (2pi - normalized)
          const landed = (2*Math.PI - normalized);
          let idx = Math.floor(landed / seg);
          if (idx >= names.length) idx = idx % names.length;
          const winner = names[idx];
          wheelResult.textContent = `Selected: ${winner}`;
          // assign to firebase
          assignInstructorToCase(winner);
        }
      }
      wheel.spinAnimId = requestAnimationFrame(animate);
    }

    function stopSpinAnimation() {
      if (wheel.spinAnimId) cancelAnimationFrame(wheel.spinAnimId);
      wheel.spinning = false;
      wheel.spinAnimId = null;
    }

    // assign result to firebase for the selected case
    async function assignInstructorToCase(name) {
      if (!selectedCase) {
        alert("No case selected.");
        return;
      }
      const { uid, caseId } = selectedCase;
      // set instructor and status
      await db.ref(`cases/${uid}/${caseId}/instructor`).set(name);
      await db.ref(`cases/${uid}/${caseId}/status`).set('assigned');
      // update UI
      const safeId = `instr-${uid.replaceAll('.','_')}-${caseId}`;
      const instrEl = document.getElementById(safeId);
      if (instrEl) instrEl.textContent = name;
      // close wheel after short delay
      setTimeout(()=>{ wheelModal.style.display = 'none'; selectedCase = null; wheelResult.textContent = ''; }, 900);
    }

    // Listen for changes to cases to auto-refresh table
    db.ref('cases').on('value', snap => {
      // only refresh if casesModal open, else keep stale until open
      if (casesModal.style.display === 'flex') loadCases();
    });

    // ---------- End of JS ----------
  </script>

  <audio id="success-sound" src="Thank you.mp3" preload="auto"></audio>
</body>
</html>
