<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Face Verification DTR</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b1020; color:#fff; text-align:center; }
    video { border:2px solid #fff; border-radius:12px; margin:10px auto; display:block; }
    button { margin:10px; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-size:16px; }
    #status { margin-top:15px; font-weight:bold; }
  </style>
</head>
<body>
  <h2>Face Verification DTR</h2>

  <!-- Camera Preview -->
  <video id="video" width="320" height="240" autoplay muted playsinline></video>

  <!-- Input Fields -->
  <div>
    <input type="text" id="empId" placeholder="Employee ID" />
    <input type="text" id="empName" placeholder="Employee Name" />
  </div>

  <!-- Buttons -->
  <button onclick="registerUser()">📷 Register Face</button>
  <button onclick="verifyAndLog()">✅ Verify & Log Time</button>

  <div id="status">Loading models...</div>

  <!-- Face API.js -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // 🔹 Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDrGDzWbxELIySKHsA2It1zsg2VTSmLxPY",
      authDomain: "face-verification-b6fa7.firebaseapp.com",
      databaseURL: "https://face-verification-b6fa7-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "face-verification-b6fa7",
      storageBucket: "face-verification-b6fa7.firebasestorage.app",
      messagingSenderId: "388284521904",
      appId: "1:388284521904:web:8f82a6c5c87aca9966ca75",
      measurementId: "G-LM64YQ612M"
    };

    // 🔹 Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 🔹 Start Camera
    const video = document.getElementById("video");
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        video.srcObject = stream;
      } catch (err) {
        document.getElementById("status").innerText = "Camera error: " + err;
      }
    }
    startCamera();

    // 🔹 Load Face API models
    Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models"),
      faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models"),
      faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models")
    ]).then(() => {
      document.getElementById("status").innerText = "✅ Models loaded. Ready!";
    });

    // 🔹 Register Employee Face
    window.registerUser = async function() {
      const empId = document.getElementById("empId").value.trim();
      const empName = document.getElementById("empName").value.trim();
      if (!empId || !empName) {
        alert("Enter Employee ID & Name");
        return;
      }

      const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks().withFaceDescriptor();

      if (!detections) {
        document.getElementById("status").innerText = "❌ No face detected, try again!";
        return;
      }

      const embedding = Array.from(detections.descriptor);

      await setDoc(doc(db, "employees", empId), {
        name: empName,
        embedding: embedding
      });

      document.getElementById("status").innerText = `✅ Registered ${empName} (ID: ${empId})`;
    };

    // 🔹 Euclidean Distance
    function euclideanDistance(arr1, arr2) {
      return Math.sqrt(arr1.reduce((sum, val, i) => sum + Math.pow(val - arr2[i], 2), 0));
    }

    // 🔹 Verify & Log Time
    window.verifyAndLog = async function() {
      const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks().withFaceDescriptor();

      if (!detections) {
        document.getElementById("status").innerText = "❌ No face detected!";
        return;
      }

      const embedding = Array.from(detections.descriptor);
      const snapshot = await getDocs(collection(db, "employees"));

      let bestMatch = null, bestDistance = 1.0;
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const dist = euclideanDistance(embedding, data.embedding);
        if (dist < bestDistance) {
          bestDistance = dist;
          bestMatch = { id: docSnap.id, name: data.name };
        }
      });

      if (bestMatch && bestDistance < 0.4) { // threshold
        const logId = new Date().toISOString();
        await setDoc(doc(db, "logs", logId), {
          empId: bestMatch.id,
          name: bestMatch.name,
          action: "Time In/Out",
          timestamp: new Date().toLocaleString()
        });
        document.getElementById("status").innerText = `✅ Verified: ${bestMatch.name} (ID: ${bestMatch.id})`;
      } else {
        document.getElementById("status").innerText = "❌ Face not recognized!";
      }
    };
  </script>
</body>
</html>
