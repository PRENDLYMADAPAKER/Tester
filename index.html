<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guidance Appointment Scheduling</title>

  <!-- EmailJS library (global `emailjs`) -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#ffffff;
      --bg2:#ffe8f4;
      --bg3:#e8d6ff;
      --primary:#6c2bb9;
      --accent:#b565d9;
      --card-bg: rgba(255,255,255,0.88);
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#2a0a3a}
    body{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      padding:24px;
      background: linear-gradient(135deg,var(--bg1), var(--bg2), var(--bg3));
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* page column (Option A) */
    .page {
      width:100%;
      max-width:460px;
      display:flex;
      flex-direction:column;
      gap:20px;
      align-items:center;
    }

    /* Logo + Title */
    .logo {
      width:130px;
      height:130px;
      object-fit:contain;
      display:block;
      margin-top:6px;
    }
    .title {
      font-size:1.6rem;
      color:var(--primary);
      text-align:center;
      font-weight:700;
      margin-top:6px;
      line-height:1.05;
    }

    /* Card styles */
    .card {
      width:100%;
      background: var(--card-bg);
      border-radius:14px;
      padding:18px;
      box-shadow: 0 12px 38px rgba(30,0,50,0.06);
      border:1px solid rgba(0,0,0,0.04);
      backdrop-filter: blur(6px);
    }
    .card h2{ margin:0 0 12px 0; color:var(--primary); font-size:1.15rem; text-align:left }

    label{ font-weight:600; color:var(--primary); font-size:0.95rem; display:block; margin-bottom:6px }
    input[type="text"], input[type="email"], input[type="tel"], select, textarea {
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.06);
      background:white;
      font-size:14px;
      outline:none;
    }
    input[readonly] { background: #faf7ff; cursor:default; }
    textarea { min-height:80px; resize:none; }

    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }

    .btn {
      padding:11px 14px;
      border-radius:12px;
      border:none;
      background: linear-gradient(90deg,var(--accent),var(--primary));
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 8px 22px rgba(108,43,185,0.12);
    }
    .btn.ghost {
      background:transparent;
      color:var(--primary);
      border:1px solid rgba(0,0,0,0.06);
      box-shadow:none;
    }

    .muted { color:#6b6b6b; font-size:13px; text-align:center }

    /* Calendar card - keep compact (red box size) */
    .calendar {
      width:100%;
      max-width:420px;
      background: var(--card-bg);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 12px 38px rgba(30,0,50,0.06);
      border:1px solid rgba(0,0,0,0.04);
    }
    .cal-top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .cal-month { font-weight:700; color:var(--primary); font-size:1.05rem }
    .cal-nav { display:flex; gap:8px; }
    .cal-nav button { background:#fff;border:1px solid rgba(0,0,0,0.06); padding:8px 10px; border-radius:8px; cursor:pointer; }
    .cal-grid {
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:8px;
      align-items:stretch;
    }
    .cal-weeknames { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-bottom:6px; color:#6b4b7e; font-size:13px; text-align:center }
    .cal-weeknames div{opacity:0.9}
    .day-tile {
      height:46px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:10px;
      background: rgba(255,255,255,0.96);
      color:var(--primary);
      font-weight:700;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      box-shadow: 0 6px 18px rgba(30,0,50,0.04);
    }
    .day-tile:hover { transform: translateY(-4px) }
    .day-tile.booked {
      background:#f0f0f0;
      color:#9a9a9a;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    .day-tile.inactive { visibility:hidden; pointer-events:none }

    /* Time Modal */
    .modal-backdrop {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.44); z-index:1500;
    }
    .modal-backdrop.show { display:flex; }
    .modal {
      width:92%;
      max-width:520px;
      background:#fff;
      padding:18px;
      border-radius:12px;
      box-shadow: 0 18px 48px rgba(0,0,0,0.18);
    }
    .slots { display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; justify-content:center }
    .slot {
      padding:10px 12px; border-radius:999px; border:none; cursor:pointer; font-weight:700; color:white;
      background: linear-gradient(180deg,var(--accent),var(--primary)); box-shadow:0 10px 24px rgba(108,43,185,0.12);
    }
    .slot.booked { background:#eee; color:#9a9a9a; cursor:not-allowed; box-shadow:none; }

    /* Toasts bottom-right (blurred) */
    .toast-wrap {
      position: fixed; right:14px; bottom:14px; z-index:2000; display:flex; flex-direction:column; gap:10px; align-items:flex-end;
    }
    .toast {
      min-width:220px; max-width:360px;
      padding:12px 14px;
      border-radius:10px;
      background: rgba(255,255,255,0.82);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 36px rgba(0,0,0,0.12);
      color:var(--primary);
      font-weight:700;
      border-left:6px solid var(--accent);
      transform: translateY(10px);
      opacity:0;
      transition: opacity 2s ease, transform 0.4s ease;
    }
    .toast.show { opacity:1; transform: translateY(0); }
    .toast.success { border-left-color:#23c26b; color:#0d5e33; }
    .toast.error { border-left-color:#ff6b6b; color:#7b2222; }

    /* Responsive smaller screens */
    @media (max-width:480px) {
      .page { padding-bottom:40px; }
      .logo { width:110px; height:110px; }
      .title { font-size:1.35rem; }
      .day-tile { height:44px; font-size:14px; }
    }
  </style>
</head>
<body>
  <main class="page" role="main">
    <!-- Logo + Title -->
    <img class="logo" src="https://i.imgur.com/1EOyoBG.png" alt="Guidance Office logo">
    <h1 class="title">Guidance Appointment Scheduling</h1>

    <!-- Booking form -->
    <section class="card" aria-labelledby="cardTitle">
      <h2 id="cardTitle">Book an Appointment</h2>

      <form id="appointmentForm" autocomplete="off">
        <div style="margin-bottom:12px">
          <label for="name">Full name</label>
          <input id="name" name="name" type="text" placeholder="Your full name" required>
        </div>

        <div style="margin-bottom:12px">
          <label for="email">Email address</label>
          <input id="email" name="email" type="email" placeholder="you@example.com" required>
        </div>

        <div style="margin-bottom:12px">
          <label for="phone">Phone (e.g. +63)</label>
          <input id="phone" name="phone" type="tel" placeholder="+63xxxxxxxxxx" required>
        </div>

        <div style="margin-bottom:12px">
          <label for="service">Service</label>
          <select id="service" name="service" required>
            <option value="">Select service</option>
            <option value="Counseling">Counseling</option>
            <option value="Career Guidance">Career Guidance</option>
            <option value="Academic Consultation">Academic Consultation</option>
            <option value="Others">Others</option>
          </select>
        </div>

        <div id="otherWrap" style="display:none;margin-bottom:12px">
          <label for="otherText">Please specify</label>
          <input id="otherText" type="text" placeholder="Please specify the service">
        </div>

        <div class="row" style="margin-bottom:12px">
          <div>
            <label for="date">Date</label>
            <!-- readonly viewer-only — selected via calendar -->
            <input id="date" name="date" type="text" placeholder="Pick a date (use calendar below)" readonly required>
          </div>
          <div>
            <label for="time">Time</label>
            <input id="time" name="time" type="text" placeholder="Pick time" readonly required>
          </div>
        </div>

        <div style="margin-bottom:12px">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" name="notes" placeholder="Additional notes..."></textarea>
        </div>

        <div style="display:flex; gap:10px; margin-top:6px;">
          <button id="openTimeBtn" type="button" class="btn ghost">Choose Time</button>
          <button id="submitBtn" type="submit" class="btn">Confirm Booking</button>
        </div>

        <p class="muted" style="margin-top:12px">If a date or time is grayed out it is already booked.</p>
      </form>
    </section>

    <!-- Calendar -->
    <section class="calendar" aria-label="Month calendar">
      <div class="cal-top">
        <div class="cal-month" id="monthTitle">Month YYYY</div>
        <div class="cal-nav">
          <button id="prevMonth" aria-label="Previous month">◀</button>
          <button id="nextMonth" aria-label="Next month">▶</button>
        </div>
      </div>

      <div class="cal-weeknames" aria-hidden="true">
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
      </div>

      <div class="cal-grid" id="calGrid" role="grid" aria-live="polite"></div>
    </section>
  </main>

  <!-- Time modal -->
  <div class="modal-backdrop" id="timeModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="timeTitle">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 id="timeTitle" style="margin:0;color:var(--primary)">Select a time slot</h3>
        <button id="closeTime" class="btn ghost" style="padding:8px 10px">Close</button>
      </div>
      <div class="slots" id="slotsContainer" role="list" aria-label="Available time slots"></div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCstDdbOAisSEZzu9FT9Zyzl_pj5-RHBnA",
      authDomain: "guidance-appointment.firebaseapp.com",
      databaseURL: "https://guidance-appointment-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "guidance-appointment",
      storageBucket: "guidance-appointment.firebasestorage.app",
      messagingSenderId: "280009961139",
      appId: "1:280009961139:web:f0863f2e5940be5e534ac6",
      measurementId: "G-2MCGGLRTML"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- EmailJS init ----------
    if (window.emailjs && typeof window.emailjs.init === 'function') {
      window.emailjs.init("xvStFrKI-3M-3ZCvz"); // public key you provided
    } else {
      console.warn('EmailJS script not loaded; emails will not be sent.');
    }

    // ---------- Constants & elements ----------
    const TIME_SLOTS = [
      "8:00 AM - 9:00 AM",
      "9:00 AM - 10:00 AM",
      "10:00 AM - 11:00 AM",
      "11:00 AM - 12:00 NN",
      "1:00 PM - 2:00 PM",
      "2:00 PM - 3:00 PM",
      "3:00 PM - 4:00 PM",
      "4:00 PM - 5:00 PM"
    ];

    const calGrid = document.getElementById('calGrid');
    const monthTitle = document.getElementById('monthTitle');
    const prevMonth = document.getElementById('prevMonth');
    const nextMonth = document.getElementById('nextMonth');

    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const openTimeBtn = document.getElementById('openTimeBtn');
    const timeModal = document.getElementById('timeModal');
    const slotsContainer = document.getElementById('slotsContainer');
    const closeTime = document.getElementById('closeTime');

    const serviceSelect = document.getElementById('service');
    const otherWrap = document.getElementById('otherWrap');
    const otherText = document.getElementById('otherText');

    const form = document.getElementById('appointmentForm');
    const toastWrap = document.getElementById('toastWrap');

    // local month state
    let displayedYear, displayedMonth; // month 0-11

    // ---------- Utility functions ----------
    function formatDateKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function slotKey(slot) {
      return slot.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
    }

    // toast: fade-in 2s, hold 1s, fade-out 2s (total 5s)
    function showToast(message, type = 'info') {
      const el = document.createElement('div');
      el.className = 'toast';
      if (type === 'success') el.classList.add('success');
      if (type === 'error') el.classList.add('error');
      el.textContent = message;
      toastWrap.appendChild(el);
      // fade-in
      requestAnimationFrame(() => el.classList.add('show'));
      // after 3s (2s fade-in + 1s hold) start fade-out
      setTimeout(() => {
        el.classList.remove('show');
        // after 2s fade-out remove element
        setTimeout(() => el.remove(), 2000);
      }, 3000);
    }

    // ---------- Fetch all appointments mapping ----------
    // returns { counts: {dateKey: count}, slots: {dateKey: [timeStr,...]} }
    async function fetchAllAppointments() {
      try {
        const snap = await get(ref(db, 'appointments'));
        if (!snap.exists()) return { counts: {}, slots: {} };
        const data = snap.val();
        const counts = {};
        const slots = {};
        for (const dateKey in data) {
          const dayNode = data[dateKey] || {};
          counts[dateKey] = Object.keys(dayNode).length;
          slots[dateKey] = Object.values(dayNode).map(v => (v && v.time) ? v.time : null).filter(Boolean);
        }
        return { counts, slots };
      } catch (err) {
        console.error('fetchAllAppointments error', err);
        return { counts: {}, slots: {} };
      }
    }

    // ---------- Render calendar for a month ----------
    async function renderCalendar(year, month) {
      displayedYear = year; displayedMonth = month;
      const first = new Date(year, month, 1);
      monthTitle.textContent = first.toLocaleString(undefined, { month: 'long', year: 'numeric' });

      // get appointment data once for performance
      const { counts, slots } = await fetchAllAppointments();

      // determine starting cell (previous Sunday)
      const start = new Date(year, month, 1);
      start.setDate(1 - start.getDay()); // go to previous sunday
      calGrid.innerHTML = '';

      // show 6 rows * 7 cols => 42 cells
      const today = new Date(); today.setHours(0,0,0,0);
      for (let i = 0; i < 42; i++) {
        const cellDate = new Date(start);
        cellDate.setDate(start.getDate() + i);
        const key = formatDateKey(cellDate);

        const tile = document.createElement('div');
        tile.className = 'day-tile';
        // hide days not in current month (keep spacing)
        if (cellDate.getMonth() !== month) {
          tile.classList.add('inactive');
        }

        tile.textContent = String(cellDate.getDate());

        // disable past days: not clickable
        const isPast = (cellDate < today);
        const count = counts[key] || 0;
        const fullyBooked = (count >= TIME_SLOTS.length);

        if (fullyBooked) {
          tile.classList.add('booked');
          tile.title = 'Fully booked';
        } else if (!isPast && cellDate.getMonth() === month) {
          // clickable future day in this month
          tile.addEventListener('click', () => {
            if (fullyBooked) { showToast('That date is fully booked.', 'error'); return; }
            dateInput.value = key;
            timeInput.value = '';
            openTimeModalForDate(key, slots[key] || []);
            showToast(`Selected ${key}`, 'success');
            // scroll the form into view on small screens (so user sees time)
            setTimeout(()=> document.querySelector('.card').scrollIntoView({behavior:'smooth', block:'start'}), 120);
          });
        } else {
          tile.style.opacity = 0.6;
        }

        calGrid.appendChild(tile);
      }

      // prev button disable if viewing current month or earlier
      const now = new Date();
      const currentY = now.getFullYear(), currentM = now.getMonth();
      if (year < currentY || (year === currentY && month <= currentM)) {
        prevMonth.disabled = true;
        prevMonth.style.opacity = 0.5;
        prevMonth.style.cursor = 'not-allowed';
      } else {
        prevMonth.disabled = false;
        prevMonth.style.opacity = 1;
        prevMonth.style.cursor = 'pointer';
      }
    }

    // nav month
    prevMonth.addEventListener('click', () => {
      if (prevMonth.disabled) return;
      const d = new Date(displayedYear, displayedMonth, 1);
      d.setMonth(d.getMonth() - 1);
      renderCalendar(d.getFullYear(), d.getMonth());
    });
    nextMonth.addEventListener('click', () => {
      const d = new Date(displayedYear, displayedMonth, 1);
      d.setMonth(d.getMonth() + 1);
      renderCalendar(d.getFullYear(), d.getMonth());
    });

    // ---------- Time modal & picking ----------
    function openTimeModalForDate(dateKey, bookedSlots = []) {
      slotsContainer.innerHTML = '';
      const booked = bookedSlots || [];
      TIME_SLOTS.forEach(slot => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'slot';
        btn.textContent = slot;
        btn.dataset.time = slot;
        if (booked.includes(slot)) {
          btn.classList.add('booked');
          btn.disabled = true;
        } else {
          btn.addEventListener('click', () => {
            timeInput.value = slot;
            closeTimeModal();
            showToast(`${slot} selected`, 'success');
          });
        }
        slotsContainer.appendChild(btn);
      });

      timeModal.classList.add('show');
      timeModal.style.display = 'flex';
      timeModal.setAttribute('aria-hidden', 'false');
    }
    function closeTimeModal() {
      timeModal.classList.remove('show');
      timeModal.style.display = 'none';
      timeModal.setAttribute('aria-hidden', 'true');
    }
    closeTime.addEventListener('click', closeTimeModal);
    timeModal.addEventListener('click', (e) => { if (e.target === timeModal) closeTimeModal(); });

       // open-time button
    openTimeBtn.addEventListener('click', async () => {
      const d = dateInput.value;
      if (!d) { showToast('Please select a date first (use the calendar).', 'error'); return; }
      try {
        const snap = await get(ref(db, `appointments/${d}`));
        const booked = snap.exists() ? Object.values(snap.val()).map(v => v && v.time).filter(Boolean) : [];
        openTimeModalForDate(d, booked);
      } catch (err) {
        console.error('openTimeBtn error', err);
        showToast('Could not load times.', 'error');
      }
    });

    // ---------- Service "Others" UI ----------
    serviceSelect.addEventListener('change', (e) => {
      if (serviceSelect.value === 'Others') {
        otherWrap.style.display = 'block';
        otherText.required = true;
      } else {
        otherWrap.style.display = 'none';
        otherText.required = false;
        otherText.value = '';
      }
    });

    // ---------- Booking submit ----------
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      let service = serviceSelect.value;
      if (service === 'Others') service = otherText.value.trim() || 'Others';
      const dateKey = dateInput.value;
      const timeSlot = timeInput.value;
      const notes = document.getElementById('notes').value.trim();

      if (!name || !email || !phone || !service || !dateKey || !timeSlot) {
        showToast('Please complete required fields and pick a date & time.', 'error');
        return;
      }

      try {
        // double-check slot availability
        const sKey = slotKey(timeSlot);
        const slotRefPath = `appointments/${dateKey}/${sKey}`;
        const slotSnap = await get(ref(db, slotRefPath));
        if (slotSnap.exists()) {
          showToast('That time was just booked by someone else — choose another slot.', 'error');
          // refresh calendar view
          await renderCalendar(displayedYear, displayedMonth);
          return;
        }

        // save appointment under /appointments/{dateKey}/{slotKey}
        const appt = { name, email, phone, service, date: dateKey, time: timeSlot, notes: notes || '', status: 'pending', timestamp: Date.now() };
        await set(ref(db, slotRefPath), appt);

        // compatibility list (optional)
        try { await push(ref(db, 'appointments_list'), appt); } catch (err) { console.warn('push list failed', err); }

        // send confirmation via EmailJS (non-blocking)
        try {
          if (window.emailjs && typeof window.emailjs.send === 'function') {
            await window.emailjs.send('service_qtacvtn', 'template_ewvtufi', {
              to_email: email,
              name,
              service,
              date: dateKey,
              time: timeSlot
            });
          }
        } catch (emErr) {
          console.warn('EmailJS send failed:', emErr);
        }

        showToast('Appointment booked — confirmation sent if email available.', 'success');

        // reset form + inputs
        form.reset();
        timeInput.value = '';
        dateInput.value = '';

        // refresh calendar so date/time now show as booked
        await renderCalendar(displayedYear, displayedMonth);

      } catch (err) {
        console.error('booking error', err);
        showToast('Error saving appointment. Try again.', 'error');
      }
    });

    // ---------- Init calendar to current month (and prevent past months) ----------
    (function init() {
      const now = new Date();
      renderCalendar(now.getFullYear(), now.getMonth());
    })();

    // periodic refresh to reflect other users' bookings
    setInterval(() => {
      renderCalendar(displayedYear, displayedMonth).catch(()=>{/* ignore */});
    }, 30_000);

  </script>
</body>
</html>
