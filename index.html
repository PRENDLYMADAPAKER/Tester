<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel - Clinician DTR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
  :root{
    --bg1: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    --card-bg: rgba(255,255,255,0.18);
    --card-border: rgba(255,255,255,0.25);
    --accent: #2c0a34;
    --danger: #ef4444;
  }
  html,body{height:100%;margin:0;}
  body {
    font-family: Inter, system-ui, Arial, sans-serif;
    background: var(--bg1);
    color: var(--accent);
    display: flex;
    justify-content: center;
    padding: 20px;
    min-height: 100vh;
  }
  body::before{
    content:"";
    position:fixed; top:50%; left:50%;
    width:480px; height:480px;
    background:url('https://i.imgur.com/sjdlb28.jpeg') no-repeat center center;
    background-size:cover; opacity:0.06; transform:translate(-50%,-50%); z-index:0;
  }
  .container { width:100%; max-width:1400px; display:flex; gap:18px; align-items:flex-start; z-index:1; }

  /* Sidebar */
  .sidebar { width:160px; min-width:160px; display:flex; flex-direction:column; gap:8px; position:sticky; top:24px; height: calc(100vh - 48px); }
  .sidebar .card{ padding:12px; display:flex; flex-direction:column; gap:8px; align-items:stretch; }
  .sidebar button{ padding:10px; border-radius:10px; text-align:left; background:transparent; color:var(--accent); font-weight:600; border:1px solid rgba(0,0,0,0.04); cursor:pointer; }
  .sidebar button.active{ background:var(--accent); color:white; }

  /* main */
  .main{ flex:1; display:flex; flex-direction:column; gap:20px; min-width:0; }
  .card{ background:var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border:1px solid var(--card-border); padding:20px; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.12); }
  h1,h2{ margin:0; color:var(--accent); }
  h2{ font-size:18px; margin-bottom:8px; }

  button.primary{ padding:8px 12px; border-radius:8px; border:none; background:linear-gradient(135deg,#ffffff,#ff9ce3,#a855f7); color:var(--accent); font-weight:600; cursor:pointer; }
  button.danger{ background:var(--danger); color:white; }

  table{ width:100%; border-collapse:collapse; margin-top:12px; }
  th, td{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.22); font-size:14px; text-align:center; vertical-align:middle; }
  td.left{ text-align:left; white-space:pre-wrap; }

  .row{ display:flex; gap:8px; align-items:center; }
  .muted{ font-size:13px; opacity:0.8; }
  .success{ color:#166534; }
  .error{ color:#b91c1c; }

  #dashboard{ display:flex; gap:18px; align-items:flex-start; width:100%; }
  .scanner-col{ flex:0 0 420px; max-width:420px; }
  .content-col{ flex:1; min-width:0; }

  #preview{ width:100%; height:240px; border-radius:8px; background:#000; display:block; object-fit:cover; }

  /* modal */
  .modal{ position:fixed; top:0; left:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index:9999; }
  .modal .modal-content{ background:rgba(255,255,255,0.98); padding:18px; border-radius:10px; max-width:1000px; width:calc(100% - 48px); max-height:90vh; overflow:auto; }
  .modal .closeBtn{ float:right; background:var(--danger); color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }

  /* canvas responsiveness */
  #wheelCanvas{ width:100%; max-width:560px; height:auto; border-radius:8px; border:1px solid rgba(0,0,0,0.06); }

  @media (max-width:900px){
    .container{ padding:8px; gap:10px; flex-direction:column; }
    .sidebar{ width:100%; min-width:auto; flex-direction:row; position:relative; height:auto; overflow:auto; }
    .scanner-col{ max-width:100%; }
  }
  </style>
</head>
<body>
  <div class="container">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="card">
        <button id="sidebarScanner" class="active">Scanner</button>
        <button id="sidebarLogs">Logs</button>
        <button id="sidebarRequests">Requests</button>
        <button id="sidebarBasket">Basket</button>
        <button id="sidebarCases">Case Selections</button>
        <button id="sidebarInstructors">Instructors</button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center;">
        <h1>Admin Panel - Clinician DTR</h1>
        <div class="row">
          <button id="openRequests" class="primary">‚öôÔ∏è Update Requests</button>
          <button id="openBasket" class="primary">üóÇ Basket</button>
        </div>
      </div>

      <div id="dashboard">
        <!-- left: scanner -->
        <div class="card scanner-col" id="scannerCard">
          <h2>QR Scanner</h2>
          <div class="row" style="margin-bottom:12px;">
            <button class="primary" onclick="startScanner()">Start Scanner</button>
            <button class="danger" onclick="stopScanner()">Stop Scanner</button>
          </div>
          <video id="preview"></video>
          <p id="scanStatus" class="muted">Scanner stopped.</p>
        </div>

        <!-- right: content -->
        <div class="content-col">
          <!-- last scan result -->
          <div class="card" id="scanResult" style="display:none;">
            <h3>Last Scan Result</h3>
            <p><strong>Name:</strong> <span id="resName">-</span></p>
            <p><strong>Clinical Level:</strong> <span id="resLevel">-</span></p>
            <p><strong>Email:</strong> <span id="resEmail">-</span></p>
            <p><strong>Time In:</strong> <span id="resTime">-</span></p>
          </div>

          <!-- Attendance Logs -->
          <div class="card" id="logsSection">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h2>Attendance Logs (Today)</h2>
              <div class="row">
                <button class="primary" onclick="exportLogs()">Export</button>
                <button class="primary" onclick="printLogs()">Print</button>
                <button class="primary" onclick="resetLogs()">Archive & Clear</button>
                <button class="danger" onclick="deleteToday()">Delete Today</button>
              </div>
            </div>
            <table>
              <thead><tr><th>User</th><th>Date</th><th>Time In</th></tr></thead>
              <tbody id="logsBody"><tr><td colspan="3" class="muted">No logs yet</td></tr></tbody>
            </table>
          </div>
          <!-- Case Selections -->
          <div class="card" id="casesSection" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h2>Case Selections (All Clinicians)</h2>
              <div class="row">
                <button id="refreshCases" class="primary">Refresh</button>
                <button class="primary" onclick="exportCases()">Export</button>
                <button class="primary" onclick="printCases()">Print</button>
                <button id="manageInstructorsBtn" class="primary">Manage Instructors</button>
              </div>
            </div>
            <table>
              <thead>
                <tr><th>Clinician</th><th>Type</th><th>Details</th><th>Instructor</th><th>Date</th><th>Action</th></tr>
              </thead>
              <tbody id="casesBody"><tr><td colspan="6" class="muted">Loading...</td></tr></tbody>
            </table>
          </div>

          <!-- Instructors quick panel -->
          <div class="card" id="instructorsPanel" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h2>Instructors</h2>
              <div class="row">
                <input id="newInstructorName" placeholder="Dr. Name" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
                <button id="addInstructorBtn" class="primary">Add</button>
              </div>
            </div>
            <table>
              <thead><tr><th>Instructor</th><th>Actions</th></tr></thead>
              <tbody id="instructorsBody"><tr><td colspan="2" class="muted">No instructors</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Requests Modal -->
  <div id="requestsModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" id="closeRequests">‚úñ</button>
      <h2>Update Requests</h2>
      <label class="muted">Filter:
        <select id="filterSelect">
          <option value="all">All</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option>
        </select>
      </label>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Requested</th><th>Current</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="requestsBody"><tr><td colspan="6" class="muted">No requests</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Basket Modal -->
  <div id="basketModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" id="closeBasket">‚úñ</button>
      <h2>Basket (Archived Requests)</h2>
      <div class="row" style="margin-bottom:8px;">
        <button onclick="showBasket('approved')" class="primary">Approved</button>
        <button onclick="showBasket('rejected')" class="primary">Rejected</button>
      </div>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Requested</th><th>Status</th><th>Date</th></tr></thead>
        <tbody id="basketBody"><tr><td colspan="5" class="muted">No items</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Spin-the-Wheel Modal -->
  <div id="wheelModal" class="modal">
    <div class="modal-content" style="text-align:center;">
      <button class="closeBtn" id="closeWheel">‚úñ</button>
      <h2>Assign Instructor (Spin the Wheel)</h2>
      <p class="muted">Click "Spin" to randomly pick an instructor from the current list.</p>
      <div style="display:flex;gap:16px;align-items:center;justify-content:center;flex-wrap:wrap;">
        <canvas id="wheelCanvas" width="560" height="560"></canvas>
      </div>
      <div style="margin-top:10px;">
        <button id="spinWheelBtn" class="primary">Spin</button>
        <button id="confirmAssignBtn" class="primary" style="display:none;margin-left:8px">Confirm Assign</button>
      </div>
      <p id="wheelResult" class="muted" style="margin-top:10px;"></p>
    </div>
  </div>

  <!-- Instructors Management Modal -->
  <div id="instructorsModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" id="closeInstructors">‚úñ</button>
      <h2>Instructor Management</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
        <input id="modalNewInstructorName" placeholder="Dr. Name" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);flex:1;" />
        <button id="modalAddInstructorBtn" class="primary">Add Instructor</button>
      </div>
      <table>
        <thead><tr><th>Instructor</th><th>Actions</th></tr></thead>
        <tbody id="modalInstructorsBody"><tr><td colspan="2" class="muted">No instructors</td></tr></tbody>
      </table>
    </div>
  </div>

  <audio id="success-sound" src="Thank you.mp3" preload="auto"></audio>
  <!-- JS Libraries + App logic -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
  // ---------------- Firebase init ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
    authDomain: "dtr-project-66048.firebaseapp.com",
    databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dtr-project-66048",
    storageBucket: "dtr-project-66048.appspot.com",
    messagingSenderId: "271445506225",
    appId: "1:271445506225:web:fcb04d0454e1302de14a90"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------------- helpers ----------------
  const $id = id => document.getElementById(id);
  const fmtDate = ts => ts ? new Date(ts).toLocaleString() : '-';

  // ---------------- QR scanner ----------------
  const codeReader = new ZXing.BrowserQRCodeReader();
  const preview = $id('preview');
  const scanStatus = $id('scanStatus');

  async function startScanner(){
    try{
      const devices = await codeReader.listVideoInputDevices();
      if(!devices || devices.length===0){ scanStatus.textContent="No camera found."; scanStatus.className='error'; return; }
      const back = devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[0];
      codeReader.decodeFromVideoDevice(back.deviceId, preview, (result, err) => {
        if(result && result.getText) handleScan(result.getText());
      });
      scanStatus.textContent="Scanner started."; scanStatus.className='muted';
    }catch(err){
      scanStatus.textContent="Camera error: " + (err.message||err); scanStatus.className='error';
    }
  }
  function stopScanner(){ try{ codeReader.reset(); }catch(e){} try{ preview.srcObject=null; }catch(e){} scanStatus.textContent="Scanner stopped."; scanStatus.className='muted'; }

  async function handleScan(uid){
    try{
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const timeStr = now.toTimeString().split(' ')[0];
      const dtrRef = db.ref(`users/${uid}/dtr/${dateStr}`);
      const snap = await dtrRef.get();
      const profileSnap = await db.ref(`users/${uid}/profile`).get();
      const profile = profileSnap.exists() ? profileSnap.val() : {};

      if(snap.exists() && snap.val().timeIn){
        $id('resName').textContent = profile.name || uid;
        $id('resLevel').textContent = profile.clinicalLevel || '-';
        $id('resEmail').textContent = profile.email || '-';
        $id('resTime').textContent = snap.val().timeIn;
        $id('scanResult').style.display = 'block';
        scanStatus.textContent = `${profile.name || uid} already Time-In today at ${snap.val().timeIn}`;
        scanStatus.className = 'error';
        return;
      }

      await dtrRef.set({ timeIn: timeStr });
      $id('resName').textContent = profile.name || uid;
      $id('resLevel').textContent = profile.clinicalLevel || '-';
      $id('resEmail').textContent = profile.email || '-';
      $id('resTime').textContent = timeStr;
      $id('scanResult').style.display = 'block';
      scanStatus.textContent = `Recorded for ${profile.name || uid} at ${timeStr}`;
      scanStatus.className = 'success';
      try{ $id('success-sound')?.play().catch(()=>{}); }catch(e){}
    }catch(err){
      console.error('handleScan', err);
      scanStatus.textContent = "Scan error: " + (err.message||err); scanStatus.className='error';
    }
  }

  // ---------------- Attendance Logs ----------------
  const logsBody = $id('logsBody');
  let todayLogs = [];
  async function refreshLogsView(){
    logsBody.innerHTML = '';
    todayLogs = [];
    const today = new Date().toISOString().split('T')[0];
    const usersSnap = await db.ref('users').get();
    if(!usersSnap.exists()){ logsBody.innerHTML = '<tr><td colspan="3" class="muted">No users</td></tr>'; return; }
    let has=false;
    usersSnap.forEach(uSnap=>{
      const uid = uSnap.key;
      const profile = uSnap.child('profile').val() || {};
      const dtr = uSnap.child(`dtr/${today}`).val();
      if(dtr && dtr.timeIn){
        has=true;
        todayLogs.push({ name: profile.name || uid, date: today, timeIn: dtr.timeIn });
        logsBody.innerHTML += `<tr><td>${profile.name || uid}</td><td>${today}</td><td>${dtr.timeIn}</td></tr>`;
      }
    });
    if(!has) logsBody.innerHTML = '<tr><td colspan="3" class="muted">No logs today</td></tr>';
  }
  refreshLogsView();

  function exportLogs(){
    if(todayLogs.length === 0) return alert("No logs to export.");
    let csv = "Name,Date,Time In\n";
    todayLogs.forEach(r => csv += `"${r.name.replace(/"/g,'""')}",${r.date},${r.timeIn}\n`);
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'attendance_logs_today.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  function printLogs(){
    if(todayLogs.length === 0) return alert("No logs to print.");
    const html = `
      <html><head><title>Attendance Logs (Today)</title>
      <style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #333;padding:8px;text-align:center}th{background:#f3f3f3}</style>
      </head><body>
      <h2>Attendance Logs (Today)</h2>
      <table><thead><tr><th>User</th><th>Date</th><th>Time In</th></tr></thead><tbody>
      ${todayLogs.map(r=>`<tr><td>${r.name}</td><td>${r.date}</td><td>${r.timeIn}</td></tr>`).join('')}
      </tbody></table>
      </body></html>`;
    const w = window.open('','_blank'); w.document.write(html); w.document.close(); w.print();
  }

  async function resetLogs(){
    if(!confirm("Archive today's logs and clear admin view? This does NOT delete users' DTR records.")) return;
    const today = new Date().toISOString().split('T')[0];
    const usersSnap = await db.ref('users').get();
    const archiveRef = db.ref(`archive/${today}`);
    const updates = {};
    usersSnap.forEach(uSnap=>{
      const uid = uSnap.key;
      const profile = uSnap.child('profile').val() || {};
      const dtr = uSnap.child(`dtr/${today}`).val();
      if(dtr && dtr.timeIn){
        updates[`${today}/${uid}`] = { name: profile.name || uid, email: profile.email || '', timeIn: dtr.timeIn, ts: Date.now() };
      }
    });
    if(Object.keys(updates).length) {
      await archiveRef.set(updates);
    }
    // Mark admin cleared flag
    await db.ref(`adminClearedLogs/${today}`).set(true);
    alert("Archived and cleared admin view.");
    refreshLogsView();
  }

  async function deleteToday(){
    if(!confirm("This will DELETE today's Time In records for all users. Continue?")) return;
    const today = new Date().toISOString().split('T')[0];
    const usersSnap = await db.ref('users').get();
    const promises = [];
    usersSnap.forEach(uSnap => {
      promises.push(db.ref(`users/${uSnap.key}/dtr/${today}`).remove());
    });
    await Promise.all(promises);
    await db.ref(`adminClearedLogs/${today}`).remove();
    alert("Deleted today's records.");
    refreshLogsView();
  }

  // ---------------- Update Requests & Basket ----------------
  const requestsBody = $id('requestsBody');
  const filterSelect = $id('filterSelect');
  const basketBody = $id('basketBody');

  function renderRequests(snap) {
    requestsBody.innerHTML = '';
    if(!snap.exists()){ requestsBody.innerHTML = '<tr><td colspan="6" class="muted">No requests</td></tr>'; return; }
    let rows = [];
    snap.forEach(userSnap=>{
      const uid = userSnap.key;
      userSnap.forEach(reqSnap=>{
        const req = reqSnap.val(); const reqId = reqSnap.key;
        rows.push({ uid, reqId, req });
      });
    });
    // apply filter
    const filter = filterSelect.value || 'all';
    const filtered = rows.filter(r => filter === 'all' ? true : (r.req.status === filter));
    if(filtered.length === 0){ requestsBody.innerHTML = '<tr><td colspan="6" class="muted">No matching requests</td></tr>'; return; }
    filtered.forEach(async r => {
      const profileSnap = await db.ref(`users/${r.uid}/profile`).get();
      const profile = profileSnap.exists() ? profileSnap.val() : {};
      const currentVal = r.req.field === 'password' ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : (profile[r.req.field] || '');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${profile.name || r.uid}<br><span class="muted">${profile.email||''}</span></td>
        <td>${r.req.field}</td><td>${r.req.value}</td><td>${currentVal}</td><td>${r.req.status}</td>
        <td>
          <button class="primary" onclick="approveReq('${r.uid}','${r.reqId}','${r.req.field}','${encodeURIComponent(r.req.value)}')">Approve</button>
          <button class="primary" onclick="rejectReq('${r.uid}','${r.reqId}')">Reject</button>
        </td>`;
      requestsBody.appendChild(tr);
    });
  }

  db.ref('updateRequests').on('value', snap => renderRequests(snap));
  if(filterSelect) filterSelect.onchange = () => db.ref('updateRequests').get().then(renderRequests);

  async function approveReq(uid, reqId, field, encodedValue){
    try{
      const value = decodeURIComponent(encodedValue);
      // only update safe fields
      if(['name','email','clinicalLevel'].includes(field)){
        await db.ref(`users/${uid}/profile/${field}`).set(value);
      }
      const reqSnap = await db.ref(`updateRequests/${uid}/${reqId}`).get();
      const reqData = reqSnap.exists() ? reqSnap.val() : {};
      const profileSnap = await db.ref(`users/${uid}/profile`).get();
      const profile = profileSnap.exists() ? profileSnap.val() : {};
      await db.ref(`basket/approved/${reqId}`).set({ ...reqData, uid, name: profile.name || uid, email: profile.email || '', status: 'approved', ts: Date.now() });
      await db.ref(`updateRequests/${uid}/${reqId}`).remove();
    }catch(e){ console.error(e); alert('Approve failed'); }
  }

  async function rejectReq(uid, reqId){
    try{
      const reqSnap = await db.ref(`updateRequests/${uid}/${reqId}`).get();
      const reqData = reqSnap.exists() ? reqSnap.val() : {};
      const profileSnap = await db.ref(`users/${uid}/profile`).get();
      const profile = profileSnap.exists() ? profileSnap.val() : {};
      await db.ref(`basket/rejected/${reqId}`).set({ ...reqData, uid, name: profile.name || uid, email: profile.email || '', status: 'rejected', ts: Date.now() });
      await db.ref(`updateRequests/${uid}/${reqId}`).remove();
    }catch(e){ console.error(e); alert('Reject failed'); }
  }

  // Basket listener
  db.ref('basket/approved').on('value', snap => {
    if(!snap.exists()){ /* no op */ }
  });
  db.ref('basket/rejected').on('value', snap => {
    if(!snap.exists()){ /* no op */ }
  });

  function showBasket(type){
    const node = type === 'approved' ? db.ref('basket/approved') : db.ref('basket/rejected');
    node.get().then(snap=>{
      if(!snap.exists()){ basketBody.innerHTML = `<tr><td colspan="5" class="muted">No ${type}</td></tr>`; return; }
      const rows = [];
      snap.forEach(child => {
        const v = child.val();
        rows.push(`<tr><td>${v.name||''}<br><span class="muted">${v.email||''}</span></td><td>${v.field||''}</td><td>${v.value||''}</td><td>${v.status||''}</td><td>${fmtDate(v.ts)}</td></tr>`);
      });
      basketBody.innerHTML = rows.join('');
    });
  }

  // ---------------- Case Selections (Admin) ----------------
  const casesBody = $id('casesBody');

  async function loadCases(){
    casesBody.innerHTML = '<tr><td colspan="6" class="muted">Loading...</td></tr>';
    const snap = await db.ref('cases').get();
    if(!snap.exists()){ casesBody.innerHTML = '<tr><td colspan="6" class="muted">No cases found</td></tr>'; return; }
    const data = snap.val();
    const rows = [];
    // gather user profiles once
    const uids = Object.keys(data);
    const profilePromises = uids.map(uid => db.ref(`users/${uid}/profile`).get().then(p => ({ uid, profile: p.exists() ? p.val() : {} })));
    const profiles = await Promise.all(profilePromises);
    const profileMap = {}; profiles.forEach(p => profileMap[p.uid] = p.profile || {});
    for(const uid of uids){
      const userCases = data[uid] || {};
      for(const caseId of Object.keys(userCases)){
        const c = userCases[caseId];
        rows.push({ uid, caseId, clinician: profileMap[uid].name || uid, type: c.type || '', details: c.details || '', instructor: c.instructor || 'Pending', date: c.timestamp || null });
      }
    }
    // render
    casesBody.innerHTML = rows.map(r => `<tr>
      <td>${r.clinician}</td>
      <td>${r.type}</td>
      <td class="left">${r.details}</td>
      <td>${r.instructor}</td>
      <td>${r.date ? new Date(r.date).toLocaleString() : '-'}</td>
      <td>${r.instructor === 'Pending' ? `<button class="primary" onclick="openWheel('${r.uid}','${r.caseId}')">Assign Instructor</button>` : '‚Äî'}</td>
    </tr>`).join('');
  }

  $id('refreshCases').onclick = loadCases;

  // export cases (CSV)
  async function exportCases(){
    const snap = await db.ref('cases').get();
    if(!snap.exists()) return alert("No cases to export.");
    const data = snap.val();
    const rows = [["Clinician","Type","Details","Instructor","Date"]];
    const uids = Object.keys(data);
    const pr = uids.map(uid => db.ref(`users/${uid}/profile`).get().then(p=>({ uid, profile: p.exists() ? p.val() : {} })));
    const profiles = await Promise.all(pr);
    const profileMap = {}; profiles.forEach(p=>profileMap[p.uid] = p.profile || {});
    for(const uid of uids){
      const userCases = data[uid] || {};
      for(const caseId in userCases){
        const c = userCases[caseId];
        rows.push([ profileMap[uid].name || uid, c.type||'', (c.details||'').replace(/\n/g,' '), c.instructor || 'Pending', c.timestamp ? new Date(c.timestamp).toLocaleString() : '' ]);
      }
    }
    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'case_selections.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // print cases
  async function printCases(){
    const snap = await db.ref('cases').get();
    if(!snap.exists()) return alert("No cases to print.");
    const data = snap.val();
    const uids = Object.keys(data);
    const pr = uids.map(uid => db.ref(`users/${uid}/profile`).get().then(p=>({ uid, profile: p.exists() ? p.val() : {} })));
    const profiles = await Promise.all(pr);
    const profileMap = {}; profiles.forEach(p=>profileMap[p.uid] = p.profile || {});
    const rows = [];
    for(const uid of uids){
      const userCases = data[uid] || {};
      for(const caseId in userCases){
        const c = userCases[caseId];
        rows.push({ clinician: profileMap[uid].name || uid, type: c.type||'', details: (c.details||'').replace(/\n/g,' '), instructor: c.instructor || 'Pending', date: c.timestamp ? new Date(c.timestamp).toLocaleString() : '' });
      }
    }
    const html = `
      <html><head><title>Case Selections</title>
      <style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #333;padding:8px;text-align:left}th{background:#f3f3f3}</style>
      </head><body><h2>Case Selections</h2>
      <table><thead><tr><th>Clinician</th><th>Type</th><th>Details</th><th>Instructor</th><th>Date</th></tr></thead>
      <tbody>${rows.map(r=>`<tr><td>${r.clinician}</td><td>${r.type}</td><td>${r.details}</td><td>${r.instructor}</td><td>${r.date}</td></tr>`).join('')}</tbody></table>
      </body></html>`;
    const w = window.open('','_blank'); w.document.write(html); w.document.close(); w.print();
  }

  // ---------------- Instructor Management ----------------
  async function loadInstructors(){
    const tbody = $id('instructorsBody');
    const modalTbody = $id('modalInstructorsBody');
    tbody.innerHTML = '<tr><td colspan="2" class="muted">Loading...</td></tr>'; modalTbody.innerHTML = '<tr><td colspan="2" class="muted">Loading...</td></tr>';
    const snap = await db.ref('instructors').get();
    tbody.innerHTML = ''; modalTbody.innerHTML = '';
    if(!snap.exists()){ tbody.innerHTML = '<tr><td colspan="2" class="muted">No instructors</td></tr>'; modalTbody.innerHTML = '<tr><td colspan="2" class="muted">No instructors</td></tr>'; return; }
    snap.forEach(child => {
      const id = child.key, name = child.val();
      const row = `<tr><td style="text-align:left">${name}</td><td><button class="primary" onclick="removeInstructor('${id}')">Remove</button></td></tr>`;
      tbody.innerHTML += row; modalTbody.innerHTML += row;
    });
  }

  async function addInstructor(name){
    if(!name) return alert('Enter a name');
    await db.ref('instructors').push(name);
    await loadInstructors();
  }
  async function removeInstructor(id){
    if(!confirm('Remove this instructor?')) return;
    await db.ref(`instructors/${id}`).remove();
    await loadInstructors();
  }

  $id('addInstructorBtn').onclick = ()=>{ const v = $id('newInstructorName').value.trim(); if(v){ addInstructor(v); $id('newInstructorName').value=''; } };
  $id('modalAddInstructorBtn').onclick = ()=>{ const v = $id('modalNewInstructorName').value.trim(); if(v){ addInstructor(v); $id('modalNewInstructorName').value=''; } };

  // ---------------- Spin-the-Wheel ----------------
  const wheelCanvas = $id('wheelCanvas');
  const ctx = wheelCanvas.getContext('2d');
  let wheelNames = [];
  let wheelCaseUid = null, wheelCaseId = null;
  let isSpinning = false;
  let currentRotation = 0;

  async function openWheel(uid, caseId){
    wheelCaseUid = uid; wheelCaseId = caseId;
    $id('wheelResult').textContent = ''; $id('confirmAssignBtn').style.display = 'none';
    const snap = await db.ref('instructors').get();
    wheelNames = [];
    if(snap.exists()) snap.forEach(c => wheelNames.push(c.val()));
    if(wheelNames.length === 0){ alert('No instructors available. Add instructors first.'); return; }
    currentRotation = 0;
    drawWheel(0);
    $id('wheelModal').style.display = 'flex';
  }

  function drawWheel(rotation){
    const w = wheelCanvas.width, h = wheelCanvas.height;
    const cx = w/2, cy = h/2, r = Math.min(cx,cy) - 8;
    ctx.clearRect(0,0,w,h);
    const n = Math.max(1, wheelNames.length);
    const arc = (2*Math.PI)/n;
    for(let i=0;i<n;i++){
      const start = i*arc + rotation;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,start+arc);
      ctx.closePath();
      ctx.fillStyle = i % 2 === 0 ? '#ff9ce3' : '#a855f7';
      ctx.fill();
      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate(start + arc/2);
      ctx.textAlign = 'right';
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 18px Arial';
      const txt = wheelNames[i];
      ctx.fillText(txt, r - 10, 6);
      ctx.restore();
    }
    // pointer
    ctx.fillStyle = '#222';
    ctx.beginPath();
    ctx.moveTo(cx - 12, cy - r - 8);
    ctx.lineTo(cx + 12, cy - r - 8);
    ctx.lineTo(cx, cy - r + 22);
    ctx.closePath(); ctx.fill();
  }

  function spinWheel(){
    if(isSpinning) return;
    if(!wheelNames.length) return alert('No instructors to pick.');
    isSpinning = true;
    $id('wheelResult').textContent = 'Spinning...'; $id('confirmAssignBtn').style.display = 'none';
    const n = wheelNames.length;
    const arc = (2*Math.PI)/n;
    const finalIndex = Math.floor(Math.random() * n);
    const rotations = 6 + Math.floor(Math.random()*4); // 6..9
    const finalAngle = (2*Math.PI * rotations) + ((n - finalIndex) * arc) - (arc/2);
    const duration = 3600;
    const startTime = performance.now();
    const startRotation = currentRotation;

    function animate(now){
      const t = Math.min(1, (now - startTime) / duration);
      const ease = 1 - Math.pow(1 - t, 3); // easeOutCubic
      currentRotation = startRotation + (finalAngle - startRotation) * ease;
      drawWheel(currentRotation);
      if(t < 1) requestAnimationFrame(animate);
      else {
        isSpinning = false;
        // compute selected index
        const normalized = ((currentRotation % (2*Math.PI)) + (2*Math.PI)) % (2*Math.PI);
        const idx = Math.floor((2*Math.PI - normalized + (arc/2)) / arc) % n;
        const selected = wheelNames[idx];
        $id('wheelResult').textContent = 'Selected: ' + selected;
        $id('confirmAssignBtn').style.display = 'inline-block';
        $id('confirmAssignBtn').dataset.selected = selected;
      }
    }
    requestAnimationFrame(animate);
  }

  $id('spinWheelBtn').onclick = spinWheel;

  $id('confirmAssignBtn').onclick = async function(){
    const selected = this.dataset.selected;
    if(!selected) return alert('Nothing selected');
    if(!wheelCaseUid || !wheelCaseId) return alert('No case selected');
    await db.ref(`cases/${wheelCaseUid}/${wheelCaseId}/instructor`).set(selected);
    $id('wheelModal').style.display = 'none';
    await loadCases();
    alert(`Assigned ${selected}`);
  };

  $id('closeWheel').onclick = ()=> { $id('wheelModal').style.display = 'none'; };

  // ---------------- Modal controls & sidebar ----------------
  $id('openRequests').onclick = ()=> { $id('requestsModal').style.display = 'flex'; };
  $id('closeRequests').onclick = ()=> { $id('requestsModal').style.display = 'none'; };
  $id('openBasket').onclick = ()=> { $id('basketModal').style.display = 'flex'; };
  $id('closeBasket').onclick = ()=> { $id('basketModal').style.display = 'none'; };
  $id('manageInstructorsBtn').onclick = ()=> { loadInstructors().then(()=> $id('instructorsModal').style.display = 'flex'); };
  $id('closeInstructors').onclick = ()=> { $id('instructorsModal').style.display = 'none'; };

  function hideAllSections(){
    $id('scannerCard').style.display = 'none';
    $id('logsSection').style.display = 'none';
    $id('casesSection').style.display = 'none';
    $id('instructorsPanel').style.display = 'none';
  }
  function activateSidebarBtn(id){
    document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));
    $id(id).classList.add('active');
  }
  $id('sidebarScanner').onclick = ()=>{ hideAllSections(); $id('scannerCard').style.display='block'; activateSidebarBtn('sidebarScanner'); };
  $id('sidebarLogs').onclick = ()=>{ hideAllSections(); $id('logsSection').style.display='block'; refreshLogsView(); activateSidebarBtn('sidebarLogs'); };
  $id('sidebarRequests').onclick = ()=>{ hideAllSections(); $id('requestsModal').style.display='flex'; activateSidebarBtn('sidebarRequests'); };
  $id('sidebarBasket').onclick = ()=>{ hideAllSections(); $id('basketModal').style.display='flex'; activateSidebarBtn('sidebarBasket'); };
  $id('sidebarCases').onclick = ()=>{ hideAllSections(); $id('casesSection').style.display='block'; loadCases(); activateSidebarBtn('sidebarCases'); };
  $id('sidebarInstructors').onclick = ()=>{ hideAllSections(); $id('instructorsPanel').style.display='block'; loadInstructors(); activateSidebarBtn('sidebarInstructors'); };

  // close modal clicking outside
  window.onclick = e => { if(e.target.classList && e.target.classList.contains('modal')) e.target.style.display = 'none'; };

  // ---------------- realtime listeners ----------------
  db.ref('users').on('value', ()=> refreshLogsView());
  db.ref('cases').on('value', ()=> { if($id('casesSection').style.display !== 'none') loadCases(); });
  db.ref('instructors').on('value', ()=> { if($id('instructorsPanel').style.display !== 'none' || $id('instructorsModal').style.display !== 'none') loadInstructors(); });

  // initial state
  hideAllSections(); $id('scannerCard').style.display = 'block'; activateSidebarBtn('sidebarScanner');

  // expose functions for inline handlers
  window.startScanner = startScanner; window.stopScanner = stopScanner;
  window.exportLogs = exportLogs; window.printLogs = printLogs; window.resetLogs = resetLogs; window.deleteToday = deleteToday;
  window.showBasket = showBasket; window.loadCases = loadCases; window.openWheel = openWheel;
  window.loadInstructors = loadInstructors; window.addInstructor = addInstructor; window.removeInstructor = removeInstructor;
  window.exportCases = exportCases; window.printCases = printCases;
  window.approveReq = approveReq; window.rejectReq = rejectReq;

  // small safety: set canvas resolution to match style
  (function resizeWheelCanvas(){
    const canvas = $id('wheelCanvas');
    function fit(){ const rect = canvas.getBoundingClientRect(); canvas.width = rect.width; canvas.height = rect.width; drawWheel(currentRotation || 0); }
    window.addEventListener('resize', fit); setTimeout(fit,100);
  })();
  </script>
</body>
</html>
