<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CI ADMIN PANEL</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f1724;
      --muted: #94a3b8;
      --accent: #06b6d4;
      --success: #4ade80;
      --warn: #fbbf24;
      --danger: #ef4444;
    }
    html,body {
      height: 100%;
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: var(--bg);
      color: #e6eef8;
    }
    header {
      background: var(--panel);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 0 rgba(255,255,255,0.02);
    }
    header h1 { margin: 0; font-size: 18px; }
    #clock { font-family: monospace; color: var(--muted); }
    main {
      max-width: 1100px; margin: 20px auto; padding: 0 16px;
      display: grid; grid-template-columns: 1fr 1fr; gap: 18px; box-sizing: border-box;
    }
    .card { background: #0f1724; padding: 18px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
    #video { width: 100%; max-width: 360px; border-radius: 8px; background: #000; display: block; margin: 0 auto; }
    #result { margin-top: 12px; text-align: center; font-weight: 600; min-height: 28px; }
    #profile { margin-top: 12px; background: #0b1220; padding: 10px; border-radius: 8px; display:none; }
    #profile div { margin: 6px 0; }
    .controls { display:flex; gap:10px; justify-content:center; margin-top:14px; }
    button { background: linear-gradient(90deg, var(--accent), #60a5fa); color:#021124; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    #logs-controls { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    #logs-search { flex:1; min-width:180px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; }
    .action-btn { background:#3b82f6; color:white; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .reset-btn { background:var(--danger); color:white; }
    table { width:100%; border-collapse:collapse; margin-top:6px; font-size:14px; }
    th,td { padding:10px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; }
    th { background: rgba(255,255,255,0.02); cursor:pointer; position:relative; }
    th .sort-arrow { position:absolute; right:8px; top:50%; transform:translateY(-50%); color:var(--muted); }
    tr:nth-child(even){ background: rgba(255,255,255,0.01); }
    .no-records { text-align:center; color:var(--muted); padding:18px; }
    @media (max-width:900px){ main { grid-template-columns:1fr; padding:12px; } #video { max-width:280px; } }
  </style>

  <!-- ZXing UMD must be loaded before module script that uses 'ZXing' global -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
</head>
<body>
  <header>
    <h1>üìã Admin DTR Panel ‚Äî Clinical Instructor</h1>
    <div id="clock">--:--:--</div>
  </header>

  <main>
    <section class="card" id="scanner-card">
      <video id="video" muted autoplay playsinline></video>
      <div id="result">Scanner idle</div>
      <div id="profile" aria-live="polite">
        <div><strong>Name:</strong> <span id="profile-name"></span></div>
        <div><strong>Email:</strong> <span id="profile-email"></span></div>
        <div><strong>Mode:</strong> <span id="profile-mode"></span></div>
      </div>
      <div class="controls">
        <button id="start-btn">Start Scanner</button>
        <button id="stop-btn" disabled>Stop Scanner</button>
      </div>
    </section>

    <section class="card" id="logs-card">
      <div id="logs-controls">
        <input id="logs-search" placeholder="Search name/email..." />
        <button id="export-btn" class="action-btn">üíæ Export</button>
        <button id="print-btn" class="action-btn">üñ®Ô∏è Print</button>
        <button id="reset-btn" class="action-btn reset-btn">üîÑ Reset Today</button>
      </div>

      <table id="logs-table" aria-live="polite">
        <thead>
          <tr>
            <th data-key="name">Name <span class="sort-arrow"></span></th>
            <th data-key="email">Email <span class="sort-arrow"></span></th>
            <th data-key="ts">Time In/Out <span class="sort-arrow"></span></th>
            <th data-key="mode">Mode <span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody id="logs-body">
          <tr><td colspan="4" class="no-records">Loading...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAmzmNMEYiBOBztFEPS_0Sbu00wyRpGfYk",
    authDomain: "dtr-for-ci.firebaseapp.com",
    databaseURL: "https://dtr-for-ci-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dtr-for-ci",
    storageBucket: "dtr-for-ci.firebasestorage.app",
    messagingSenderId: "986157220435",
    appId: "1:986157220435:web:cc8d3b92af4edd185abca6",
    measurementId: "G-FL59MT9KSZ"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const videoEl = document.getElementById('video');
  const resultDiv = document.getElementById('result');
  const profileBox = document.getElementById('profile');
  const profileName = document.getElementById('profile-name');
  const profileEmail = document.getElementById('profile-email');
  const profileMode = document.getElementById('profile-mode');

  const startBtn = document.getElementById('start-btn');
  const stopBtn = document.getElementById('stop-btn');
  const exportBtn = document.getElementById('export-btn');
  const printBtn = document.getElementById('print-btn');
  const resetBtn = document.getElementById('reset-btn');

  const logsSearch = document.getElementById('logs-search');
  const logsBody = document.getElementById('logs-body');
  const clockElem = document.getElementById('clock');

  const codeReader = new ZXing.BrowserQRCodeReader();

  let scanning = false;
  let scanCooldowns = {};
  let logsData = [];
  let currentSort = { key: 'ts', ascending: false };

  function pad(n){ return n < 10 ? '0' + n : n; }
  function todayYMD(d = new Date()){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function timeHMS(d = new Date()){ return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function updateClock(){
    const now = new Date();
    clockElem.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  }
  setInterval(updateClock, 1000);
  updateClock();

  function setResult(msg, status='info'){
    const icons = { success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' };
    resultDiv.textContent = `${icons[status]||''} ${msg}`;
    resultDiv.className = '';
    resultDiv.classList.add(`status-${status}`);
  }

  async function startScanner(){
    if (scanning) return;
    try {
      const devices = await codeReader.listVideoInputDevices();
      if (!devices || devices.length === 0) {
        setResult('No camera devices found.', 'error');
        return;
      }
      const back = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
      scanning = true;
      setResult('Point camera to a QR code.', 'info');

      codeReader.decodeFromVideoDevice(back.deviceId, videoEl, (result, err) => {
        if (result && result.getText) handleScan(result.getText());
        else if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error('ZXing error:', err);
          setResult('Camera error: ' + err.message, 'error');
        }
      });
      startBtn.disabled = true; stopBtn.disabled = false;
    } catch(e){
      console.error('startScanner', e);
      setResult('Camera error: ' + (e.message || e), 'error');
    }
  }
    function stopScanner(){
    try { codeReader.reset(); } catch(e){}
    scanning = false;
    setResult('Scanner stopped.', 'info');
    startBtn.disabled = false; stopBtn.disabled = true;
    profileBox.style.display = 'none';
  }

  async function handleScan(text){
    if (!scanning) return;
    const raw = String(text || '').trim();
    if (!raw) return;
    const now = Date.now();
    if (scanCooldowns[raw] && (now - scanCooldowns[raw] < 4000)) return;
    scanCooldowns[raw] = now;

    const parts = raw.split('|');
    if(parts.length !== 2) {
      setResult('Invalid QR format. Expected "UID|MODE".', 'error');
      profileBox.style.display = 'none';
      return;
    }

    const uid = parts[0].trim();
    const mode = parts[1].trim().toUpperCase(); // Accept lowercase

    if (!uid || (mode !== 'IN' && mode !== 'OUT')) {
      setResult('Invalid UID or Mode in QR code.', 'error');
      profileBox.style.display = 'none';
      return;
    }

    setResult(`Processing UID: ${uid} Mode: ${mode}`, 'info');
    profileBox.style.display = 'none';

    const dateStr = todayYMD();
    const timeStr = timeHMS();

    try {
      const profSnap = await get(ref(db, `users/${uid}/profile`));
      if (!profSnap.exists()){
        setResult(`UID ${uid} not registered.`, 'error');
        return;
      }
      const profile = profSnap.val();
      const dtrRef = ref(db, `users/${uid}/dtr/${dateStr}`);
      const dtrSnap = await get(dtrRef);
      const dtrData = dtrSnap.exists() ? dtrSnap.val() : {};

      if (mode === 'IN') {
        if (dtrData.timeIn) {
          setResult(`User ${profile.name} already timed IN today at ${dtrData.timeIn}`, 'warning');
          return;
        }
        await set(dtrRef, { ...dtrData, timeIn: timeStr, tsIn: Date.now() });
        await set(ref(db, `timeIns/${dateStr}/${uid}`), { uid, name: profile.name || '', email: profile.email || '', date: dateStr, time: timeStr, ts: Date.now(), mode: 'IN' });
        setResult(`Recorded TIME IN for ${profile.name} at ${timeStr}`, 'success');
        document.getElementById('success-sound').play();
      } else if (mode === 'OUT') {
        if (!dtrData.timeIn) {
          setResult(`User ${profile.name} has not timed IN yet today. Cannot TIME OUT.`, 'error');
          return;
        }
        if (dtrData.timeOut) {
          setResult(`User ${profile.name} already timed OUT today at ${dtrData.timeOut}`, 'warning');
          return;
        }
        await set(dtrRef, { ...dtrData, timeOut: timeStr, tsOut: Date.now() });
        await set(ref(db, `timeOuts/${dateStr}/${uid}`), { uid, name: profile.name || '', email: profile.email || '', date: dateStr, time: timeStr, ts: Date.now(), mode: 'OUT' });
        setResult(`Recorded TIME OUT for ${profile.name} at ${timeStr}`, 'success');
        document.getElementById('success-sound').play();
      }
    } catch(err){
      console.error('Error saving DTR:', err);
      setResult('Error saving time record: ' + (err.message || err), 'error');
      profileBox.style.display = 'none';
    }
  }

  function renderLogs(filterText=''){
    const ft = (filterText || '').toLowerCase();
    const filtered = logsData.filter(e =>
      (e.name || '').toLowerCase().includes(ft) ||
      (e.email || '').toLowerCase().includes(ft) ||
      (e.date || '').toLowerCase().includes(ft) ||
      (e.time || '').toLowerCase().includes(ft) ||
      (e.mode || '').toLowerCase().includes(ft)
    );
    if (filtered.length === 0){
      logsBody.innerHTML = '<tr><td colspan="4" class="no-records">No records</td></tr>';
      return;
    }
    logsBody.innerHTML = filtered.map(entry => {
      const timeWithDate = `${escapeHtml(entry.time)} ‚Äî ${escapeHtml(entry.date)}`;
      return `<tr>
        <td>${escapeHtml(entry.name)}</td>
        <td>${escapeHtml(entry.email)}</td>
        <td>${timeWithDate}</td>
        <td>${escapeHtml(entry.mode)}</td>
      </tr>`;
    }).join('');
  }

  function sortLogs(key, ascending){
    currentSort = { key, ascending };
    logsData.sort((a,b) => {
      if (key === 'ts') return ascending ? (a.ts || 0) - (b.ts || 0) : (b.ts || 0) - (a.ts || 0);
      const va = (a[key] || '').toString().toLowerCase();
      const vb = (b[key] || '').toString().toLowerCase();
      if (va < vb) return ascending ? -1 : 1;
      if (va > vb) return ascending ? 1 : -1;
      return 0;
    });
  }

  document.querySelectorAll('#logs-table th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-key') || 'ts';
      if (currentSort.key === key) currentSort.ascending = !currentSort.ascending;
      else currentSort = { key, ascending: true };
      sortLogs(currentSort.key, currentSort.ascending);
      renderLogs(logsSearch.value || '');
      updateSortArrows();
    });
  });

  function updateSortArrows(){
    document.querySelectorAll('#logs-table th').forEach(th => {
      const span = th.querySelector('.sort-arrow');
      if (!span) return;
      const key = th.getAttribute('data-key');
      if (key === currentSort.key) span.textContent = currentSort.ascending ? '‚ñ≤' : '‚ñº';
      else span.textContent = '';
    });
  }

  logsSearch.addEventListener('input', e => renderLogs(e.target.value || ''));

  function exportCSV(){
    if (!logsData || logsData.length === 0) { alert('No data to export'); return; }
    const headers = ['Name','Email','Time','Date','Mode'];
    const rows = logsData.map(r => [`${r.name}`, `${r.email}`, `${r.time}`, `${r.date}`, `${r.mode}`]);
    let csv = headers.join(',') + '\r\n';
    rows.forEach(cols => {
      csv += cols.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',') + '\r\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `dtr_logs_${todayYMD()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  exportBtn.addEventListener('click', exportCSV);

  function printLogs(){
    const html = `<html><head><title>DTR Logs ${todayYMD()}</title>
      <style>
        body{font-family:Arial;color:#111}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ccc;padding:6px;text-align:left}
        th{background:#eee}
      </style>
      </head><body><h2>DTR Logs ${todayYMD()}</h2>
      <table>
        <thead><tr><th>Name</th><th>Email</th><th>Time</th><th>Mode</th></tr></thead>
        <tbody>` +
        logsData.map(r => `<tr>
          <td>${escapeHtml(r.name)}</td>
          <td>${escapeHtml(r.email)}</td>
          <td>${escapeHtml(r.time)}</td>
          <td>${escapeHtml(r.mode)}</td>
        </tr>`).join('') +
      `</tbody></table></body></html>`;
    const w = window.open('', '_blank', 'width=900,height=700');
    w.document.write(html);
    w.document.close();
    w.focus();
    w.print();
  }

  printBtn.addEventListener('click', printLogs);

  async function resetToday(){
    if (!confirm('Archive today\'s logs and clear live results?')) return;
    const dateStr = todayYMD();
    const timeInsRef = ref(db, `timeIns/${dateStr}`);
    const timeOutsRef = ref(db, `timeOuts/${dateStr}`);
    const archiveRef = ref(db, `archives/${dateStr}`);
    try {
      const [insSnap, outsSnap] = await Promise.all([get(timeInsRef), get(timeOutsRef)]);
      const data = {
        timeIns: insSnap.exists() ? insSnap.val() : {},
        timeOuts: outsSnap.exists() ? outsSnap.val() : {}
      };
      if (Object.keys(data.timeIns).length === 0 && Object.keys(data.timeOuts).length === 0) {
        alert('No logs to archive for today.');
        return;
      }
      await set(archiveRef, data);
      await Promise.all([remove(timeInsRef), remove(timeOutsRef)]);
      setResult('Archived and cleared today\'s logs.', 'success');
    } catch(err){
      console.error('resetToday', err);
      setResult('Failed to reset: ' + (err.message || err), 'error');
    }
  }

  resetBtn.addEventListener('click', resetToday);

  function listenLogs(){
    const dateStr = todayYMD();
    const timeInsRef = ref(db, `timeIns/${dateStr}`);
    const timeOutsRef = ref(db, `timeOuts/${dateStr}`);
    function updateLogs(){
      Promise.all([get(timeInsRef), get(timeOutsRef)]).then(([inSnap, outSnap]) => {
        const ins = inSnap.exists() ? inSnap.val() : {};
        const outs = outSnap.exists() ? outSnap.val() : {};
        const logs = [];
        Object.values(ins).forEach(entry => logs.push({ name: entry.name, email: entry.email, date: entry.date, time: entry.time, ts: entry.ts, mode: 'IN' }));
        Object.values(outs).forEach(entry => logs.push({ name: entry.name, email: entry.email, date: entry.date, time: entry.time, ts: entry.ts, mode: 'OUT' }));
        logsData = logs;
        sortLogs(currentSort.key, currentSort.ascending);
        renderLogs(logsSearch.value || '');
      });
    }
    onValue(timeInsRef, updateLogs);
    onValue(timeOutsRef, updateLogs);
    updateLogs();
  }

  // Start everything
  startBtn.addEventListener('click', startScanner);
  stopBtn.addEventListener('click', stopScanner);
  listenLogs();

  </script>
  
    <!-- ‚úÖ Audio file for success sound -->
  <audio id="success-sound" src="Thank you.mp3" preload="auto"></audio>
</body>
</html>
