<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Clinician DTR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
  body {
    font-family: Inter, system-ui, Arial, sans-serif;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    display: flex;
    justify-content: center;
    padding: 28px;
    position: relative;
    overflow: hidden;
    min-height: 100vh;
  }

  /* Background Logo Watermark */
  body::before {
    content: "";
    position: fixed;
    top: 50%;
    left: 50%;
    width: 400px;
    height: 400px;
    background: url('https://i.imgur.com/sjdlb28.jpeg') no-repeat center center;
    background-size: cover;
    opacity: 0.08;
    transform: translate(-50%, -50%);
    z-index: 0;
  }

  /* Glassmorphism card */
  .card {
    position: relative;
    z-index: 1;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    padding: 20px;
    border-radius: 16px;
    max-width: 460px;
    width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  h1 {
    color: #2c0a34;
    margin: 0 0 12px;
    font-size: 20px;
  }

  input, select {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    margin: 8px 0;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(8px);
    color: #2c0a34;
  }

  button {
    padding: 10px 14px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s ease;
  }
  button:hover {
    opacity: 0.9;
    transform: scale(1.03);
  }

  .muted {
    color: #2c0a34;
    font-size: 13px;
    opacity: 0.8;
  }

  #qr {
    width: 180px;
    height: 180px;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(8px);
    border-radius: 12px;
    padding: 8px;
    margin: 12px auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    color: #2c0a34;
  }
  th, td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    font-size: 13px;
  }
  .row {
    display: flex;
    gap: 8px;
  }
  .linkbtn {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.4);
    color: #2c0a34;
  }
  .error {
    color: #b91c1c;
  }
  .success {
    color: #166534;
  }

  /* Settings modal */
  #settingsModal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }
  #settingsModal .modal-content {
    background: rgba(255,255,255,0.9);
    padding: 20px;
    border-radius: 12px;
    max-width: 400px;
    width: 100%;
    color: #2c0a34;
  }
  #closeModal {
    float: right;
    background: #ef4444;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
  }
  </style>
</head>
<body>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h1>Clinician - DTR</h1>
      <button id="settingsBtn" style="padding:6px 10px;font-size:13px;">⚙️ Update Info</button>
    </div>

    <div id="authArea">
      <div id="registerForm">
        <div class="muted">Create account</div>
        <input id="regName" placeholder="Full name" />
        <input id="regEmail" type="email" placeholder="Email" />
        <input id="regPass" type="password" placeholder="Password (6+ chars)" />
        <select id="regLevel" aria-label="Select Clinical Level">
          <option value="" disabled selected>Select Clinical Level</option>
          <option value="42">Clinical Level 42</option>
          <option value="41">Clinical Level 41</option>
          <option value="32">Clinical Level 32</option>
          <option value="31">Clinical Level 31</option>
        </select>
        <div class="row" style="margin-top:8px">
          <button id="registerBtn">Create Account</button>
          <button id="switchToLogin" class="linkbtn">Login</button>
        </div>
      </div>
      <div id="loginForm" style="display:none;margin-top:12px">
        <div class="muted">Login</div>
        <input id="loginEmail" type="email" placeholder="Email" />
        <input id="loginPass" type="password" placeholder="Password" />
        <div class="row" style="margin-top:8px">
          <button id="loginBtn">Login</button>
          <button id="switchToRegister" class="linkbtn">Create</button>
        </div>
      </div>
      <p id="message" class="muted" style="margin-top:12px"></p>
    </div>

    <div id="userPanel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Signed in as</div>
          <div id="nameDisplay" style="font-weight:600"></div>
          <div id="emailDisplay" class="muted"></div>
          <div id="levelDisplay" class="muted"></div>
        </div>
        <button id="logoutBtn" style="background:#ef4444;color:white;">Logout</button>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.3);margin:12px 0" />

      <div class="muted small">Your QR (show to admin to Time In)</div>
      <div id="qr" aria-hidden="true"></div>

      <div style="margin-top:12px">
        <div class="muted small">Your Time-In history</div>
        <table aria-live="polite">
          <thead><tr><th>Date</th><th>Time In</th></tr></thead>
          <tbody id="recordsBody"><tr><td colspan="2" class="muted">No records yet</td></tr></tbody>
        </table>
      </div>

      <p class="muted small" style="margin-top:10px">QR is the only way to Time In — admin scans it to record your attendance.</p>

      <div id="requestStatus" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal">
    <div class="modal-content">
      <button id="closeModal">✖</button>
      <h3>Request Profile Update</h3>

      <form class="updateRequestForm" data-field="name">
        <input type="text" placeholder="New Name" />
        <button type="submit">Request Name Change</button>
      </form>

      <form class="updateRequestForm" data-field="email">
        <input type="email" placeholder="New Email" />
        <button type="submit">Request Email Change</button>
      </form>

      <form class="updateRequestForm" data-field="password">
        <input type="password" placeholder="New Password" />
        <button type="submit">Request Password Change</button>
      </form>

      <form class="updateRequestForm" data-field="clinicalLevel">
        <select>
          <option value="">Select New Clinical Level</option>
          <option value="42">Clinical Level 42</option>
          <option value="41">Clinical Level 41</option>
          <option value="32">Clinical Level 32</option>
          <option value="31">Clinical Level 31</option>
        </select>
        <button type="submit">Request Level Change</button>
      </form>
    </div>
  </div>
  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
      authDomain: "dtr-project-66048.firebaseapp.com",
      databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dtr-project-66048",
      storageBucket: "dtr-project-66048.appspot.com",
      messagingSenderId: "271445506225",
      appId: "1:271445506225:web:fcb04d0454e1302de14a90",
      measurementId: "G-R22CLKSPCP"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // UI refs
    const registerBtn = document.getElementById('registerBtn');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const switchToLogin = document.getElementById('switchToLogin');
    const switchToRegister = document.getElementById('switchToRegister');
    const messageEl = document.getElementById('message');
    const statusEl = document.getElementById('requestStatus');

    // Modal refs
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeModal = document.getElementById('closeModal');

    // Open modal
    settingsBtn.onclick = () => {
      settingsModal.style.display = 'flex';
    };
    // Close modal
    closeModal.onclick = () => {
      settingsModal.style.display = 'none';
    };
    // Close modal if clicking outside content
    window.onclick = (e) => {
      if (e.target === settingsModal) {
        settingsModal.style.display = 'none';
      }
    };

    switchToLogin.onclick = () => {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      messageEl.textContent = '';
      messageEl.className = 'muted';
    };
    switchToRegister.onclick = () => {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
      messageEl.textContent = '';
      messageEl.className = 'muted';
    };

    // QR generator
    function generateQRCodeBase64(text) {
      return new Promise((resolve, reject) => {
        const tmp = document.createElement('div');
        tmp.style.position = 'absolute';
        tmp.style.left = '-9999px';
        document.body.appendChild(tmp);
        try {
          const qr = new QRCode(tmp, { text: text, width: 300, height: 300 });
          setTimeout(() => {
            const img = tmp.querySelector('img');
            if (img && img.src) {
              resolve(img.src);
            } else {
              const canvas = tmp.querySelector('canvas');
              if (canvas) resolve(canvas.toDataURL());
              else reject(new Error('QR generation failed'));
            }
            document.body.removeChild(tmp);
          }, 300);
        } catch (e) {
          document.body.removeChild(tmp);
          reject(e);
        }
      });
    }

    // Register
    registerBtn.onclick = async () => {
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const pass = document.getElementById('regPass').value;
      const level = document.getElementById('regLevel').value;

      if (!name || !email || !pass) {
        messageEl.textContent = 'Please fill all fields.';
        messageEl.className = 'error';
        return;
      }
      if (!level) {
        messageEl.textContent = 'Please select Clinical Level.';
        messageEl.className = 'error';
        return;
      }
      messageEl.textContent = 'Creating account...';
      messageEl.className = 'muted';

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
        const uid = userCredential.user.uid;
        const qrPayload = uid;
        const qrBase64 = await generateQRCodeBase64(qrPayload);

        await db.ref('users/' + uid + '/profile').set({
          name, email, uid,
          clinicalLevel: level,
          qrBase64,
          createdAt: new Date().toISOString()
        });

        messageEl.textContent = 'Account created and signed in.';
        messageEl.className = 'success';
      } catch (err) {
        messageEl.textContent = err.message;
        messageEl.className = 'error';
      }
    };

    // Login
    loginBtn.onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      if (!email || !pass) {
        messageEl.textContent = 'Enter email and password.';
        messageEl.className = 'error';
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        messageEl.textContent = '';
      } catch (err) {
        messageEl.textContent = err.message;
        messageEl.className = 'error';
      }
    };

    logoutBtn.onclick = () => auth.signOut();

    // Auth state
    auth.onAuthStateChanged(async user => {
      if (user) {
        document.getElementById('authArea').style.display = 'none';
        document.getElementById('userPanel').style.display = 'block';

        const profileSnap = await db.ref('users/' + user.uid + '/profile').get();
        const profile = profileSnap.exists() ? profileSnap.val() : { name: user.email, email: user.email, uid: user.uid };

        document.getElementById('nameDisplay').textContent = profile.name || profile.email;
        document.getElementById('emailDisplay').textContent = profile.email || '';
        document.getElementById('levelDisplay').textContent = profile.clinicalLevel ? `Clinical Level: ${profile.clinicalLevel}` : '';

        const qrEl = document.getElementById('qr');
        qrEl.innerHTML = '';
        if (profile.qrBase64) {
          const img = document.createElement('img');
          img.src = profile.qrBase64;
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          qrEl.appendChild(img);
        } else {
          new QRCode(qrEl, { text: user.uid, width: 168, height: 168 });
        }

        const recordsRef = db.ref('users/' + user.uid + '/dtr');
        recordsRef.off();
        recordsRef.on('value', snap => {
          const body = document.getElementById('recordsBody');
          body.innerHTML = '';
          if (!snap.exists()) {
            body.innerHTML = '<tr><td colspan="2" class="muted">No records yet</td></tr>';
            return;
          }
          const data = snap.val();
          const keys = Object.keys(data).sort().reverse();
          for (const k of keys) {
            const r = data[k];
            body.innerHTML += `<tr><td>${k}</td><td>${r.timeIn}</td></tr>`;
          }
        });
      } else {
        document.getElementById('authArea').style.display = 'block';
        document.getElementById('userPanel').style.display = 'none';
        messageEl.textContent = '';
      }
    });

    // Enter key helper
    document.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const regShown = document.getElementById('registerForm').style.display !== 'none';
        if (regShown) registerBtn.click();
        else loginBtn.click();
      }
    });

    // 🔹 One-by-one Profile Update Requests (inside modal)
    const forms = document.querySelectorAll('.updateRequestForm');
    forms.forEach(form => {
      form.onsubmit = async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) return;

        const field = form.dataset.field;
        const input = form.querySelector('input, select');
        const value = input.value.trim();

        if (!value) {
          statusEl.textContent = "Please enter/select a new " + field + ".";
          statusEl.className = "error";
          return;
        }

        const req = {
          field,
          value,
          status: "pending",
          createdAt: new Date().toISOString()
        };

        const newRef = db.ref('updateRequests/' + user.uid).push();
        await newRef.set(req);

        statusEl.textContent = `Request to change ${field} submitted. Waiting for admin approval.`;
        statusEl.className = "muted";
        form.reset();
        settingsModal.style.display = 'none'; // close after submit
      };
    });

    // Show latest request status
    auth.onAuthStateChanged(user => {
      if (user) {
        const reqRef = db.ref('updateRequests/' + user.uid);
        reqRef.on('value', snap => {
          if (!snap.exists()) {
            statusEl.textContent = "No update requests submitted yet.";
            return;
          }
          const all = snap.val();
          const keys = Object.keys(all).sort().reverse();
          const latest = all[keys[0]];
          statusEl.textContent = `Last Request → ${latest.field}: ${latest.status}`;
        });
      }
    });
  </script>
</body>
</html>
