<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #ff9ce3, #a855f7);
      color: #fff;
    }
    header {
      padding: 15px;
      background: #6a0dad;
      color: #fff;
      text-align: center;
    }
    h1,h2,h3 { margin: 0; }
    .container { padding: 20px; }
    .card {
      background: rgba(0,0,0,0.4);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: #ff9ce3;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td {
      padding: 8px;
      border: 1px solid #fff;
      text-align: center;
    }
    th { background: rgba(255,255,255,0.2); }
    video { width: 100%; max-width: 400px; border-radius: 8px; background:#000; }
    .muted { opacity: 0.8; font-size: 13px; }
    .error { color: #f87171; }
    .success { color: #4ade80; }

    /* Modals */
    .modal {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: #1e1e2f;
      padding: 20px;
      border-radius: 10px;
      max-width: 1000px;
      width: 95%;
      max-height: 90vh;
      overflow: auto;
    }
    .modal-content h2 { margin-bottom: 10px; }
    .closeBtn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      float: right;
    }
    #wheelCanvas { margin: 10px auto; display:block; border-radius:50%; background:#fff; }
  </style>
</head>
<body>
  <header>
    <h1>Clinical DTR Admin Panel</h1>
  </header>

  <div class="container">

    <!-- Scanner -->
    <div class="card">
      <h2>QR Scanner</h2>
      <div class="row">
        <button onclick="startScanner()">Start Scanner</button>
        <button onclick="stopScanner()" style="background:#ef4444;color:white;">Stop Scanner</button>
      </div>
      <video id="preview" playsinline></video>
      <p id="scanStatus" class="muted"></p>
    </div>

    <!-- Last Scan Result -->
    <div class="card" id="scanResult" style="display:none;">
      <h3>Last Scan Result</h3>
      <p><strong>Name:</strong> <span id="resName">-</span></p>
      <p><strong>Clinical Level:</strong> <span id="resLevel">-</span></p>
      <p><strong>Email:</strong> <span id="resEmail">-</span></p>
      <p><strong>Time In:</strong> <span id="resTime">-</span></p>
    </div>

    <!-- Attendance Logs -->
    <div class="card">
      <h2>Attendance Logs (Today)</h2>
      <div class="row">
        <button onclick="exportLogs()">Export</button>
        <button onclick="printLogs()">Print</button>
        <button onclick="resetLogs()">Archive & Clear</button>
        <button onclick="deleteToday()" style="background:#ef4444;color:white;">Delete Today</button>
      </div>
      <table>
        <thead><tr><th>User</th><th>Date</th><th>Time In</th></tr></thead>
        <tbody id="logsBody"><tr><td colspan="3" class="muted">No logs today</td></tr></tbody>
      </table>
    </div>

    <!-- Buttons to open modals -->
    <div class="card">
      <h2>Management</h2>
      <div class="row">
        <button id="openRequests">‚öôÔ∏è Update Requests</button>
        <button id="openBasket">üóÇ Basket</button>
        <button id="openCases">üìã Case Management</button>
      </div>
  </div>
  <!-- Requests Modal -->
    <div id="requestsModal" class="modal">
      <div class="modal-content">
        <button class="closeBtn" id="closeRequests">‚úñ</button>
        <h2>Update Requests</h2>
        <label class="muted">Filter:
          <select id="filterSelect">
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </label>
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Field</th>
              <th>Requested Value</th>
              <th>Current Value</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="requestsBody">
            <tr><td colspan="6" class="muted">No requests yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Basket Modal -->
    <div id="basketModal" class="modal">
      <div class="modal-content">
        <button class="closeBtn" id="closeBasket">‚úñ</button>
        <h2>Basket (Archived Requests)</h2>
        <div class="row">
          <button onclick="showBasket('approved')">‚úÖ Approved</button>
          <button onclick="showBasket('rejected')">‚ùå Rejected</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Field</th>
              <th>Requested</th>
              <th>Current</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="basketBody">
            <tr><td colspan="6" class="muted">Select Approved or Rejected</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Case Management Modal -->
    <div id="casesModal" class="modal">
      <div class="modal-content">
        <button class="closeBtn" id="closeCases">‚úñ</button>
        <div class="row" style="justify-content:space-between;align-items:center;">
          <h2>Case Management</h2>
          <div class="row">
            <button onclick="exportCases()">Export CSV</button>
            <button onclick="printCases()">Print</button>
            <button onclick="openArchivedCases()">View History</button>
            <button onclick="resetCases()" style="background:#ef4444;color:white;">Reset Cases</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Case Type</th>
              <th>Details</th>
              <th>Date</th>
              <th>Instructor</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="casesBody">
            <tr><td colspan="6" class="muted">No cases submitted yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Archived Cases Modal -->
    <div id="archivedCasesModal" class="modal">
      <div class="modal-content">
        <button class="closeBtn" id="closeArchivedCases">‚úñ</button>
        <h2>Archived Cases</h2>
        <div id="archivedCasesList">
          <p class="muted">Loading archived cases...</p>
        </div>
      </div>
    </div>

    <!-- Spin Wheel Modal -->
    <div id="wheelModal" class="modal">
      <div class="modal-content" style="text-align:center;">
        <button class="closeBtn" id="closeWheel">‚úñ</button>
        <h2>Spin Wheel - Assign Instructor</h2>
        <p class="muted">Type instructors separated by commas:</p>
        <input type="text" id="instructorInput" placeholder="Dr. Cruz, Dr. Santos, Dr. Lopez" style="width:100%;padding:8px;margin-bottom:10px;"/>
        <canvas id="wheelCanvas" width="300" height="300"></canvas>
        <br>
        <button onclick="spinWheel()">üé° Spin</button>
        <p id="wheelResult"></p>
      </div>
    </div>
    <!-- Libraries -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

    <script>
      // ---------- Firebase config ----------
      const firebaseConfig = {
        apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
        authDomain: "dtr-project-66048.firebaseapp.com",
        databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dtr-project-66048",
        storageBucket: "dtr-project-66048.appspot.com",
        messagingSenderId: "271445506225",
        appId: "1:271445506225:web:fcb04d0454e1302de14a90",
        measurementId: "G-R22CLKSPCP"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ---------- Helpers ----------
      const $ = id => document.getElementById(id);
      function fmt(ts){ return ts ? new Date(ts).toLocaleString() : '‚Äî'; }

      // ========== QR Scanner ==========
      let codeReader = null;
      async function startScanner() {
        try {
          if (codeReader) codeReader.reset();
          codeReader = new ZXing.BrowserQRCodeReader();
          const devices = await codeReader.listVideoInputDevices();
          if (devices.length > 0) {
            const back = devices.find(d => /back|rear/i.test(d.label)) || devices[0];
            codeReader.decodeFromVideoDevice(back.deviceId, $('preview'), (res, err) => {
              if (res) handleScan(res.getText());
            });
            $('scanStatus').textContent = "Scanner started...";
          }
        } catch (e) { $('scanStatus').textContent = "Error: " + e; }
      }
      function stopScanner() { if (codeReader) codeReader.reset(); $('preview').srcObject=null; }

      async function handleScan(uid) {
        const profileSnap = await db.ref('users/'+uid+'/profile').once('value');
        if (!profileSnap.exists()) { $('scanStatus').textContent="Unknown UID"; return; }
        const profile = profileSnap.val();
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0];
        const dtrRef = db.ref('users/'+uid+'/dtr/'+dateStr);
        const snap = await dtrRef.once('value');
        if (snap.exists() && snap.val().timeIn) {
          $('scanStatus').textContent = profile.name+" already Time-In today";
        } else {
          await dtrRef.set({ timeIn: timeStr, ts: Date.now() });
          $('scanStatus').textContent = "Recorded for "+profile.name+" at "+timeStr;
        }
        $('resName').textContent = profile.name;
        $('resLevel').textContent = profile.clinicalLevel;
        $('resEmail').textContent = profile.email;
        $('resTime').textContent = timeStr;
        $('scanResult').style.display = 'block';
        loadTodayLogs();
      }

      // ========== Attendance Logs ==========
      async function loadTodayLogs() {
        const body = $('logsBody');
        body.innerHTML='';
        const today = new Date().toISOString().split('T')[0];
        const snap = await db.ref('users').once('value');
        let has=false;
        snap.forEach(u=>{
          const prof=u.child('profile').val()||{};
          const dtr=u.child('dtr/'+today).val();
          if(dtr && dtr.timeIn){has=true;
            body.innerHTML+=`<tr><td>${prof.name||u.key}</td><td>${today}</td><td>${dtr.timeIn}</td></tr>`;
          }
        });
        if(!has) body.innerHTML='<tr><td colspan="3" class="muted">No logs today</td></tr>';
      }
      loadTodayLogs();

      function exportLogs() {
        const rows=[...$('logsBody').querySelectorAll('tr')];
        if(!rows.length) return alert("No logs");
        let csv="Name,Date,Time In\n";
        rows.forEach(r=>{
          const c=[...r.querySelectorAll('td')].map(td=>td.innerText);
          if(c.length===3) csv+=c.join(",")+"\n";
        });
        const a=document.createElement("a");
        a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
        a.download="attendance.csv";a.click();
      }
      function printLogs(){
        let html="<table><thead><tr><th>Name</th><th>Date</th><th>Time In</th></tr></thead><tbody>";
        [...$('logsBody').querySelectorAll('tr')].forEach(r=>{html+=r.outerHTML});
        html+="</tbody></table>";
        const w=window.open();w.document.write(html);w.print();
      }
      async function resetLogs(){
        if(!confirm("Archive today's logs?")) return;
        const today=new Date().toISOString().split('T')[0];
        const snap=await db.ref('users').once('value');
        const updates={};
        snap.forEach(u=>{
          const prof=u.child('profile').val()||{};
          const dtr=u.child('dtr/'+today).val();
          if(dtr) updates[`archive/attendance/${today}/${u.key}`]={...dtr,name:prof.name,email:prof.email};
        });
        await db.ref().update(updates);
        await db.ref('adminClearedLogs/'+today).set(true);
        loadTodayLogs();
      }
      async function deleteToday(){
        if(!confirm("Delete today's records for ALL users?")) return;
        const today=new Date().toISOString().split('T')[0];
        const snap=await db.ref('users').once('value');
        const updates={};
        snap.forEach(u=>updates[`users/${u.key}/dtr/${today}`]=null);
        await db.ref().update(updates);
        loadTodayLogs();
      }

      // ========== Requests ==========
      const requestsModal=$('requestsModal');
      $('openRequests').onclick=()=>{requestsModal.style.display='flex';loadRequests();};
      $('closeRequests').onclick=()=>requestsModal.style.display='none';
      window.onclick=e=>{if(e.target===requestsModal)requestsModal.style.display='none';};

      async function loadRequests(){
        const body=$('requestsBody');body.innerHTML='';
        const snap=await db.ref('updateRequests').once('value');
        if(!snap.exists()){body.innerHTML='<tr><td colspan="6">No requests</td></tr>';return;}
        snap.forEach(u=>{
          u.forEach(r=>{
            const v=r.val();const uid=u.key;
            db.ref('users/'+uid+'/profile').once('value').then(p=>{
              const prof=p.val()||{};
              body.innerHTML+=`<tr>
                <td>${prof.name||uid}</td>
                <td>${v.field}</td>
                <td>${v.value}</td>
                <td>${prof[v.field]||''}</td>
                <td>${v.status||'pending'}</td>
                <td>
                  <button onclick="approveReq('${uid}','${r.key}','${v.field}','${encodeURIComponent(v.value)}')">Approve</button>
                  <button onclick="rejectReq('${uid}','${r.key}')">Reject</button>
                </td></tr>`;
            });
          });
        });
      }
      async function approveReq(uid,rid,field,enc){
        const val=decodeURIComponent(enc);
        await db.ref('users/'+uid+'/profile/'+field).set(val);
        const req=await db.ref('updateRequests/'+uid+'/'+rid).once('value');
        const p=await db.ref('users/'+uid+'/profile').once('value');
        await db.ref('basket/approved/'+rid).set({...req.val(),uid,name:p.val().name,email:p.val().email,status:'approved',ts:Date.now()});
        await db.ref('updateRequests/'+uid+'/'+rid).remove();
      }
      async function rejectReq(uid,rid){
        const req=await db.ref('updateRequests/'+uid+'/'+rid).once('value');
        const p=await db.ref('users/'+uid+'/profile').once('value');
        await db.ref('basket/rejected/'+rid).set({...req.val(),uid,name:p.val().name,email:p.val().email,status:'rejected',ts:Date.now()});
        await db.ref('updateRequests/'+uid+'/'+rid).remove();
      }

      // ========== Basket ==========
      const basketModal=$('basketModal');
      $('openBasket').onclick=()=>{basketModal.style.display='flex';showBasket('approved');};
      $('closeBasket').onclick=()=>basketModal.style.display='none';
      async function showBasket(type){
        const snap=await db.ref('basket/'+type).once('value');
        const body=$('basketBody');body.innerHTML='';
        if(!snap.exists()){body.innerHTML='<tr><td colspan="6">Empty</td></tr>';return;}
        snap.forEach(r=>{
          const v=r.val();
          body.innerHTML+=`<tr>
            <td>${v.name}</td><td>${v.field}</td><td>${v.value}</td><td>${v.currentValue||''}</td>
            <td>${v.status}</td><td>${fmt(v.ts)}</td></tr>`;
        });
      }

      // ========== Case Management ==========
      const casesModal=$('casesModal');
      $('openCases').onclick=()=>{casesModal.style.display='flex';loadCases();};
      $('closeCases').onclick=()=>casesModal.style.display='none';

      async function loadCases(){
        const body=$('casesBody');body.innerHTML='';
        const snap=await db.ref('cases').once('value');
        if(!snap.exists()){body.innerHTML='<tr><td colspan="6">No cases</td></tr>';return;}
        const profs={};
        await Promise.all(snap.val() ? Object.keys(snap.val()).map(async uid=>{
          const p=await db.ref('users/'+uid+'/profile').once('value');
          profs[uid]=p.val()||{};
        }):[]);
        snap.forEach(u=>{
          u.forEach(c=>{
            const v=c.val();const uid=u.key;
            const name=profs[uid]?.name||uid;
            const date=v.timestamp?new Date(v.timestamp).toLocaleString():'-';
            body.innerHTML+=`<tr>
              <td>${name}</td><td>${v.type}</td><td>${v.details}</td><td>${date}</td>
              <td id="instr-${uid}-${c.key}">${v.instructor||'Pending'}</td>
              <td>
                <button onclick="openWheelAssign('${uid}','${c.key}')">Assign Instructor</button>
                <button onclick="markCaseComplete('${uid}','${c.key}')">Mark Complete</button>
              </td></tr>`;
          });
        });
      }
      async function markCaseComplete(uid,cid){
        await db.ref(`cases/${uid}/${cid}/status`).set('completed');
        loadCases();
      }
      async function exportCases(){
        const snap=await db.ref('cases').once('value');
        if(!snap.exists()) return alert("No cases");
        let csv="Name,Case Type,Details,Date,Instructor\n";
        snap.forEach(u=>{
          u.forEach(c=>{
            const v=c.val();
            csv+=`${v.patientName||u.key},${v.type},${(v.details||'').replace(/\n/g,' ')},${fmt(v.timestamp)},${v.instructor||''}\n`;
          });
        });
        const a=document.createElement("a");
        a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
        a.download="cases.csv";a.click();
      }
      function printCases(){
        const rows=[...$('casesBody').querySelectorAll('tr')];
        let html="<table><thead><tr><th>Name</th><th>Case Type</th><th>Details</th><th>Date</th><th>Instructor</th></tr></thead><tbody>";
        rows.forEach(r=>{
          const c=[...r.querySelectorAll('td')];if(c.length>=5){
            html+="<tr>"+c.slice(0,5).map(td=>"<td>"+td.innerText+"</td>").join("")+"</tr>";
          }
        });
        html+="</tbody></table>";const w=window.open();w.document.write(html);w.print();
      }
      async function resetCases(){
        if(!confirm("Archive and clear all cases?")) return;
        const today=new Date().toISOString().split('T')[0];
        const snap=await db.ref('cases').once('value');
        if(!snap.exists()) return;
        const updates={};
        snap.forEach(u=>{
          u.forEach(c=>{
            updates[`archive/cases/${today}/${u.key}/${c.key}`]={...c.val(),realName:u.key,archivedAt:Date.now()};
          });
        });
        await db.ref().update(updates);await db.ref('cases').remove();loadCases();
      }

      // ========== Archived Cases ==========
      const archivedCasesModal=$('archivedCasesModal');
      $('closeArchivedCases').onclick=()=>archivedCasesModal.style.display='none';
      function openArchivedCases(){archivedCasesModal.style.display='flex';loadArchivedCases();}
      async function loadArchivedCases(){
        const div=$('archivedCasesList');div.innerHTML='';
        const snap=await db.ref('archive/cases').once('value');
        if(!snap.exists()){div.innerHTML='<p>No archives</p>';return;}
        snap.forEach(d=>{
          div.innerHTML+=`<h3>${d.key}</h3>`;
          d.forEach(u=>{
            u.forEach(c=>{
              const v=c.val();
              div.innerHTML+=`<p><b>${v.realName||u.key}</b> - ${v.type} - ${v.details} - ${fmt(v.timestamp)} - ${v.instructor||''}</p>`;
            });
          });
        });
      }

      // ========== Spin Wheel ==========
      const wheelModal=$('wheelModal');
      $('closeWheel').onclick=()=>wheelModal.style.display='none';
      let selectedCase=null;
      function openWheelAssign(uid,cid){selectedCase={uid,cid};wheelModal.style.display='flex';drawWheel([]);}
      const ctx=$('wheelCanvas').getContext('2d');
      function drawWheel(names){
        const canvas=$('wheelCanvas');const cx=150,cy=150,r=140;
        ctx.clearRect(0,0,300,300);
        if(!names.length){ctx.fillText("Enter names above",100,150);return;}
        const seg=2*Math.PI/names.length;
        names.forEach((n,i)=>{
          ctx.beginPath();ctx.moveTo(cx,cy);
          ctx.arc(cx,cy,r,i*seg,(i+1)*seg);ctx.fillStyle=`hsl(${i*360/names.length},70%,60%)`;ctx.fill();
          ctx.save();ctx.translate(cx,cy);ctx.rotate(i*seg+seg/2);ctx.fillStyle="#000";ctx.fillText(n,80,0);ctx.restore();
        });
      }
      function spinWheel(){
        const names=$('instructorInput').value.split(',').map(s=>s.trim()).filter(Boolean);
        if(!names.length) return alert("Enter instructors");
        drawWheel(names);
        const winner=names[Math.floor(Math.random()*names.length)];
        $('wheelResult').textContent="Selected: "+winner;
        if(selectedCase) assignInstructorToCase(winner);
      }
      async function assignInstructorToCase(name){
        const {uid,cid}=selectedCase;
        await db.ref(`cases/${uid}/${cid}/instructor`).set(name);
        await db.ref(`cases/${uid}/${cid}/status`).set('assigned');
        document.getElementById(`instr-${uid}-${cid}`).textContent=name;
      }
    </script>
  </body>
</html>
