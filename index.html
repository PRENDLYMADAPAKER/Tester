<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#111; color:#fff; }
    .sidebar { width:220px; background:#222; height:100vh; float:left; padding-top:20px; }
    .sidebar button { display:block; width:100%; padding:12px; border:none; background:none; color:#fff; text-align:left; cursor:pointer; }
    .sidebar button.active, .sidebar button:hover { background:#444; }
    .content { margin-left:220px; padding:20px; }
    h2 { margin-top:0; }
    table { width:100%; border-collapse: collapse; margin-top:10px; background:#1c1c1c; }
    th, td { border:1px solid #333; padding:8px; text-align:center; }
    th { background:#333; }
    button.primary { background:#a855f7; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; }
    button.primary:hover { background:#9333ea; }
    .muted { color:#aaa; }
    .card { background:#1e1e1e; padding:15px; margin-bottom:20px; border-radius:8px; }
    #preview { width:100%; max-width:480px; background:#000; }
    #scanResult { display:none; margin-top:10px; }
    .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:1000; }
    .modal-content { background:#1e1e1e; padding:20px; border-radius:10px; max-width:600px; width:90%; color:#fff; }
    canvas { background:#111; border-radius:50%; }
  </style>
</head>
<body>
  <div class="sidebar">
    <button id="sidebarScanner" class="active">Scanner</button>
    <button id="sidebarLogs">Attendance Logs</button>
    <button id="sidebarRequests">Update Requests</button>
    <button id="sidebarBasket">Basket</button>
    <button id="sidebarCases">Case Selections</button>
    <button id="sidebarInstructors">Instructors</button>
  </div>

  <div class="content">
    <!-- Scanner Section -->
    <div id="scannerCard" class="card">
      <h2>QR Scanner</h2>
      <video id="preview" autoplay></video>
      <p id="scanStatus">Ready to scan</p>
      <div id="scanResult" class="card">
        <h3>Scan Result</h3>
        <p><b>Name:</b> <span id="resName"></span></p>
        <p><b>Level:</b> <span id="resLevel"></span></p>
        <p><b>Email:</b> <span id="resEmail"></span></p>
        <p><b>Time In:</b> <span id="resTime"></span></p>
      </div>
      <button class="primary" onclick="startScanner()">Start Scanner</button>
      <button class="primary" onclick="stopScanner()">Stop Scanner</button>
      <audio id="success-sound" src="https://www.soundjay.com/buttons/beep-07.wav" preload="auto"></audio>
    </div>
    <!-- Attendance Logs -->
    <div id="logsSection" class="card" style="display:none">
      <h2>Attendance Logs</h2>
      <div>
        <button class="primary" onclick="refreshLogsView()">Refresh</button>
        <button class="primary" onclick="exportLogs()">Export</button>
        <button class="primary" onclick="printLogs()">Print</button>
      </div>
      <table>
        <thead><tr><th>Name</th><th>Date</th><th>Time In</th></tr></thead>
        <tbody id="logsBody"></tbody>
      </table>
    </div>

    <!-- Update Requests -->
    <div id="requestsSection" class="card" style="display:none">
      <h2>Update Requests</h2>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Value</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="requestsBody"></tbody>
      </table>
    </div>

    <!-- Basket -->
    <div id="basketSection" class="card" style="display:none">
      <h2>Basket</h2>
      <div>
        <button class="primary" onclick="showBasket('approved')">Approved</button>
        <button class="primary" onclick="showBasket('rejected')">Rejected</button>
      </div>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Value</th><th>Status</th></tr></thead>
        <tbody id="basketBody"></tbody>
      </table>
    </div>

    <!-- Case Selections -->
    <div id="casesSection" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Case Selections</h2>
        <div>
          <button class="primary" onclick="loadCases()">Refresh</button>
          <button class="primary" onclick="exportCases()">Export</button>
          <button class="primary" onclick="printCases()">Print</button>
        </div>
      </div>
      <table>
        <thead>
          <tr><th>Clinician</th><th>Type</th><th>Details</th><th>Instructor</th><th>Date</th><th>Action</th></tr>
        </thead>
        <tbody id="casesBody"></tbody>
      </table>
    </div>
    <!-- Instructor Quick Panel -->
    <div id="instructorsPanel" class="card" style="display:none">
      <h2>Instructors (Quick)</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <input id="newInstructorName" placeholder="Dr. Name" style="padding:8px;border-radius:6px;border:1px solid #333;background:#111;color:#fff;"/>
        <button id="addInstructorBtn" class="primary">Add</button>
        <button id="openInstructorsModal" class="primary">Open Management</button>
      </div>
      <table>
        <thead><tr><th>Instructor</th><th>Action</th></tr></thead>
        <tbody id="instructorsBody"></tbody>
      </table>
    </div>

    <!-- Instructors Management Modal -->
    <div id="instructorsModal" class="modal">
      <div class="modal-content">
        <button class="closeBtn" id="closeInstructors">✖</button>
        <h2>Instructor Management</h2>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
          <input id="modalNewInstructorName" placeholder="Dr. Name" style="padding:8px;border-radius:6px;border:1px solid #333;background:#111;color:#fff;flex:1"/>
          <button id="modalAddInstructorBtn" class="primary">Add Instructor</button>
        </div>
        <table>
          <thead><tr><th>Instructor</th><th>Action</th></tr></thead>
          <tbody id="modalInstructorsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Wheel Modal (already referenced in Part 2; re-stating for clarity) -->
    <div id="wheelModal" class="modal">
      <div class="modal-content" style="text-align:center;">
        <button class="closeBtn" id="closeWheel">✖</button>
        <h2>Assign Instructor — Spin the Wheel</h2>
        <p class="muted">The wheel uses the current instructor list.</p>
        <div style="display:flex;justify-content:center;margin:12px 0;">
          <canvas id="wheelCanvas" width="560" height="560" style="max-width:100%;"></canvas>
        </div>
        <div style="margin-top:8px;">
          <button id="spinWheelBtn" class="primary">Spin</button>
          <button id="confirmAssignBtn" class="primary" style="display:none;margin-left:8px">Confirm Assign</button>
        </div>
        <p id="wheelResult" class="muted" style="margin-top:10px"></p>
      </div>
    </div>

    <!-- small footer spacing -->
    <div style="height:40px"></div>
  </div> <!-- end content -->
</body>
<!-- Part 4: JavaScript - paste last -->
<script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<script>
/* ========== CONFIG ========== */
/* Replace with your config already used in clinician file (kept same here) */
const firebaseConfig = {
  apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
  authDomain: "dtr-project-66048.firebaseapp.com",
  databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dtr-project-66048",
  storageBucket: "dtr-project-66048.appspot.com",
  messagingSenderId: "271445506225",
  appId: "1:271445506225:web:fcb04d0454e1302de14a90"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========== HELPERS ========== */
const $id = id => document.getElementById(id);
const fmtDate = ts => ts ? new Date(ts).toLocaleString() : '-';

/* ========== QR SCANNER (ZXing) ========== */
const codeReader = new ZXing.BrowserQRCodeReader();
const preview = $id('preview');
const scanStatus = $id('scanStatus');

async function startScanner(){
  try {
    const devices = await codeReader.listVideoInputDevices();
    if(!devices || devices.length === 0){ scanStatus.textContent = "No camera available"; return; }
    const back = devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[0];
    codeReader.decodeFromVideoDevice(back.deviceId, preview, (result, err) => {
      if(result && result.getText) handleScan(result.getText());
    });
    scanStatus.textContent = "Scanner started";
  } catch(e){
    console.error(e);
    scanStatus.textContent = "Scanner error: " + (e.message||e);
  }
}
function stopScanner(){ try{ codeReader.reset(); }catch(e){} try{ preview.srcObject = null; }catch(e){} scanStatus.textContent = "Scanner stopped"; }

async function handleScan(uid){
  try {
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const timeStr = now.toTimeString().split(' ')[0];
    const dtrRef = db.ref(`users/${uid}/dtr/${dateStr}`);
    const snap = await dtrRef.get();
    const profileSnap = await db.ref(`users/${uid}/profile`).get();
    const profile = profileSnap.exists() ? profileSnap.val() : {};

    if(snap.exists() && snap.val().timeIn){
      $id('resName').textContent = profile.name || uid;
      $id('resLevel').textContent = profile.clinicalLevel || '-';
      $id('resEmail').textContent = profile.email || '-';
      $id('resTime').textContent = snap.val().timeIn;
      $id('scanResult').style.display = 'block';
      scanStatus.textContent = `${profile.name || uid} already Time-In at ${snap.val().timeIn}`;
      return;
    }

    await dtrRef.set({ timeIn: timeStr });
    $id('resName').textContent = profile.name || uid;
    $id('resLevel').textContent = profile.clinicalLevel || '-';
    $id('resEmail').textContent = profile.email || '-';
    $id('resTime').textContent = timeStr;
    $id('scanResult').style.display = 'block';
    scanStatus.textContent = `Recorded ${profile.name || uid} at ${timeStr}`;
    try{ $id('success-sound')?.play().catch(()=>{}); }catch(e){}
  } catch(err){
    console.error('handleScan', err);
    scanStatus.textContent = 'Scan error: ' + (err.message||err);
  }
}

/* ========== Attendance Logs ========== */
let todayLogs = [];
async function refreshLogsView(){
  const logsBody = $id('logsBody');
  logsBody.innerHTML = '';
  todayLogs = [];
  const today = new Date().toISOString().split('T')[0];
  const usersSnap = await db.ref('users').get();
  if(!usersSnap.exists()){ logsBody.innerHTML = '<tr><td colspan="3" class="muted">No users</td></tr>'; return; }
  let has=false;
  usersSnap.forEach(uSnap => {
    const profile = uSnap.child('profile').val() || {};
    const dtr = uSnap.child(`dtr/${today}`).val();
    if(dtr && dtr.timeIn){
      has = true;
      todayLogs.push({ name: profile.name || uSnap.key, date: today, timeIn: dtr.timeIn });
      logsBody.innerHTML += `<tr><td>${profile.name || uSnap.key}</td><td>${today}</td><td>${dtr.timeIn}</td></tr>`;
    }
  });
  if(!has) logsBody.innerHTML = '<tr><td colspan="3" class="muted">No logs today</td></tr>';
}
async function exportLogs(){
  if(todayLogs.length === 0) return alert('No logs to export');
  let csv = "Name,Date,Time In\n";
  todayLogs.forEach(r => csv += `"${r.name.replace(/"/g,'""')}",${r.date},${r.timeIn}\n`);
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'attendance_logs_today.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function printLogs(){
  if(todayLogs.length === 0) return alert('No logs to print');
  const html = `<html><head><title>Attendance Logs</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #333;padding:8px;text-align:center}</style></head><body><h2>Attendance Logs</h2><table><thead><tr><th>Name</th><th>Date</th><th>Time In</th></tr></thead><tbody>${todayLogs.map(r=>`<tr><td>${r.name}</td><td>${r.date}</td><td>${r.timeIn}</td></tr>`).join('')}</tbody></table></body></html>`;
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); w.print();
}

/* ========== Update Requests & Basket ========== */
const requestsBody = $id('requestsBody'), basketBody = $id('basketBody');
const filterSelect = null; // simple version; show all
db.ref('updateRequests').on('value', snap => {
  requestsBody.innerHTML = '';
  if(!snap.exists()){ requestsBody.innerHTML = '<tr><td colspan="5" class="muted">No requests</td></tr>'; return; }
  const rows = [];
  snap.forEach(userSnap => {
    const uid = userSnap.key;
    userSnap.forEach(reqSnap => {
      const req = reqSnap.val();
      rows.push({ uid, id: reqSnap.key, req });
    });
  });
  if(rows.length === 0){ requestsBody.innerHTML = '<tr><td colspan="5" class="muted">No requests</td></tr>'; return; }
  rows.forEach(async r => {
    const profileSnap = await db.ref(`users/${r.uid}/profile`).get();
    const profile = profileSnap.exists() ? profileSnap.val() : {};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${profile.name || r.uid}<br><span class="muted">${profile.email||''}</span></td>
      <td>${r.req.field}</td><td>${r.req.value}</td><td>${r.req.status||'pending'}</td>
      <td>
        <button class="primary" onclick="approveReq('${r.uid}','${r.id}','${r.req.field}','${encodeURIComponent(r.req.value)}')">Approve</button>
        <button class="primary" onclick="rejectReq('${r.uid}','${r.id}')">Reject</button>
      </td>`;
    requestsBody.appendChild(tr);
  });
});

async function approveReq(uid, reqId, field, encodedValue){
  try {
    const value = decodeURIComponent(encodedValue);
    if(['name','email','clinicalLevel'].includes(field)) await db.ref(`users/${uid}/profile/${field}`).set(value);
    const reqSnap = await db.ref(`updateRequests/${uid}/${reqId}`).get();
    const reqData = reqSnap.exists() ? reqSnap.val() : {};
    const profileSnap = await db.ref(`users/${uid}/profile`).get();
    const profile = profileSnap.exists() ? profileSnap.val() : {};
    await db.ref(`basket/approved/${reqId}`).set({ ...reqData, uid, name: profile.name||uid, email: profile.email||'', status:'approved', ts: Date.now() });
    await db.ref(`updateRequests/${uid}/${reqId}`).remove();
  } catch(e){ console.error(e); alert('Approve failed'); }
}
async function rejectReq(uid, reqId){
  try {
    const reqSnap = await db.ref(`updateRequests/${uid}/${reqId}`).get();
    const reqData = reqSnap.exists() ? reqSnap.val() : {};
    const profileSnap = await db.ref(`users/${uid}/profile`).get();
    const profile = profileSnap.exists() ? profileSnap.val() : {};
    await db.ref(`basket/rejected/${reqId}`).set({ ...reqData, uid, name: profile.name||uid, email: profile.email||'', status:'rejected', ts: Date.now() });
    await db.ref(`updateRequests/${uid}/${reqId}`).remove();
  } catch(e){ console.error(e); alert('Reject failed'); }
}

function showBasket(type){
  const node = type === 'approved' ? db.ref('basket/approved') : db.ref('basket/rejected');
  node.get().then(snap => {
    if(!snap.exists()) { basketBody.innerHTML = `<tr><td colspan="4" class="muted">No ${type}</td></tr>`; return; }
    const rows = [];
    snap.forEach(child => {
      const v = child.val();
      rows.push(`<tr><td>${v.name||''}<br><span class="muted">${v.email||''}</span></td><td>${v.field||''}</td><td>${v.value||''}</td><td>${v.status||''}</td></tr>`);
    });
    basketBody.innerHTML = rows.join('');
  });
}

/* ========== Case Selections ========== */
const casesBody = $id('casesBody');

// loadCases: renders table with Assign buttons that use data attributes (safe)
async function loadCases(){
  casesBody.innerHTML = '<tr><td colspan="6" class="muted">Loading...</td></tr>';
  const snap = await db.ref('cases').get();
  if(!snap.exists()){ casesBody.innerHTML = '<tr><td colspan="6" class="muted">No cases found</td></tr>'; return; }
  const data = snap.val();
  const uids = Object.keys(data);
  // fetch profiles
  const pr = uids.map(uid => db.ref(`users/${uid}/profile`).get().then(p=>({ uid, profile: p.exists() ? p.val() : {} })));
  const profiles = await Promise.all(pr);
  const profileMap = {}; profiles.forEach(p => profileMap[p.uid] = p.profile || {});
  const rows = [];
  uids.forEach(uid => {
    const userCases = data[uid] || {};
    Object.keys(userCases).forEach(caseId => {
      const c = userCases[caseId];
      rows.push({
        uid, caseId,
        clinician: profileMap[uid].name || uid,
        type: c.type || '',
        details: c.details || '',
        instructor: c.instructor || 'Pending',
        date: c.timestamp || null
      });
    });
  });
  casesBody.innerHTML = rows.map(r => `<tr>
    <td>${r.clinician}</td>
    <td>${r.type}</td>
    <td class="left">${r.details}</td>
    <td>${r.instructor}</td>
    <td>${r.date ? new Date(r.date).toLocaleString() : '-'}</td>
    <td>${r.instructor === 'Pending' ? `<button class="primary assignBtn" data-uid="${r.uid}" data-caseid="${r.caseId}">Assign Instructor</button>` : '—'}</td>
  </tr>`).join('');
}

// exportCases -> CSV
async function exportCases(){
  const snap = await db.ref('cases').get();
  if(!snap.exists()) return alert('No cases to export');
  const data = snap.val();
  const uids = Object.keys(data);
  const pr = uids.map(uid => db.ref(`users/${uid}/profile`).get().then(p=>({ uid, profile: p.exists() ? p.val() : {} })));
  const profiles = await Promise.all(pr);
  const profileMap = {}; profiles.forEach(p => profileMap[p.uid] = p.profile || {});
  const rows = [['Clinician','Type','Details','Instructor','Date']];
  uids.forEach(uid => {
    const userCases = data[uid] || {};
    Object.keys(userCases).forEach(caseId => {
      const c = userCases[caseId];
      rows.push([profileMap[uid].name || uid, c.type||'', (c.details||'').replace(/\n/g,' '), c.instructor||'Pending', c.timestamp ? new Date(c.timestamp).toLocaleString() : '']);
    });
  });
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'case_selections.csv'; a.click(); URL.revokeObjectURL(a.href);
}

// printCases
async function printCases(){
  const snap = await db.ref('cases').get();
  if(!snap.exists()) return alert('No cases to print');
  const data = snap.val();
  const uids = Object.keys(data);
  const pr = uids.map(uid => db.ref(`users/${uid}/profile`).get().then(p=>({ uid, profile: p.exists() ? p.val() : {} })));
  const profiles = await Promise.all(pr);
  const profileMap = {}; profiles.forEach(p => profileMap[p.uid] = p.profile || {});
  const rows = [];
  uids.forEach(uid => {
    const userCases = data[uid] || {};
    Object.keys(userCases).forEach(caseId => {
      const c = userCases[caseId];
      rows.push({ clinician: profileMap[uid].name || uid, type: c.type||'', details: (c.details||'').replace(/\n/g,' '), instructor: c.instructor||'Pending', date: c.timestamp ? new Date(c.timestamp).toLocaleString() : '' });
    });
  });
  const html = `<html><head><title>Case Selections</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #333;padding:8px;text-align:left}th{background:#f3f3f3}</style></head><body><h2>Case Selections</h2><table><thead><tr><th>Clinician</th><th>Type</th><th>Details</th><th>Instructor</th><th>Date</th></tr></thead><tbody>${rows.map(r=>`<tr><td>${r.clinician}</td><td>${r.type}</td><td>${r.details}</td><td>${r.instructor}</td><td>${r.date}</td></tr>`).join('')}</tbody></table></body></html>`;
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); w.print();
}

/* ========== Instructor Management ========== */
async function loadInstructors(){
  const tbody = $id('instructorsBody');
  const modalTbody = $id('modalInstructorsBody');
  tbody.innerHTML = '<tr><td colspan="2" class="muted">Loading...</td></tr>'; modalTbody.innerHTML = '<tr><td colspan="2" class="muted">Loading...</td></tr>';
  const snap = await db.ref('instructors').get();
  tbody.innerHTML = ''; modalTbody.innerHTML = '';
  if(!snap.exists()){ tbody.innerHTML = '<tr><td colspan="2" class="muted">No instructors</td></tr>'; modalTbody.innerHTML = '<tr><td colspan="2" class="muted">No instructors</td></tr>'; return; }
  snap.forEach(child => {
    const id = child.key, name = child.val();
    const row = `<tr><td style="text-align:left">${name}</td><td><button class="primary" onclick="removeInstructor('${id}')">Remove</button></td></tr>`;
    tbody.innerHTML += row; modalTbody.innerHTML += row;
  });
}
async function addInstructor(name){
  if(!name) return alert('Enter a name');
  await db.ref('instructors').push(name);
  await loadInstructors();
}
async function removeInstructor(id){
  if(!confirm('Remove this instructor?')) return;
  await db.ref(`instructors/${id}`).remove();
  await loadInstructors();
}
$id('addInstructorBtn').onclick = ()=>{ const n = $id('newInstructorName').value.trim(); if(n){ addInstructor(n); $id('newInstructorName').value=''; } };
$id('modalAddInstructorBtn').onclick = ()=>{ const n = $id('modalNewInstructorName').value.trim(); if(n){ addInstructor(n); $id('modalNewInstructorName').value=''; } };
$id('openInstructorsModal').onclick = ()=>{ loadInstructors().then(()=> $id('instructorsModal').style.display = 'flex'); };
$id('closeInstructors').onclick = ()=> $id('instructorsModal').style.display = 'none';

/* ========== Spin-the-Wheel ========== */
const wheelCanvas = $id('wheelCanvas');
const ctx = wheelCanvas.getContext('2d');
let wheelNames = [];
let wheelCaseUid = null, wheelCaseId = null;
let isSpinning = false;
let currentRotation = 0;

function fitWheelCanvas(){
  const canvas = wheelCanvas;
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const size = Math.min(rect.width, 560);
  canvas.width = Math.floor(size * dpr);
  canvas.height = Math.floor(size * dpr);
  canvas.style.width = size + 'px';
  canvas.style.height = size + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

function safeDrawWheel(rotation){
  try { drawWheel(rotation); } catch(e){ console.error('drawWheel error', e); }
}

async function openWheel(uid, caseId){
  wheelCaseUid = uid; wheelCaseId = caseId;
  $id('wheelResult').textContent = ''; $id('confirmAssignBtn').style.display = 'none';
  const snap = await db.ref('instructors').get();
  wheelNames = [];
  if(snap.exists()) snap.forEach(c => wheelNames.push(c.val()));
  if(wheelNames.length === 0){ alert('No instructors available. Add instructors first.'); return; }
  fitWheelCanvas();
  currentRotation = 0;
  safeDrawWheel(0);
  $id('wheelModal').style.display = 'flex';
}

function drawWheel(rotation){
  const canvas = wheelCanvas;
  const w = canvas.width / (window.devicePixelRatio || 1);
  const h = canvas.height / (window.devicePixelRatio || 1);
  const cx = w/2, cy = h/2;
  const r = Math.min(cx, cy) - 8;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const n = Math.max(1, wheelNames.length);
  const arc = (2*Math.PI)/n;
  for(let i=0;i<n;i++){
    const start = i*arc + rotation;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,start+arc);
    ctx.closePath();
    ctx.fillStyle = i%2===0 ? '#ff9ce3' : '#a855f7';
    ctx.fill();
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(start + arc/2);
    ctx.textAlign = 'right';
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 16px Arial';
    const txt = wheelNames[i];
    const label = txt.length > 28 ? txt.slice(0,25) + '…' : txt;
    ctx.fillText(label, r - 10, 6);
    ctx.restore();
  }
  // pointer
  ctx.fillStyle = '#222';
  ctx.beginPath();
  ctx.moveTo(cx - 12, cy - r - 8);
  ctx.lineTo(cx + 12, cy - r - 8);
  ctx.lineTo(cx, cy - r + 22);
  ctx.closePath(); ctx.fill();
}

function spinWheel(){
  if(isSpinning) return;
  if(!wheelNames.length) return alert('No instructors to pick.');
  isSpinning = true;
  $id('wheelResult').textContent = 'Spinning...'; $id('confirmAssignBtn').style.display = 'none';
  const n = wheelNames.length;
  const arc = (2*Math.PI)/n;
  const finalIndex = Math.floor(Math.random()*n);
  const rotations = 6 + Math.floor(Math.random()*4);
  const finalAngle = (2*Math.PI*rotations) + ((n - finalIndex) * arc) - (arc/2);
  const duration = 3600;
  const startTime = performance.now();
  const startRotation = currentRotation || 0;

  function animate(now){
    const t = Math.min(1, (now - startTime)/duration);
    const ease = 1 - Math.pow(1 - t, 3);
    currentRotation = startRotation + (finalAngle - startRotation)*ease;
    safeDrawWheel(currentRotation);
    if(t < 1) requestAnimationFrame(animate);
    else {
      isSpinning = false;
      const normalized = ((currentRotation % (2*Math.PI)) + (2*Math.PI)) % (2*Math.PI);
      const idx = Math.floor((2*Math.PI - normalized + (arc/2))/arc) % n;
      const selected = wheelNames[idx];
      $id('wheelResult').textContent = 'Selected: ' + selected;
      $id('confirmAssignBtn').style.display = 'inline-block';
      $id('confirmAssignBtn').dataset.selected = selected;
    }
  }
  requestAnimationFrame(animate);
}
$id('spinWheelBtn').onclick = spinWheel;

$id('confirmAssignBtn').onclick = async function(){
  const selected = this.dataset.selected;
  if(!selected) return alert('Nothing selected');
  if(!wheelCaseUid || !wheelCaseId) return alert('No case selected');
  try{
    await db.ref(`cases/${wheelCaseUid}/${wheelCaseId}/instructor`).set(selected);
    $id('wheelModal').style.display = 'none';
    await loadCases();
    alert(`Assigned ${selected}`);
  } catch(e){ console.error(e); alert('Assign failed'); }
};
$id('closeWheel').onclick = ()=> $id('wheelModal').style.display = 'none';

/* ========== Event Delegation for Assign buttons ========== */
document.addEventListener('click', function(e){
  const btn = e.target.closest('.assignBtn');
  if(!btn) return;
  const uid = btn.dataset.uid;
  const caseId = btn.dataset.caseid;
  if(!uid || !caseId){ console.error('assignBtn missing data', btn); return; }
  openWheel(uid, caseId);
});

/* ========== Sidebar & Modal controls ========== */
$id('sidebarScanner').onclick = ()=> { hideAllSections(); $id('scannerCard').style.display = 'block'; setActive('sidebarScanner'); };
$id('sidebarLogs').onclick = ()=> { hideAllSections(); $id('logsSection').style.display = 'block'; refreshLogsView(); setActive('sidebarLogs'); };
$id('sidebarRequests').onclick = ()=> { hideAllSections(); $id('requestsSection').style.display = 'block'; setActive('sidebarRequests'); };
$id('sidebarRequests').onclick = ()=> { hideAllSections(); $id('requestsSection').style.display = 'block'; setActive('sidebarRequests'); };
$id('sidebarBasket').onclick = ()=> { hideAllSections(); $id('basketSection').style.display = 'block'; setActive('sidebarBasket'); };
$id('sidebarCases').onclick = ()=> { hideAllSections(); $id('casesSection').style.display = 'block'; loadCases(); setActive('sidebarCases'); };
$id('sidebarInstructors').onclick = ()=> { hideAllSections(); $id('instructorsPanel').style.display = 'block'; loadInstructors(); setActive('sidebarInstructors'); };

function setActive(id){
  document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));
  $id(id).classList.add('active');
}
function hideAllSections(){
  ['scannerCard','logsSection','requestsSection','basketSection','casesSection','instructorsPanel'].forEach(id=> $id(id).style.display = 'none');
}

/* ========== Realtime listeners ========== */
db.ref('users').on('value', ()=> refreshLogsView());
db.ref('cases').on('value', ()=> { if($id('casesSection').style.display !== 'none') loadCases(); });
db.ref('instructors').on('value', ()=> { if($id('instructorsPanel').style.display !== 'none' || $id('instructorsModal').style.display !== 'none') loadInstructors(); });

/* ========== Initial UI state ========== */
hideAllSections(); $id('scannerCard').style.display = 'block'; setActive('sidebarScanner');

// expose some functions globally used by inline onclicks
window.startScanner = startScanner; window.stopScanner = stopScanner;
window.refreshLogsView = refreshLogsView; window.exportLogs = exportLogs; window.printLogs = printLogs;
window.loadCases = loadCases; window.exportCases = exportCases; window.printCases = printCases;
window.loadInstructors = loadInstructors; window.addInstructor = addInstructor; window.removeInstructor = removeInstructor;
window.showBasket = showBasket; window.approveReq = approveReq; window.rejectReq = rejectReq;

(function setCanvasFitOnResize(){
  window.addEventListener('resize', ()=> { try{ fitWheelCanvas(); safeDrawWheel(currentRotation||0); }catch(e){} });
  setTimeout(()=>{ try{ fitWheelCanvas(); safeDrawWheel(0); }catch(e){} }, 200);
})();
</script>
</html>
