<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Guidance — Appointment Scheduler</title>

  <!-- EmailJS SDK (global) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

    body {
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(135deg,#ffffff 0%, #ffe8f6 40%, #e3c7ff 100%);
      background-size:400% 400%;
      animation: bgShift 12s ease infinite;
      padding: 28px;
    }
    @keyframes bgShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    .wrap {
      width:100%;
      max-width:480px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
      padding: 12px;
    }

    header { display:flex; flex-direction:column; align-items:center; gap:8px; }
    header img { width:96px; height:96px; object-fit:contain; border-radius:14px; padding:8px; background:rgba(255,255,255,0.15); box-shadow:0 6px 20px rgba(0,0,0,0.08); backdrop-filter: blur(6px); }
    header h1 { margin:0; font-size:18px; color:#4a148c; }

    .card {
      width:100%;
      background: rgba(255,255,255,0.26);
      border-radius:16px;
      padding:22px;
      border:1px solid rgba(255,255,255,0.34);
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      backdrop-filter: blur(10px);
    }
    .card h2 { margin:0 0 8px 0; color:#5b0aa8; text-align:center; }

    form { display:flex; flex-direction:column; gap:10px; }
    input, select, textarea {
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:none;
      background: rgba(255,255,255,0.94);
      font-size:14px;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.04);
    }
    textarea { min-height:80px; resize:vertical; }

    .row { display:flex; gap:10px; }
    @media(min-width:540px) { .row.split { display:grid; grid-template-columns:1fr 1fr; gap:10px; } }

    .btn {
      border:none;
      padding:12px 14px;
      border-radius:999px;
      cursor:pointer;
      background: linear-gradient(180deg,#7a1fb7,#5b0aa8);
      color:white;
      font-weight:600;
      box-shadow:0 8px 18px rgba(106,27,154,0.18);
      transition: transform .16s ease;
    }
    .btn.secondary {
      background: rgba(255,255,255,0.95);
      color:#4a148c;
      box-shadow:none;
      border:1px solid rgba(74,20,140,0.06);
    }
    .btn:active { transform: translateY(1px) scale(.998); }

    .muted { color:#6a6a6a; font-size:13px; text-align:center; }

    /* Modal overlay */
    #timeModal {
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.44);
      z-index:1200;
      padding:20px;
      opacity:0;
      transition:opacity .22s ease;
    }
    #timeModal.show { display:flex; opacity:1; }

    .modalCard {
      width:100%;
      max-width:440px;
      background: rgba(255,255,255,0.22);
      border-radius:14px;
      padding:18px;
      border:1px solid rgba(255,255,255,0.36);
      backdrop-filter: blur(14px);
      box-shadow:0 14px 44px rgba(0,0,0,0.14);
      transform: translateY(8px) scale(.98);
      transition: transform .28s cubic-bezier(.2,.9,.3,1);
    }
    #timeModal.show .modalCard { transform: translateY(0) scale(1); }

    .modalHeader { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .modalHeader h3 { margin:0; color:#4a148c; font-size:16px; }

    .slots { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:8px; }
    .slotBtn {
      padding:10px 12px; border-radius:999px; border:none;
      background: linear-gradient(180deg,#7a1fb7,#5b0aa8);
      color:white; cursor:pointer; font-weight:600; font-size:13px;
      transition: transform .14s ease;
    }
    .slotBtn:hover { transform: translateY(-4px); }
    .slotBtn.booked { background:#e6e6e6; color:#7a7a7a; cursor:not-allowed; transform:none; }

    .modalFooter { margin-top:12px; display:flex; justify-content:center; gap:8px; }

    .closeX { background:none; border:none; font-size:20px; color:#4a148c; cursor:pointer; }
    .closeX:hover { color:#9c27b0; }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <header>
      <img src="https://i.imgur.com/1EOyoBG.png" alt="Guidance logo">
      <h1>Guidance Appointment Scheduling</h1>
    </header>

    <section class="card" aria-labelledby="cardTitle">
      <h2 id="cardTitle">Book an Appointment</h2>

      <form id="appointmentForm" onsubmit="event.preventDefault(); submitForm();">
        <input id="name" name="name" type="text" placeholder="Full name" required />
        <input id="email" name="email" type="email" placeholder="Email address" required />
        <input id="phone" name="phone" type="tel" placeholder="Phone (e.g. +63)" required />

        <label class="muted" style="margin-top:4px; text-align:left;">Service</label>
        <select id="service" name="service" required>
          <option value="" disabled selected>Select service</option>
          <option>Counseling</option>
          <option>Career Guidance</option>
          <option>Academic Consultation</option>
        </select>

        <div class="row split">
          <input id="date" name="date" type="date" required />
          <input id="time" name="time" type="text" placeholder="Pick time" readonly required />
        </div>

        <button type="button" id="openTimeBtn" class="btn secondary">Select Time</button>

        <textarea id="notes" name="notes" placeholder="Notes (optional)"></textarea>

        <button type="submit" class="btn">Submit Appointment</button>
      </form>

      <p class="muted">Pick a date and the time modal will open automatically. Booked slots are disabled.</p>
    </section>
  </div>

  <!-- Time modal (on top of form) -->
  <div id="timeModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modalCard" role="document" aria-labelledby="timeModalTitle">
      <div class="modalHeader">
        <h3 id="timeModalTitle">Select a Time Slot</h3>
        <button id="closeModalBtn" class="closeX" title="Close">✕</button>
      </div>

      <div class="slots" id="slotsContainer" aria-live="polite">
        <button class="slotBtn" data-time="8:00 AM - 9:00 AM">8:00 AM - 9:00 AM</button>
        <button class="slotBtn" data-time="9:00 AM - 10:00 AM">9:00 AM - 10:00 AM</button>
        <button class="slotBtn" data-time="10:00 AM - 11:00 AM">10:00 AM - 11:00 AM</button>
        <button class="slotBtn" data-time="11:00 AM - 12:00 NN">11:00 AM - 12:00 NN</button>

        <!-- lunch break -->

        <button class="slotBtn" data-time="1:00 PM - 2:00 PM">1:00 PM - 2:00 PM</button>
        <button class="slotBtn" data-time="2:00 PM - 3:00 PM">2:00 PM - 3:00 PM</button>
        <button class="slotBtn" data-time="3:00 PM - 4:00 PM">3:00 PM - 4:00 PM</button>
        <button class="slotBtn" data-time="4:00 PM - 5:00 PM">4:00 PM - 5:00 PM</button>
      </div>

      <div class="modalFooter">
        <button id="cancelModal" class="btn secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    // Firebase v11 modular imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ---------- Your Firebase config (you provided earlier) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCstDdbOAisSEZzu9FT9Zyzl_pj5-RHBnA",
      authDomain: "guidance-appointment.firebaseapp.com",
      databaseURL: "https://guidance-appointment-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "guidance-appointment",
      storageBucket: "guidance-appointment.firebasestorage.app",
      messagingSenderId: "280009961139",
      appId: "1:280009961139:web:f0863f2e5940be5e534ac6",
      measurementId: "G-2MCGGLRTML"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // EmailJS init (global 'emailjs' loaded by script tag)
    if (window.emailjs && typeof window.emailjs.init === 'function') {
      window.emailjs.init("xvStFrKI-3M-3ZCvz"); // your public key
    } else {
      console.warn("EmailJS not loaded — confirmation emails will fail.");
    }

    // DOM refs
    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const openTimeBtn = document.getElementById('openTimeBtn');
    const timeModal = document.getElementById('timeModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelModalBtn = document.getElementById('cancelModal');
    const slotButtons = Array.from(document.querySelectorAll('.slotBtn'));
    const slotsContainer = document.getElementById('slotsContainer');
    const form = document.getElementById('appointmentForm');

    // in-memory mapping: { "2025-10-09": ["8:00 AM - 9:00 AM", ...], ... }
    let bookedTimesByDate = {};

    // Utility: read appointments from Firebase and populate bookedTimesByDate
    async function loadBookingsFromFirebase() {
      bookedTimesByDate = {}; // reset
      try {
        const rootRef = ref(db, 'appointments');
        const snap = await get(rootRef);
        if (!snap.exists()) {
          return;
        }
        const data = snap.val();

        // Case A: /appointments is a push-list where each entry has {date, time, ...}
        // Case B: /appointments/{date}/{timeKey} structure
        if (typeof data === 'object') {
          // Detect Case B: top-level keys are date strings like "2025-10-09" and values are objects
          const topKeys = Object.keys(data);
          const likelyDates = topKeys.length && topKeys.every(k => /^\d{4}-\d{2}-\d{2}$/.test(k));
          if (likelyDates) {
            // iterate dates
            for (const dateKey of topKeys) {
              const inner = data[dateKey];
              if (!inner) continue;
              // inner may be object with keys = timeKey -> appointment object
              const times = [];
              if (typeof inner === 'object') {
                for (const timeKey in inner) {
                  const appt = inner[timeKey];
                  // If appt has 'time' field use it; else maybe timeKey is readable
                  if (appt && appt.time) times.push(appt.time);
                  else times.push(timeKey);
                }
              }
              bookedTimesByDate[dateKey] = Array.from(new Set(times));
            }
          } else {
            // Case A: list of appointments
            for (const id in data) {
              const appt = data[id];
              if (!appt) continue;
              const d = appt.date;
              const t = appt.time;
              if (!d || !t) continue;
              if (!bookedTimesByDate[d]) bookedTimesByDate[d] = [];
              bookedTimesByDate[d].push(t);
            }
            // dedupe arrays
            for (const d of Object.keys(bookedTimesByDate)) {
              bookedTimesByDate[d] = Array.from(new Set(bookedTimesByDate[d]));
            }
          }
        }
      } catch (err) {
        console.error("Error loading bookings:", err);
      }
    }

    // Update UI slots for a given selectedDate (disable booked ones)
    function updateSlotButtonsForDate(selectedDate) {
      // Reset all first
      slotButtons.forEach(btn => {
        btn.classList.remove('booked');
        btn.disabled = false;
        btn.removeAttribute('aria-disabled');
      });

      if (!selectedDate) return;
      const taken = bookedTimesByDate[selectedDate] || [];
      slotButtons.forEach(btn => {
        if (taken.includes(btn.dataset.time)) {
          btn.classList.add('booked');
          btn.disabled = true;
          btn.setAttribute('aria-disabled', 'true');
        }
      });
    }

    // Open modal (and ensure slots reflect latest bookings)
    async function openModalForDate(selectedDate) {
      if (!selectedDate) return;
      await loadBookingsFromFirebase();
      updateSlotButtonsForDate(selectedDate);
      timeModal.classList.add('show');
      timeModal.style.display = 'flex';
      timeModal.setAttribute('aria-hidden', 'false');
      // focus first available
      setTimeout(() => {
        const firstAvailable = slotButtons.find(b => !b.disabled);
        (firstAvailable || slotButtons[0]).focus();
      }, 120);
    }

    // Close modal
    function closeModal() {
      timeModal.classList.remove('show');
      setTimeout(() => {
        timeModal.style.display = 'none';
        timeModal.setAttribute('aria-hidden', 'true');
      }, 260);
    }

    // When user picks a date -> open the modal automatically and show disabled slots
    dateInput.addEventListener('change', async () => {
      const selectedDate = dateInput.value;
      if (!selectedDate) return;
      // If the date is fully booked (all slots taken) show alert and clear
      await loadBookingsFromFirebase();
      const taken = bookedTimesByDate[selectedDate] || [];
      const totalSlots = slotButtons.length;
      if (taken.length >= totalSlots) {
        alert("⚠️ This date is fully booked. Please select another date.");
        dateInput.value = "";
        return;
      }
      openModalForDate(selectedDate);
    });

    // open button (alternative)
    document.getElementById('openTimeBtn').addEventListener('click', () => {
      const selectedDate = dateInput.value;
      if (!selectedDate) { alert('Please select a date first.'); dateInput.focus(); return; }
      openModalForDate(selectedDate);
    });

    // close handlers
    closeModalBtn.addEventListener('click', closeModal);
    cancelModalBtn.addEventListener('click', closeModal);
    timeModal.addEventListener('click', (ev) => { if (ev.target === timeModal) closeModal(); });

    // slot click -> fill time input and close modal
    slotButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.classList.contains('booked')) return;
        timeInput.value = btn.dataset.time;
        closeModal();
      });
    });

    // form submission: validate, double-check availability, push to Firebase, send EmailJS
    async function submitForm() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const service = document.getElementById('service').value;
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const notes = document.getElementById('notes').value.trim();

      if (!name || !email || !phone || !service || !date || !time) {
        alert("Please fill in all required fields and choose a time.");
        return;
      }

      // reload bookings & re-check conflict
      await loadBookingsFromFirebase();
      const taken = bookedTimesByDate[date] || [];
      if (taken.includes(time)) {
        alert("⚠️ Sorry — that time was just booked by someone else. Please choose another slot.");
        // refresh UI: re-disable that button
        updateSlotButtonsForDate(date);
        return;
      }

      // Save as a push-list entry under /appointments (keeps compatibility)
      try {
        const rootRef = ref(db, 'appointments');
        const newRef = push(rootRef);
        await set(newRef, {
          name, email, phone, service, date, time, notes,
          status: "pending",
          timestamp: Date.now()
        });

        // send confirmation email through EmailJS
        if (window.emailjs && typeof window.emailjs.send === 'function') {
          try {
            await window.emailjs.send("service_qtacvtn", "template_ewvtufi", {
              name, email, service, date, time
            });
          } catch (emailErr) {
            console.warn("EmailJS send failed:", emailErr);
            // still proceed - user booked
          }
        }

        // success UX: simple confirm + reset (you can replace with a fancy UI)
        alert("✅ Appointment booked! A confirmation email was sent (if email service available).");
        form.reset();
      } catch (err) {
        console.error("Save failed:", err);
        alert("Error saving appointment. Please try again.");
      }
    }

    // expose submitForm to global (connected to onsubmit)
    window.submitForm = submitForm;
  </script>
</body>
  </html>
