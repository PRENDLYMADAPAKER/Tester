<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guidance Appointment Scheduling</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #6a1b9a;
      --accent-2: #9c27b0;
      --glass: rgba(255,255,255,0.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:"Poppins",sans-serif}
    body {
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      padding:28px 18px;
      background: linear-gradient(135deg, #ffffff 0%, #ffe6f9 40%, #e0c3fc 100%);
      background-size:400% 400%;
      animation:bgShift 14s ease infinite;
    }
    @keyframes bgShift {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    .page {width:100%;max-width:540px;display:flex;flex-direction:column;align-items:center;gap:18px;}

    .header {display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:10px;}
    .header img {width:150px;height:150px;object-fit:contain;display:block;}
    .title {color:var(--accent);font-size:1.9rem;font-weight:700;text-align:center;}

    .card {
      width:100%;
      max-width:460px;
      background:var(--glass);
      border-radius:20px;
      padding:24px;
      box-shadow:0 12px 40px rgba(0,0,0,0.08);
      border:1px solid rgba(255,255,255,0.5);
      backdrop-filter:blur(14px);
    }
    .card h2{color:var(--accent);text-align:center;margin-bottom:12px;font-size:1.25rem}

    label{font-weight:600;color:var(--accent);font-size:0.95rem}
    input,select,textarea {
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(138,79,255,0.16);
      background:rgba(255,255,255,0.98);
      font-size:15px;
      outline:none;
      transition:box-shadow .15s,border-color .15s;
    }
    input:focus,select:focus,textarea:focus {box-shadow:0 6px 18px rgba(106,27,154,0.08);border-color:var(--accent-2);}
    .row{display:flex;gap:12px;}
    .row>div{flex:1;}
    .btn {
      display:inline-block;width:100%;padding:12px 14px;
      border-radius:28px;border:none;
      background:linear-gradient(180deg,var(--accent-2),var(--accent));
      color:#fff;font-weight:600;cursor:pointer;
      box-shadow:0 10px 28px rgba(106,27,154,0.12);
      transition:transform .14s ease, box-shadow .14s;
    }
    .btn:active{transform:translateY(1px) scale(.995)}
    .btn.ghost{background:rgba(255,255,255,0.92);color:var(--accent);border:1px solid rgba(74,20,140,0.06)}

    .muted{color:#6b6b6b;font-size:13px;text-align:center;margin-top:8px;}

    /* Modal */
    #timeModal {
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.44);z-index:1200;padding:18px;opacity:0;
      transition:opacity .25s ease;
    }
    #timeModal.show{display:flex;opacity:1;}
    .modalCard {
      width:100%;max-width:440px;border-radius:16px;padding:20px;
      background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.05);
      backdrop-filter:blur(12px);
      box-shadow:0 14px 44px rgba(0,0,0,0.14);
      transform:translateY(8px) scale(.98);
      transition:transform .28s cubic-bezier(.2,.9,.3,1);
    }
    #timeModal.show .modalCard{transform:translateY(0) scale(1);}
    .modalHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .closeX{background:none;border:none;font-size:20px;color:var(--accent);cursor:pointer;}
    .slots{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:6px;}
    .slot {
      padding:10px 14px;border-radius:999px;border:none;cursor:pointer;
      background:linear-gradient(180deg,var(--accent-2),var(--accent));
      color:white;font-weight:600;font-size:13px;
      box-shadow:0 8px 18px rgba(106,27,154,0.12);
      transition:transform .12s ease;
    }
    .slot.booked {background:#e6e6e6;color:#777;cursor:not-allowed;box-shadow:none;}
    .slot:hover:not(.booked){transform:scale(1.05);}

    /* Toasts */
    .toastWrap {
      position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:2000;
    }
    .toast {
      min-width:220px;
      padding:12px 16px;
      border-radius:12px;
      color:white;
      font-weight:600;
      backdrop-filter:blur(14px);
      background:rgba(90,14,161,0.85);
      box-shadow:0 8px 24px rgba(0,0,0,0.15);
      opacity:0;transform:translateY(-20px);
      transition:opacity 2s ease, transform .5s ease;
    }
    .toast.show {opacity:1;transform:translateY(0);}
    .toast.success {background:rgba(46,204,113,0.85);}
    .toast.error {background:rgba(231,76,60,0.85);}

    @media(min-width:720px){.title{font-size:2.2rem}}
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <img src="https://i.imgur.com/1EOyoBG.png" alt="Guidance Logo">
      <h1 class="title">Guidance Appointment Scheduling</h1>
    </header>

    <section class="card">
      <h2>Book an Appointment</h2>
      <form id="appointmentForm" autocomplete="off">
        <label>Full Name</label>
        <input id="name" type="text" required placeholder="Your full name"/>

        <label>Email</label>
        <input id="email" type="email" required placeholder="you@example.com"/>

        <label>Phone</label>
        <input id="phone" type="tel" required placeholder="+63xxxxxxxxxx"/>

        <label>Service</label>
        <select id="service" required>
          <option value="">Select service</option>
          <option>Counseling</option>
          <option>Career Guidance</option>
          <option>Academic Consultation</option>
          <option>Others</option>
        </select>

        <div id="otherServiceWrap" style="display:none">
          <label>Please specify</label>
          <input id="otherService" type="text" placeholder="Specify service"/>
        </div>

        <div class="row">
          <div>
            <label>Date</label>
            <input id="date" type="date" required/>
          </div>
          <div>
            <label>Time</label>
            <input id="time" type="text" readonly placeholder="Pick time" required/>
          </div>
        </div>
        <button id="openTimeBtn" type="button" class="btn ghost">Select Time</button>

        <label>Notes (optional)</label>
        <textarea id="notes" rows="3" placeholder="Additional notes..."></textarea>

        <button type="submit" class="btn">Submit Appointment</button>
        <p class="muted">Booked dates and times will be disabled automatically.</p>
      </form>
    </section>
  </div>

  <div id="timeModal">
    <div class="modalCard">
      <div class="modalHeader">
        <h3>Select a Time Slot</h3>
        <button id="closeModalBtn" class="closeX">✕</button>
      </div>
      <div class="slots" id="slotsContainer"></div>
      <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
        <button id="cancelModalBtn" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>

  <div class="toastWrap" id="toastWrap"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCstDdbOAisSEZzu9FT9Zyzl_pj5-RHBnA",
      authDomain: "guidance-appointment.firebaseapp.com",
      databaseURL: "https://guidance-appointment-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "guidance-appointment",
      storageBucket: "guidance-appointment.firebasestorage.app",
      messagingSenderId: "280009961139",
      appId: "1:280009961139:web:f0863f2e5940be5e534ac6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    if (window.emailjs && typeof window.emailjs.init === "function") {
      window.emailjs.init("xvStFrKI-3M-3ZCvz");
    }

    const TIME_SLOTS = [
      "8:00 AM - 9:00 AM","9:00 AM - 10:00 AM","10:00 AM - 11:00 AM","11:00 AM - 12:00 NN",
      "1:00 PM - 2:00 PM","2:00 PM - 3:00 PM","3:00 PM - 4:00 PM","4:00 PM - 5:00 PM"
    ];

    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const slotsContainer = document.getElementById('slotsContainer');
    const timeModal = document.getElementById('timeModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const openTimeBtn = document.getElementById('openTimeBtn');
    const form = document.getElementById('appointmentForm');
    const serviceSelect = document.getElementById('service');
    const otherServiceWrap = document.getElementById('otherServiceWrap');
    const toastWrap = document.getElementById('toastWrap');

    dateInput.min = new Date().toISOString().split('T')[0];

    function slotKey(slot){return slot.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase();}

    async function fetchBooked(date){
      if(!date) return [];
      try{
        const snap = await get(ref(db,'appointments/'+date));
        if(!snap.exists()) return [];
        return Object.values(snap.val()).map(v=>v.time);
      }catch{ return []; }
    }

    function populateSlots(booked){
      slotsContainer.innerHTML='';
      TIME_SLOTS.forEach(slot=>{
        const btn=document.createElement('button');
        btn.className='slot'; btn.textContent=slot;
        if(booked.includes(slot)){btn.classList.add('booked');btn.disabled=true;}
        else btn.onclick=()=>{timeInput.value=slot;closeModal();};
        slotsContainer.appendChild(btn);
      });
    }

    function openModal(){timeModal.classList.add('show');}
    function closeModal(){timeModal.classList.remove('show');setTimeout(()=>timeModal.style.display='none',250);}

    dateInput.addEventListener('change',async()=>{
      const d=dateInput.value;if(!d)return;
      const booked=await fetchBooked(d);
      populateSlots(booked);openModal();
    });

    openTimeBtn.onclick=async()=>{
      const d=dateInput.value;if(!d)return showToast("Please pick a date first","error");
      const booked=await fetchBooked(d);
      populateSlots(booked);openModal();
    };
    closeModalBtn.onclick=closeModal;cancelModalBtn.onclick=closeModal;
    timeModal.onclick=e=>{if(e.target===timeModal)closeModal();};

    serviceSelect.onchange=()=>{
      otherServiceWrap.style.display=serviceSelect.value==="Others"?"block":"none";
    };

    form.onsubmit=async e=>{
      e.preventDefault();
      const name=name.value.trim(),email=email.value.trim(),phone=phone.value.trim();
      let service=serviceSelect.value;
      if(service==="Others") service=document.getElementById('otherService').value.trim();
      const date=dateInput.value,time=timeInput.value,notes=notes.value.trim();

      if(!name||!email||!phone||!service||!date||!time)
        return showToast("Please complete all fields","error");

      const booked=await fetchBooked(date);
      if(booked.includes(time)) return showToast("Slot already booked","error");

      await set(ref(db,`appointments/${date}/${slotKey(time)}`),{name,email,phone,service,date,time,notes,timestamp:Date.now()});
      await push(ref(db,'appointments_list'),{name,email,phone,service,date,time,notes,timestamp:Date.now()});

      try{await emailjs.send('service_qtacvtn','template_ewvtufi',{name,service,date,time,email});}catch{}

      showToast("✅ Appointment scheduled successfully!","success");
      form.reset();timeInput.value='';
    };

    function showToast(msg,type='info'){
      const node=document.createElement('div');
      node.className='toast';if(type==='success')node.classList.add('success');if(type==='error')node.classList.add('error');
      node.textContent=msg;toastWrap.appendChild(node);
      requestAnimationFrame(()=>node.classList.add('show'));
      setTimeout(()=>{node.classList.remove('show');setTimeout(()=>node.remove(),2000);},3000);
    }
  </script>
</body>
  </html>
