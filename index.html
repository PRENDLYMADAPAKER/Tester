<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel - Clinician DTR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
  body {
    font-family: Inter, system-ui, Arial, sans-serif;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    display: flex;
    justify-content: center;
    padding: 28px;
    min-height: 100vh;
  }

  .card {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 20px;
    border-radius: 16px;
    max-width: 960px;
    width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }

  h1, h2, h3 {
    color: #2c0a34;
    margin-top: 0;
  }

  button {
    padding: 6px 12px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s ease;
  }
  button:hover {
    opacity: 0.9;
    transform: scale(1.03);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    font-size: 14px;
    color: #2c0a34;
  }

  .muted { font-size: 13px; opacity: 0.8; }
  .error { color: #b91c1c; }
  .success { color: #166534; }
  .row { display: flex; gap: 8px; }

  label select {
    margin-left: 6px;
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    background: rgba(255, 255, 255, 0.4);
  }
  </style>
</head>
<body>
  <div class="card">
    <h1>Admin Panel - Clinician DTR</h1>

    <section id="scannerSection">
      <h2>QR Scanner</h2>
      <video id="preview" style="width:100%;border-radius:8px;background:#000"></video>
      <p id="scanStatus" class="muted"></p>
    </section>

    <section id="logsSection" style="margin-top:20px">
      <h2>Attendance Logs</h2>
      <table>
        <thead><tr><th>User</th><th>Date</th><th>Time In</th></tr></thead>
        <tbody id="logsBody"><tr><td colspan="3" class="muted">No logs yet</td></tr></tbody>
      </table>
    </section>

    <section id="requestsSection" style="margin-top:20px">
      <h2>Update Requests</h2>
      <label class="muted">Filter: 
        <select id="filterSelect">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </label>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Requested Value</th><th>Current Value</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="requestsBody"><tr><td colspan="6" class="muted">No requests yet</td></tr></tbody>
      </table>
    </section>
  </div>
  <!-- libs -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
      authDomain: "dtr-project-66048.firebaseapp.com",
      databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dtr-project-66048",
      storageBucket: "dtr-project-66048.appspot.com",
      messagingSenderId: "271445506225",
      appId: "1:271445506225:web:fcb04d0454e1302de14a90",
      measurementId: "G-R22CLKSPCP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // small helper to safely play audio
    function playSound(id) {
      try {
        const a = document.getElementById(id);
        if (!a) return;
        // attempt play; ignore promise rejection
        a.play().then(() => {
          // optional: reset to start after short time so it's ready again
          setTimeout(() => { a.currentTime = 0; a.pause(); }, 600);
        }).catch(()=>{ /* autoplay blocked or not allowed — ignore */ });
      } catch(e){ console.warn('playSound error', e); }
    }

    // === Scanner ===
    const codeReader = new ZXing.BrowserQRCodeReader();
    const preview = document.getElementById('preview');
    const scanStatus = document.getElementById('scanStatus');

    async function startScanner() {
      try {
        // prime the audio (attempt to unlock on first user interaction)
        // This will often succeed because starting the camera is a user action.
        const audioEl = document.getElementById('success-sound');
        if (audioEl) {
          // try to play/pause quickly to "unlock" the audio for future play()
          audioEl.play().then(()=>{ audioEl.pause(); audioEl.currentTime = 0; }).catch(()=>{/* ignore */});
        }

        const devices = await codeReader.listVideoInputDevices();
        if (devices.length > 0) {
          // prefer back camera if possible
          const back = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
          codeReader.decodeFromVideoDevice(back.deviceId, preview, (result, err) => {
            if (result && result.getText) handleScan(result.getText());
          });
          scanStatus.textContent = 'Scanner started. Point camera to a QR code.';
          scanStatus.className = 'muted';
        } else {
          scanStatus.textContent = 'No camera devices found.';
          scanStatus.className = 'error';
        }
      } catch (err) {
        scanStatus.textContent = "Camera error: " + (err.message || err);
        scanStatus.className = "error";
        console.error(err);
      }
    }

    async function stopScanner() {
      try { codeReader.reset(); } catch(e){/*ignore*/ }
      preview.srcObject = null;
      scanStatus.textContent = 'Scanner stopped.';
      scanStatus.className = 'muted';
    }

    async function handleScan(uid) {
      if (!uid) return;
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const timeStr = now.toTimeString().split(' ')[0];

      try {
        // write per-user DTR
        await db.ref('users/' + uid + '/dtr/' + dateStr).set({ timeIn: timeStr, ts: Date.now() });

        // write global timeIns list for logs (optional, consistent with user panel)
        await db.ref('timeIns/' + dateStr + '/' + uid).set({
          uid,
          date: dateStr,
          time: timeStr,
          ts: Date.now()
        });

        scanStatus.textContent = "Recorded for UID " + uid + " at " + timeStr;
        scanStatus.className = "success";

        // play success sound
        playSound('success-sound');
      } catch (err) {
        console.error('Error saving DTR:', err);
        scanStatus.textContent = 'Error saving time-in: ' + (err.message || err);
        scanStatus.className = 'error';
      }
    }

    // start scanner automatically (you can change to manual control)
    startScanner();

    // === Attendance Logs ===
    const logsBody = document.getElementById('logsBody');
    db.ref('timeIns').on('value', snap => {
      // render today's logs (flatten last 2 levels)
      const today = new Date().toISOString().split('T')[0];
      const todaySnap = snap.child(today);
      logsBody.innerHTML = '';
      if (!todaySnap.exists()) {
        logsBody.innerHTML = '<tr><td colspan="3" class="muted">No logs yet</td></tr>';
        return;
      }
      const entries = Object.values(todaySnap.val() || {});
      entries.sort((a,b)=> (b.ts||0)-(a.ts||0));
      for (const e of entries) {
        const name = e.name || (e.uid || '');
        const date = e.date || today;
        const time = e.time || '';
        logsBody.innerHTML += `<tr><td>${escapeHtml(name)}</td><td>${escapeHtml(date)}</td><td>${escapeHtml(time)}</td></tr>`;
      }
    });

    // escapeHtml helper (copied from earlier user admin)
    function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // === Update Requests with Filter ===
    const requestsBody = document.getElementById('requestsBody');
    const filterSelect = document.getElementById('filterSelect');

    function renderRequests(snapshot, filter) {
      requestsBody.innerHTML = '';
      if (!snapshot.exists()) {
        requestsBody.innerHTML = '<tr><td colspan="6" class="muted">No requests yet</td></tr>';
        return;
      }

      let hasData = false;

      snapshot.forEach(userSnap => {
        const uid = userSnap.key;
        userSnap.forEach(reqSnap => {
          const req = reqSnap.val();
          const reqId = reqSnap.key;

          if (filter !== "all" && req.status !== filter) return;

          hasData = true;

          db.ref('users/' + uid + '/profile').once('value').then(profileSnap => {
            const profile = profileSnap.val() || {};
            // map field names from client side to profile keys if necessary
            let currentVal = '';
            if (req.field === 'clinicalLevel') currentVal = profile.clinicalLevel || '';
            else if (req.field === 'name') currentVal = profile.name || '';
            else if (req.field === 'email') currentVal = profile.email || '';
            else if (req.field === 'password') currentVal = '••••••'; // don't show real password
            else currentVal = profile[req.field] || '';

            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${escapeHtml(profile.name || uid)}</td>
              <td>${escapeHtml(req.field)}</td>
              <td>${escapeHtml(req.value)}</td>
              <td>${escapeHtml(currentVal)}</td>
              <td>${escapeHtml(req.status)}</td>
              <td>
                <button onclick="approveReq('${uid}','${reqId}','${req.field}','${encodeURIComponent(String(req.value||''))}')">Approve</button>
                <button onclick="rejectReq('${uid}','${reqId}')">Reject</button>
              </td>
            `;
            requestsBody.appendChild(row);
          });
        });
      });

      if (!hasData) {
        requestsBody.innerHTML = '<tr><td colspan="6" class="muted">No matching requests</td></tr>';
      }
    }

    db.ref('updateRequests').on('value', snap => {
      renderRequests(snap, filterSelect.value);
    });

    filterSelect.onchange = () => {
      db.ref('updateRequests').once('value').then(snap => {
        renderRequests(snap, filterSelect.value);
      });
    };

    // Approve / Reject functions
    async function approveReq(uid, reqId, field, encodedValue) {
      try {
        const value = decodeURIComponent(encodedValue);
        // If password change requested: update only in auth system (not done here). For now, we store placeholder or notify admin to ask user to reset.
        if (field === 'password') {
          // store notification or set a flag; DO NOT store plain passwords in profile.
          await db.ref('updateRequests/' + uid + '/' + reqId + '/status').set('approved');
          // Optionally set a flag to force password reset flow, or inform admin to update Auth console.
        } else {
          // map field names to profile keys for consistency
          const key = field === 'clinicalLevel' ? 'clinicalLevel' : field;
          await db.ref('users/' + uid + '/profile/' + key).set(value);
          await db.ref('updateRequests/' + uid + '/' + reqId + '/status').set('approved');
        }
        // play approve sound (using same file)
        playSound('success-sound');
      } catch (e) {
        console.error('approveReq error', e);
        alert('Failed to approve request: ' + (e.message || e));
      }
    }
    async function rejectReq(uid, reqId) {
      try {
        await db.ref('updateRequests/' + uid + '/' + reqId + '/status').set('rejected');
      } catch (e) {
        console.error('rejectReq error', e);
        alert('Failed to reject request: ' + (e.message || e));
      }
    }

    // expose for console debug
    window._admin = { startScanner, stopScanner: ()=>{ try{ codeReader.reset(); }catch(e){} }, approveReq, rejectReq };

  </script>

  <!-- success sound file (place Thank you.mp3 beside this HTML) -->
  <audio id="success-sound" src="Thank you.mp3" preload="auto"></audio>
</body>
</html>
